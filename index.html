<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Navegação Estilo Google Maps</title>

<style>
    #map {
        width: 100%;
        height: 100%;
        position: absolute;
        top: 0;
        left: 0;
    }

    /* Marcador HTML */
    .marker-wrapper {
        width: 40px;
        height: 40px;
        position: relative;
    }

    .location-dot {
        width: 22px;
        height: 22px;
        background: #1a73e8;
        border-radius: 50%;
        border: 4px solid white;
        position: absolute;
        top: 10px;
        left: 10px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.4);
    }

    .direction-arrow {
        width: 0;
        height: 0;
        border-left: 8px solid transparent;
        border-right: 8px solid transparent;
        border-bottom: 18px solid white;
        position: absolute;
        top: -4px;
        left: 50%;
        transform: translateX(-50%);
        filter: drop-shadow(0 0 4px rgba(0,0,0,0.4));
    }
</style>
</head>
<body>

<div id="map"></div>

<!-- Google Maps -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyApaDb9rSw2sNTaY7fjBqmrgjWYD9xwjcU&callback=initMap&v=beta" async defer></script>

<script>
let map;
let userMarker;
let watchId;
let currentHeading = 0; // heading real
let canUseGyro = false;

/* ================================
   PERMISSÃO DO GIROSCÓPIO (Android)
================================ */
function enableGyroscope() {
    if (typeof DeviceOrientationEvent !== "undefined" &&
        typeof DeviceOrientationEvent.requestPermission === "function") {

        DeviceOrientationEvent.requestPermission()
            .then(response => {
                if (response === "granted") {
                    canUseGyro = true;
                    window.addEventListener("deviceorientation", handleOrientation);
                    console.log("Giroscópio ativado!");
                } else {
                    console.log("Usuário negou o giroscópio");
                }
            })
            .catch(console.error);
    } else {
        // Chrome Desktop ou navegador sem permissão especial
        canUseGyro = true;
        window.addEventListener("deviceorientation", handleOrientation);
    }
}

/* =============== HÁNDLING DO GIROSCÓPIO ================== */
function handleOrientation(event) {
    if (!canUseGyro) return;

    // event.alpha = rotação do celular em graus (0–360)
    if (event.alpha != null) {
        currentHeading = event.alpha; // mais preciso que GPS
        rotateMarker(currentHeading);
        map.setHeading(currentHeading);
    }
}

/* ================================
   CRIA MARCADOR HTML
================================ */
function createHtmlMarker() {
    const div = document.createElement("div");
    div.className = "marker-wrapper";

    const dot = document.createElement("div");
    dot.className = "location-dot";

    const arrow = document.createElement("div");
    arrow.className = "direction-arrow";

    div.appendChild(dot);
    div.appendChild(arrow);

    return div;
}

/* ================================
   ROTACIONAR SETA
================================ */
function rotateMarker(deg) {
    if (!userMarker) return;

    const markerDiv = userMarker.getIcon().element;
    if (!markerDiv) return;

    const arrow = markerDiv.querySelector(".direction-arrow");
    if (arrow) {
        arrow.style.transform = `translateX(-50%) rotate(${deg}deg)`;
    }
}

/* ================================
   INICIAR MAPA
================================ */
function initMap() {
    map = new google.maps.Map(document.getElementById("map"), {
        center: {lat: -23.55, lng: -46.63},
        zoom: 18,
        tilt: 60,
        heading: 0,
        mapId: "ebb7ca4503045feabc75b373",
        gestureHandling: "greedy"
    });

    enableGyroscope();
    startGPS();
}

/* ================================
   INICIAR GPS
================================ */
function startGPS() {
    if (!navigator.geolocation) {
        console.log("Geolocalização não suportada.");
        return;
    }

    navigator.geolocation.getCurrentPosition(pos => {
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;

        const htmlMarker = createHtmlMarker();

        userMarker = new google.maps.marker.AdvancedMarkerElement({
            map,
            position: {lat, lng},
            content: htmlMarker
        });

        map.setCenter({lat, lng});

        watchId = navigator.geolocation.watchPosition(updatePosition, err => {
            console.log("Erro no GPS:", err);
        }, { enableHighAccuracy: true });

    }, err => {
        console.log("Erro ao iniciar GPS:", err);
    });
}

/* ================================
   ATUALIZA POSIÇÃO SUAVEMENTE
================================ */
function updatePosition(pos) {

    const lat = pos.coords.latitude;
    const lng = pos.coords.longitude;

    const newPos = { lat, lng };

    // Atualiza o mapa e marcador
    userMarker.position = newPos;
    map.panTo(newPos);

    // Usa heading do GPS APENAS se giroscópio estiver indisponível
    if (!canUseGyro && pos.coords.heading != null) {
        currentHeading = pos.coords.heading;
        rotateMarker(currentHeading);
        map.setHeading(currentHeading);
    }
}
</script>

</body>
</html>