<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Navegação Estilo Google Maps</title>

<style>
    #map{ position:absolute; top:0; left:0; width:100%; height:100%; }

    .location-dot{
        width:22px; height:22px;
        background:#1a73e8;
        border-radius:50%;
        border:4px solid white;
        box-shadow:0 2px 6px rgba(0,0,0,0.4);
        position:relative;
    }

    .direction-arrow{
        width:0;height:0;
        border-left:6px solid transparent;
        border-right:6px solid transparent;
        border-bottom:14px solid white;
        position:absolute;
        top:-12px;left:50%;
        transform:translateX(-50%);
        filter:drop-shadow(0 0 4px rgba(0,0,0,0.4));
    }
</style>
</head>
<body>

<div id="map"></div>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyApaDb9rSw2sNTaY7fjBqmrgjWYD9xwjcU&callback=initMap&v=beta&libraries=marker" async defer></script>

<script>
let map, userMarker, watchId;
let kalman = new KalmanFilter();
let lastHeading = 0;

/* ===================== Kalman ===================== */
function KalmanFilter(R=0.0008, Q=0.00001){
    this.R=R; this.Q=Q; this.A=1; this.C=1; this.cov=NaN; this.x=NaN;

    this.filter=z=>{
        if(isNaN(this.x)){ this.x=z; this.cov=1; }
        else{
            const px=this.A*this.x;
            const pc=this.A*this.cov*this.A + this.Q;
            const K=pc*this.C / (this.C*pc*this.C+this.R);
            this.x=px+K*(z-this.C*px);
            this.cov=pc-K*this.C*pc;
        }
        return this.x;
    };

    this.filter2D=(lat,lng)=>({ lat:this.filter(lat), lng:this.filter(lng) });
}

/* GET */
function getPos(m){
    if(m.position) return new google.maps.LatLng(m.position.lat, m.position.lng);
    if(m.getPosition) return m.getPosition();
    return null;
}

/* SET */
function setPos(m,pos){
    if(m.position !== undefined){
        m.position = {lat:pos.lat(), lng:pos.lng()};
        return;
    }
    if(m.setPosition) m.setPosition(pos);
}

/* INTERPOLAÇÃO SUAVE */
function lerp(a,b,t){ return a+(b-a)*t; }

function animateTo(marker,newPos,dur=450){
    const start=getPos(marker);
    if(!start){ setPos(marker,newPos); return; }

    const sLat=start.lat(), sLng=start.lng();
    const eLat=newPos.lat(), eLng=newPos.lng();
    const t0=performance.now();

    function step(now){
        const t=Math.min((now-t0)/dur,1);
        const lat=lerp(sLat,eLat,t);
        const lng=lerp(sLng,eLng,t);
        setPos(marker,new google.maps.LatLng(lat,lng));
        if(t<1) requestAnimationFrame(step);
    }
    requestAnimationFrame(step);
}

/* MARCADOR HTML */
function markerContent(){
    const wrap=document.createElement("div");
    const dot=document.createElement("div");
    dot.className="location-dot";
    const arrow=document.createElement("div");
    arrow.className="direction-arrow";
    wrap.appendChild(dot);
    wrap.appendChild(arrow);
    return wrap;
}

/* CRIA MARCADOR */
function createMarker(pos){
    try{
        if(google.maps.marker?.AdvancedMarkerElement){
            return new google.maps.marker.AdvancedMarkerElement({
                map, position:pos, content:markerContent()
            });
        }
    }catch(e){}
    return new google.maps.Marker({
        map, position:pos,
        icon:{
            path:google.maps.SymbolPath.CIRCLE,
            scale:10,
            fillColor:"#1a73e8",
            fillOpacity:1,
            strokeColor:"white",
            strokeWeight:3
        }
    });
}

/* ===================== MAPA ===================== */
function initMap(){
    map = new google.maps.Map(document.getElementById("map"),{
        center:{lat:-23.55,lng:-46.63},
        zoom:18, tilt:0, heading:0, gestureHandling:"greedy",
        mapId:"ebb7ca4503045feabc75b373"
    });

    startGPS();
}

/* ===================== GPS ===================== */
function startGPS(){
    navigator.geolocation.getCurrentPosition(pos=>{
        const p=new google.maps.LatLng(pos.coords.latitude,pos.coords.longitude);
        map.setCenter(p);
        userMarker=createMarker(p);

        watchId=navigator.geolocation.watchPosition(updateGPS, err=>{
            console.log("GPS erro:",err);
        },{enableHighAccuracy:true});

    }, err=>console.log("Erro inicial:",err));
}

/* ===================== ATUALIZAÇÃO GPS ===================== */
function updateGPS(pos){
    const f=kalman.filter2D(pos.coords.latitude,pos.coords.longitude);
    const newPos=new google.maps.LatLng(f.lat,f.lng);

    animateTo(userMarker,newPos,450);
    map.panTo(newPos);

    /* Heading */
    if(pos.coords.heading!=null){
        lastHeading=pos.coords.heading;

        /* seta corrigida (heading correto) */
        if(userMarker.content){
            const arrow=userMarker.content.querySelector(".direction-arrow");
            arrow.style.transform=
                `translateX(-50%) rotate(${lastHeading}deg)`;
        }

        map.setHeading(lastHeading);
    }
}
</script>

</body>
</html>