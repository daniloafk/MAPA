<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Sistema completo de gestão de clientes com mapa interativo">
    <meta name="theme-color" content="#4285f4">
    <title>Sistema de Gestão de Clientes - Mapa Interativo</title>

    <!-- Preconnect -->
    <link rel="preconnect" href="https://maps.googleapis.com">
    <link rel="preconnect" href="https://fufteldeapyvluynppuv.supabase.co">
    <link rel="preconnect" href="https://cdn.jsdelivr.net">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* ========================================
           VARIÁVEIS CSS
        ======================================== */
        :root {
            --primary-color: #4285f4;
            --primary-dark: #1a73e8;
            --success-color: #34a853;
            --danger-color: #ea4335;
            --warning-color: #fbbc04;
            --white: #ffffff;
            --black: #000000;
            --gray-50: #f8f9fa;
            --gray-100: #f1f3f4;
            --gray-200: #e8eaed;
            --gray-300: #dadce0;
            --gray-400: #bdc1c6;
            --gray-500: #9aa0a6;
            --gray-600: #80868b;
            --gray-700: #5f6368;
            --gray-800: #3c4043;
            --gray-900: #202124;
            --shadow-sm: 0 1px 2px 0 rgba(60,64,67,.3), 0 1px 3px 1px rgba(60,64,67,.15);
            --shadow-md: 0 1px 3px 0 rgba(60,64,67,.3), 0 4px 8px 3px rgba(60,64,67,.15);
            --shadow-lg: 0 8px 12px rgba(0,0,0,0.15);
            --transition: 200ms cubic-bezier(0.4, 0.0, 0.2, 1);
            --sidebar-width: 380px;
            --header-height: 60px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body, html {
            height: 100%;
            width: 100%;
            overflow: hidden;
            font-family: 'Google Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* ========================================
           LAYOUT PRINCIPAL
        ======================================== */
        .app-container {
            display: flex;
            height: 100vh;
            width: 100vw;
            position: relative;
        }

        /* ========================================
           SIDEBAR - INICIA FECHADA
        ======================================== */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: var(--sidebar-width);
            height: 100vh;
            background: var(--white);
            box-shadow: var(--shadow-md);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            transition: transform var(--transition);
            transform: translateX(-100%);
        }

        .sidebar.open {
            transform: translateX(0);
        }

        .sidebar-header {
            height: var(--header-height);
            background: var(--primary-color);
            color: var(--white);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            box-shadow: var(--shadow-sm);
        }

        .sidebar-header h1 {
            font-size: 18px;
            font-weight: 500;
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        /* ========================================
           BUSCA DE ENDEREÇO
        ======================================== */
        .search-box {
            position: relative;
            margin-bottom: 20px;
        }

        .search-input {
            width: 100%;
            padding: 12px 40px 12px 16px;
            border: 2px solid var(--gray-300);
            border-radius: 24px;
            font-size: 16px;
            transition: all var(--transition);
            outline: none;
        }

        .search-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.1);
        }

        .search-icon {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-500);
        }

        /* ========================================
           BOTÃO ADICIONAR CLIENTE
        ======================================== */
        .btn-add-client {
            width: 100%;
            padding: 14px;
            background: var(--primary-color);
            color: var(--white);
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all var(--transition);
            margin-bottom: 20px;
        }

        .btn-add-client:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .btn-add-client:active {
            transform: translateY(0);
        }

        /* ========================================
           LISTA DE CLIENTES
        ======================================== */
        .clients-section {
            margin-top: 20px;
        }

        .section-title {
            font-size: 14px;
            font-weight: 500;
            color: var(--gray-700);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .client-count {
            background: var(--gray-200);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
        }

        .clients-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .client-item {
            background: var(--gray-50);
            border-radius: 8px;
            padding: 12px;
            cursor: pointer;
            transition: all var(--transition);
            border: 2px solid transparent;
        }

        .client-item:hover {
            background: var(--gray-100);
            transform: translateX(4px);
        }

        .client-item.active {
            border-color: var(--primary-color);
            background: rgba(66, 133, 244, 0.05);
        }

        .client-item-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }

        .client-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            flex-shrink: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .client-info {
            flex: 1;
            min-width: 0;
        }

        .client-name {
            font-weight: 500;
            font-size: 14px;
            color: var(--gray-900);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .client-phone {
            font-size: 12px;
            color: var(--gray-600);
        }

        .client-actions {
            display: flex;
            gap: 4px;
            opacity: 0;
            transition: opacity var(--transition);
        }

        .client-item:hover .client-actions {
            opacity: 1;
        }

        .btn-icon {
            width: 28px;
            height: 28px;
            border: none;
            background: transparent;
            color: var(--gray-600);
            cursor: pointer;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition);
        }

        .btn-icon:hover {
            background: var(--gray-200);
            color: var(--gray-900);
        }

        .btn-icon.delete:hover {
            background: rgba(234, 67, 53, 0.1);
            color: var(--danger-color);
        }

        .client-address {
            font-size: 12px;
            color: var(--gray-600);
            margin-top: 4px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* ========================================
           MODAL
        ======================================== */
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            padding: 20px;
            animation: fadeIn 0.2s ease;
        }

        .modal.active {
            display: flex;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: var(--white);
            border-radius: 12px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 500;
            color: var(--gray-900);
        }

        .btn-close {
            width: 32px;
            height: 32px;
            border: none;
            background: transparent;
            color: var(--gray-600);
            cursor: pointer;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition);
        }

        .btn-close:hover {
            background: var(--gray-200);
            color: var(--gray-900);
        }

        .modal-body {
            padding: 20px;
        }

        /* ========================================
           FORMULÁRIO
        ======================================== */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: var(--gray-700);
            margin-bottom: 8px;
        }

        .form-label.required::after {
            content: '*';
            color: var(--danger-color);
            margin-left: 4px;
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--gray-300);
            border-radius: 8px;
            font-size: 16px;
            font-family: inherit;
            transition: all var(--transition);
            outline: none;
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .modal-footer {
            padding: 20px;
            border-top: 1px solid var(--gray-200);
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .btn {
            padding: 10px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition);
        }

        .btn-primary {
            background: var(--primary-color);
            color: var(--white);
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: var(--gray-200);
            color: var(--gray-700);
        }

        .btn-secondary:hover {
            background: var(--gray-300);
        }

        .btn-danger {
            background: var(--danger-color);
            color: var(--white);
        }

        .btn-danger:hover {
            background: #d33828;
        }

        /* ========================================
           MAPA
        ======================================== */
        #map {
            flex: 1;
            height: 100%;
            width: 100%;
        }

        /* ========================================
           CONTROLES DO MAPA
        ======================================== */
        .map-controls {
            position: fixed;
            top: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 999;
        }

        .map-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: none;
            background: var(--white);
            box-shadow: var(--shadow-md);
            font-size: 20px;
            cursor: pointer;
            transition: all var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--gray-700);
        }

        .map-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
            color: var(--primary-color);
        }

        .map-btn:active {
            transform: scale(0.95);
        }

        .toggle-sidebar-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 999;
        }

        /* ========================================
           MARCADORES CUSTOMIZADOS
        ======================================== */
        .location-marker {
            width: 20px;
            height: 20px;
            background: var(--primary-color);
            border: 3px solid var(--white);
            border-radius: 50%;
            box-shadow: var(--shadow-sm);
            position: relative;
            animation: pulse 2s infinite;
        }

        .location-marker::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 8px;
            height: 8px;
            background: var(--white);
            border-radius: 50%;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(66, 133, 244, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(66, 133, 244, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(66, 133, 244, 0);
            }
        }

        .client-marker {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            box-shadow: var(--shadow-md);
            cursor: pointer;
            transition: all var(--transition);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .client-marker:hover {
            transform: scale(1.1);
        }

        /* ========================================
           LOADER
        ======================================== */
        .loader {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10001;
            background: var(--white);
            padding: 20px;
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            display: none;
            align-items: center;
            gap: 12px;
        }

        .loader.active {
            display: flex;
        }

        .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid var(--gray-200);
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ========================================
           TOAST NOTIFICATION
        ======================================== */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--white);
            padding: 16px 20px;
            border-radius: 8px;
            box-shadow: var(--shadow-lg);
            display: none;
            align-items: center;
            gap: 12px;
            z-index: 10002;
            min-width: 300px;
            animation: slideInRight 0.3s ease;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .toast.active {
            display: flex;
        }

        .toast-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .toast.success .toast-icon {
            background: var(--success-color);
            color: var(--white);
        }

        .toast.error .toast-icon {
            background: var(--danger-color);
            color: var(--white);
        }

        .toast-message {
            flex: 1;
            font-size: 14px;
            color: var(--gray-900);
        }

        /* ========================================
           EMPTY STATE
        ======================================== */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--gray-500);
        }

        .empty-state i {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-state p {
            font-size: 14px;
        }

        /* ========================================
           MODAL DE CONFIRMAÇÃO
        ======================================== */
        .confirm-modal .modal-content {
            max-width: 400px;
        }

        .confirm-modal .modal-body {
            text-align: center;
            padding: 30px 20px;
        }

        .confirm-icon {
            width: 60px;
            height: 60px;
            margin: 0 auto 20px;
            border-radius: 50%;
            background: rgba(234, 67, 53, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--danger-color);
            font-size: 24px;
        }

        .confirm-message {
            font-size: 16px;
            color: var(--gray-900);
            margin-bottom: 10px;
        }

        .confirm-submessage {
            font-size: 14px;
            color: var(--gray-600);
        }

        /* ========================================
           RESPONSIVIDADE MOBILE
        ======================================== */
        @media (max-width: 768px) {
            :root {
                --sidebar-width: 100vw;
            }

            .map-controls {
                top: auto;
                bottom: 20px;
                right: 20px;
            }

            .toggle-sidebar-btn {
                top: auto;
                bottom: 90px;
                left: 20px;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .modal-content {
                max-height: 80vh;
            }
        }

        /* ========================================
           ACESSIBILIDADE
        ======================================== */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }
    </style>
</head>
<body>

    <div class="app-container">
        <!-- Sidebar - INICIA FECHADA -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h1><i class="fas fa-map-marked-alt"></i> Meus Clientes</h1>
                <button class="btn-close" id="closeSidebar" aria-label="Fechar menu">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="sidebar-content">
                <!-- Busca de Endereço -->
                <div class="search-box">
                    <input
                        type="text"
                        class="search-input"
                        id="searchAddress"
                        placeholder="Buscar endereço..."
                        autocomplete="off">
                    <i class="fas fa-search search-icon"></i>
                </div>

                <!-- Botão Adicionar Cliente -->
                <button class="btn-add-client" id="btnAddClient">
                    <i class="fas fa-plus"></i>
                    Adicionar Cliente
                </button>

                <!-- Lista de Clientes -->
                <div class="clients-section">
                    <div class="section-title">
                        <span>Clientes Cadastrados</span>
                        <span class="client-count" id="clientCount">0</span>
                    </div>
                    <div class="clients-list" id="clientsList">
                        <!-- Clientes serão inseridos aqui via JavaScript -->
                    </div>
                </div>
            </div>
        </aside>

        <!-- Mapa -->
        <main id="map"></main>

        <!-- Botão Toggle Sidebar -->
        <button class="map-btn toggle-sidebar-btn" id="toggleSidebar" aria-label="Abrir menu de clientes">
            <i class="fas fa-bars"></i>
        </button>

        <!-- Controles do Mapa -->
        <div class="map-controls">
            <button class="map-btn" id="btnMyLocation" title="Ir para minha localização">
                <i class="fas fa-location-arrow"></i>
            </button>
            <button class="map-btn" id="btnToggle3D" title="Alternar 3D">
                <span style="font-size: 16px; font-weight: 600;">3D</span>
            </button>
        </div>
    </div>

    <!-- Modal Adicionar/Editar Cliente -->
    <div class="modal" id="clientModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Adicionar Cliente</h2>
                <button class="btn-close" id="closeModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="clientForm">
                <div class="modal-body">
                    <input type="hidden" id="clientId">
                    <input type="hidden" id="clientLat">
                    <input type="hidden" id="clientLng">

                    <div class="form-group">
                        <label class="form-label required" for="clientName">Nome do Cliente</label>
                        <input
                            type="text"
                            class="form-input"
                            id="clientName"
                            placeholder="Ex: João Silva"
                            required>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="clientPhone">Telefone</label>
                        <input
                            type="tel"
                            class="form-input"
                            id="clientPhone"
                            placeholder="(11) 99999-9999">
                    </div>

                    <div class="form-group">
                        <label class="form-label required" for="clientAddress">Endereço</label>
                        <textarea
                            class="form-textarea"
                            id="clientAddress"
                            placeholder="Rua, número, bairro, cidade..."
                            required></textarea>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="btnCancelForm">
                        Cancelar
                    </button>
                    <button type="submit" class="btn btn-primary" id="btnSaveClient">
                        <i class="fas fa-save"></i> Salvar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Loader -->
    <div class="loader" id="loader">
        <div class="spinner"></div>
        <span>Carregando...</span>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast">
        <div class="toast-icon">
            <i class="fas fa-check"></i>
        </div>
        <div class="toast-message" id="toastMessage"></div>
    </div>

    <!-- Modal de Confirmação -->
    <div class="modal confirm-modal" id="confirmModal">
        <div class="modal-content">
            <div class="modal-body">
                <div class="confirm-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="confirm-message" id="confirmMessage">Tem certeza?</div>
                <div class="confirm-submessage" id="confirmSubmessage">Esta ação não pode ser desfeita.</div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="btnCancelConfirm">
                    Cancelar
                </button>
                <button type="button" class="btn btn-danger" id="btnConfirmAction">
                    <i class="fas fa-trash"></i> Excluir
                </button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyApaDb9rSw2sNTaY7fjBqmrgjWYD9xwjcU&callback=initMap&v=beta&libraries=places" async defer></script>

    <script>
        'use strict';

        /* ========================================
           CONFIGURAÇÃO
        ======================================== */
        const CONFIG = {
            SUPABASE_URL: "https://fufteldeapyvluynppuv.supabase.co",
            SUPABASE_ANON_KEY: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ1ZnRlbGRlYXB5dmx1eW5wcHV2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2MzAyMzIsImV4cCI6MjA4MDIwNjIzMn0.xr6PiskP8cJUzGBEhp_tAfZWMprxJXJyhLuOSmCQleA",
            MAP_ID: "ebb7ca4503045feabc75b373",
            DEFAULT_CENTER: { lat: -23.5505, lng: -46.6333 },
            DEFAULT_ZOOM: 17,
            TABLE_NAME: "customers"
        };

        /* ========================================
           ESTADO GLOBAL
        ======================================== */
        const AppState = {
            map: null,
            is3D: false,
            userLocationMarker: null,
            watchId: null,
            supabase: null,
            clients: [],
            markers: new Map(),
            selectedClient: null,
            clickListener: null,
            searchBox: null,
            geocoder: null
        };

        /* ========================================
           UTILITÁRIOS
        ======================================== */
        const Utils = {
            showLoader(show = true) {
                document.getElementById('loader').classList.toggle('active', show);
            },

            showToast(message, type = 'success') {
                const toast = document.getElementById('toast');
                const toastMessage = document.getElementById('toastMessage');
                const icon = toast.querySelector('.toast-icon i');

                toastMessage.textContent = message;
                toast.className = `toast ${type} active`;

                icon.className = type === 'success' ? 'fas fa-check' : 'fas fa-exclamation-circle';

                setTimeout(() => {
                    toast.classList.remove('active');
                }, 3000);
            },

            showConfirm(message, submessage = 'Esta ação não pode ser desfeita.') {
                return new Promise((resolve) => {
                    const modal = document.getElementById('confirmModal');
                    const messageEl = document.getElementById('confirmMessage');
                    const submessageEl = document.getElementById('confirmSubmessage');
                    const btnConfirm = document.getElementById('btnConfirmAction');
                    const btnCancel = document.getElementById('btnCancelConfirm');

                    messageEl.textContent = message;
                    submessageEl.textContent = submessage;

                    const handleConfirm = () => {
                        cleanup();
                        resolve(true);
                    };

                    const handleCancel = () => {
                        cleanup();
                        resolve(false);
                    };

                    const cleanup = () => {
                        modal.classList.remove('active');
                        btnConfirm.removeEventListener('click', handleConfirm);
                        btnCancel.removeEventListener('click', handleCancel);
                        modal.removeEventListener('click', handleClickOutside);
                    };

                    const handleClickOutside = (e) => {
                        if (e.target.id === 'confirmModal') {
                            handleCancel();
                        }
                    };

                    btnConfirm.addEventListener('click', handleConfirm);
                    btnCancel.addEventListener('click', handleCancel);
                    modal.addEventListener('click', handleClickOutside);

                    modal.classList.add('active');
                });
            },

            formatPhone(phone) {
                if (!phone) return '';
                const cleaned = phone.replace(/\D/g, '');
                const match = cleaned.match(/^(\d{2})(\d{5})(\d{4})$/);
                if (match) {
                    return `(${match[1]}) ${match[2]}-${match[3]}`;
                }
                return phone;
            },

            async reverseGeocode(lat, lng) {
                if (!AppState.geocoder) {
                    AppState.geocoder = new google.maps.Geocoder();
                }

                return new Promise((resolve, reject) => {
                    AppState.geocoder.geocode(
                        { location: { lat, lng } },
                        (results, status) => {
                            if (status === 'OK' && results[0]) {
                                resolve(results[0].formatted_address);
                            } else {
                                reject('Endereço não encontrado');
                            }
                        }
                    );
                });
            }
        };

        /* ========================================
           SUPABASE MODULE
        ======================================== */
        const SupabaseModule = {
            init() {
                try {
                    if (window.supabase) {
                        AppState.supabase = window.supabase.createClient(
                            CONFIG.SUPABASE_URL,
                            CONFIG.SUPABASE_ANON_KEY
                        );
                        console.log('✅ Supabase conectado');
                        return true;
                    }
                    return false;
                } catch (error) {
                    console.error('❌ Erro Supabase:', error);
                    return false;
                }
            },

            async loadClients() {
                try {
                    const { data, error } = await AppState.supabase
                        .from(CONFIG.TABLE_NAME)
                        .select('*')
                        .order('created_at', { ascending: false });

                    if (error) throw error;

                    AppState.clients = data || [];
                    ClientsModule.renderList();
                    MapModule.renderMarkers();

                    return data;
                } catch (error) {
                    console.error('❌ Erro ao carregar clientes:', error);
                    Utils.showToast('Erro ao carregar clientes', 'error');
                    return [];
                }
            },

            async saveClient(clientData) {
                try {
                    const { data, error } = await AppState.supabase
                        .from(CONFIG.TABLE_NAME)
                        .insert([clientData])
                        .select();

                    if (error) throw error;

                    return data[0];
                } catch (error) {
                    console.error('❌ Erro ao salvar cliente:', error);
                    throw error;
                }
            },

            async updateClient(id, clientData) {
                try {
                    const { data, error } = await AppState.supabase
                        .from(CONFIG.TABLE_NAME)
                        .update(clientData)
                        .eq('id', id)
                        .select();

                    if (error) throw error;

                    return data[0];
                } catch (error) {
                    console.error('❌ Erro ao atualizar cliente:', error);
                    throw error;
                }
            },

            async deleteClient(id) {
                try {
                    const { error } = await AppState.supabase
                        .from(CONFIG.TABLE_NAME)
                        .delete()
                        .eq('id', id);

                    if (error) throw error;

                    return true;
                } catch (error) {
                    console.error('❌ Erro ao deletar cliente:', error);
                    throw error;
                }
            }
        };

        /* ========================================
           CLIENTS MODULE
        ======================================== */
        const ClientsModule = {
            renderList() {
                const list = document.getElementById('clientsList');
                const count = document.getElementById('clientCount');

                count.textContent = AppState.clients.length;

                if (AppState.clients.length === 0) {
                    list.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-users"></i>
                            <p>Nenhum cliente cadastrado.<br>Clique no mapa para adicionar!</p>
                        </div>
                    `;
                    return;
                }

                list.innerHTML = AppState.clients.map(client => {
                    return `
                        <div class="client-item" data-id="${client.id}" onclick="ClientsModule.selectClient('${client.id}')">
                            <div class="client-item-header">
                                <div class="client-icon">
                                    <i class="fas fa-user"></i>
                                </div>
                                <div class="client-info">
                                    <div class="client-name">${client.name}</div>
                                    ${client.phone ? `<div class="client-phone">${Utils.formatPhone(client.phone)}</div>` : ''}
                                </div>
                                <div class="client-actions">
                                    <button class="btn-icon" onclick="event.stopPropagation(); ClientsModule.editClient('${client.id}')" title="Editar">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn-icon delete" onclick="event.stopPropagation(); ClientsModule.deleteClient('${client.id}')" title="Excluir">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            ${client.address ? `<div class="client-address">${client.address}</div>` : ''}
                        </div>
                    `;
                }).join('');
            },

            selectClient(id) {
                // Remover seleção anterior
                document.querySelectorAll('.client-item').forEach(item => {
                    item.classList.remove('active');
                });

                // Adicionar seleção
                const item = document.querySelector(`[data-id="${id}"]`);
                if (item) item.classList.add('active');

                const client = AppState.clients.find(c => c.id === id);
                if (client && AppState.map) {
                    AppState.map.panTo({ lat: client.latitude, lng: client.longitude });
                    AppState.map.setZoom(18);

                    // Animar marcador
                    const marker = AppState.markers.get(id);
                    if (marker) {
                        marker.content.style.transform = 'scale(1.2)';
                        setTimeout(() => {
                            marker.content.style.transform = 'scale(1)';
                        }, 300);
                    }
                }
            },

            editClient(id) {
                const client = AppState.clients.find(c => c.id === id);
                if (!client) return;

                document.getElementById('modalTitle').textContent = 'Editar Cliente';
                document.getElementById('clientId').value = client.id;
                document.getElementById('clientName').value = client.name;
                document.getElementById('clientPhone').value = client.phone || '';
                document.getElementById('clientAddress').value = client.address || '';
                document.getElementById('clientLat').value = client.latitude;
                document.getElementById('clientLng').value = client.longitude;

                document.getElementById('clientModal').classList.add('active');
            },

            async deleteClient(id) {
                const confirmed = await Utils.showConfirm(
                    'Tem certeza que deseja excluir este cliente?',
                    'Esta ação não pode ser desfeita.'
                );

                if (!confirmed) return;

                Utils.showLoader(true);

                try {
                    await SupabaseModule.deleteClient(id);

                    // Remover do estado
                    AppState.clients = AppState.clients.filter(c => c.id !== id);

                    // Remover marcador
                    const marker = AppState.markers.get(id);
                    if (marker) {
                        marker.setMap(null);
                        AppState.markers.delete(id);
                    }

                    ClientsModule.renderList();
                    Utils.showToast('Cliente excluído com sucesso!');
                } catch (error) {
                    Utils.showToast('Erro ao excluir cliente', 'error');
                } finally {
                    Utils.showLoader(false);
                }
            },

            async openAddClientModal(lat, lng) {
                document.getElementById('modalTitle').textContent = 'Adicionar Cliente';
                document.getElementById('clientForm').reset();
                document.getElementById('clientId').value = '';
                document.getElementById('clientLat').value = lat;
                document.getElementById('clientLng').value = lng;

                // Buscar endereço automaticamente
                try {
                    const address = await Utils.reverseGeocode(lat, lng);
                    document.getElementById('clientAddress').value = address;
                } catch (error) {
                    console.error('Erro ao buscar endereço:', error);
                }

                document.getElementById('clientModal').classList.add('active');
            }
        };

        /* ========================================
           MAP MODULE
        ======================================== */
        const MapModule = {
            init() {
                try {
                    AppState.map = new google.maps.Map(document.getElementById("map"), {
                        center: CONFIG.DEFAULT_CENTER,
                        zoom: CONFIG.DEFAULT_ZOOM,
                        mapId: CONFIG.MAP_ID,
                        tilt: 0,
                        heading: 0,
                        gestureHandling: "greedy",
                        disableDefaultUI: false,
                        zoomControl: true,
                        mapTypeControl: false,
                        streetViewControl: false,
                        fullscreenControl: false
                    });

                    // Adicionar listener de clique para adicionar clientes
                    AppState.clickListener = AppState.map.addListener('click', (e) => {
                        const lat = e.latLng.lat();
                        const lng = e.latLng.lng();
                        ClientsModule.openAddClientModal(lat, lng);
                    });

                    console.log('✅ Mapa inicializado');
                    return true;
                } catch (error) {
                    console.error('❌ Erro ao inicializar mapa:', error);
                    return false;
                }
            },

            toggle3D() {
                const btn = document.getElementById("btnToggle3D");

                if (!AppState.is3D) {
                    AppState.is3D = true;
                    btn.innerHTML = '<span style="font-size: 16px; font-weight: 600;">2D</span>';

                    this.animateValue(AppState.map.getTilt(), 67, 600, val => AppState.map.setTilt(val));
                    this.animateValue(AppState.map.getHeading(), 45, 600, val => AppState.map.setHeading(val));
                } else {
                    AppState.is3D = false;
                    btn.innerHTML = '<span style="font-size: 16px; font-weight: 600;">3D</span>';

                    this.animateValue(AppState.map.getTilt(), 0, 600, val => AppState.map.setTilt(val));
                    this.animateValue(AppState.map.getHeading(), 0, 600, val => AppState.map.setHeading(val));
                }
            },

            animateValue(start, end, duration, onUpdate) {
                const startTime = performance.now();

                const frame = (time) => {
                    const progress = Math.min((time - startTime) / duration, 1);
                    const easeProgress = progress < 0.5
                        ? 4 * progress * progress * progress
                        : 1 - Math.pow(-2 * progress + 2, 3) / 2;
                    const value = start + (end - start) * easeProgress;

                    onUpdate(value);

                    if (progress < 1) {
                        requestAnimationFrame(frame);
                    }
                };

                requestAnimationFrame(frame);
            },

            goToMyLocation() {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            const pos = {
                                lat: position.coords.latitude,
                                lng: position.coords.longitude
                            };
                            AppState.map.panTo(pos);
                            AppState.map.setZoom(17);
                            Utils.showToast('Localização atualizada!');
                        },
                        () => {
                            Utils.showToast('Erro ao obter localização', 'error');
                        }
                    );
                } else {
                    Utils.showToast('Geolocalização não suportada', 'error');
                }
            },

            renderMarkers() {
                // Limpar marcadores existentes
                AppState.markers.forEach(marker => marker.setMap(null));
                AppState.markers.clear();

                // Criar novos marcadores
                AppState.clients.forEach(client => {
                    this.createClientMarker(client);
                });
            },

            createClientMarker(client) {
                const markerDiv = document.createElement('div');
                markerDiv.className = 'client-marker';
                markerDiv.innerHTML = '<i class="fas fa-user"></i>';

                const marker = new google.maps.marker.AdvancedMarkerElement({
                    map: AppState.map,
                    position: { lat: client.latitude, lng: client.longitude },
                    content: markerDiv,
                    title: client.name
                });

                // Adicionar listener de clique
                marker.addListener('click', () => {
                    ClientsModule.selectClient(client.id);

                    // Abrir sidebar no mobile
                    if (window.innerWidth <= 768) {
                        document.getElementById('sidebar').classList.add('open');
                    }
                });

                AppState.markers.set(client.id, marker);
            }
        };

        /* ========================================
           GEOLOCATION MODULE
        ======================================== */
        const GeolocationModule = {
            startTracking() {
                if (!navigator.geolocation) {
                    console.warn('Geolocalização não suportada');
                    return;
                }

                navigator.geolocation.getCurrentPosition(
                    (position) => this.handleInitialPosition(position),
                    (error) => console.error('Erro geolocalização:', error),
                    { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
                );
            },

            handleInitialPosition(position) {
                const pos = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };

                AppState.map.setCenter(pos);
                this.createLocationMarker(pos);
                this.startWatchPosition();
            },

            createLocationMarker(pos) {
                const markerDiv = document.createElement('div');
                markerDiv.className = 'location-marker';

                AppState.userLocationMarker = new google.maps.marker.AdvancedMarkerElement({
                    map: AppState.map,
                    position: pos,
                    content: markerDiv,
                    title: "Sua Localização"
                });
            },

            startWatchPosition() {
                AppState.watchId = navigator.geolocation.watchPosition(
                    (position) => {
                        const newPos = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        if (AppState.userLocationMarker) {
                            AppState.userLocationMarker.position = newPos;
                        }
                    },
                    (error) => console.error('Watch error:', error),
                    { enableHighAccuracy: true }
                );
            }
        };

        /* ========================================
           SEARCH MODULE
        ======================================== */
        const SearchModule = {
            init() {
                const input = document.getElementById('searchAddress');

                AppState.searchBox = new google.maps.places.SearchBox(input);

                AppState.searchBox.addListener('places_changed', () => {
                    const places = AppState.searchBox.getPlaces();

                    if (places.length === 0) return;

                    const place = places[0];

                    if (!place.geometry || !place.geometry.location) return;

                    AppState.map.setCenter(place.geometry.location);
                    AppState.map.setZoom(17);

                    Utils.showToast('Local encontrado!');
                });

                // Bias para viewport atual
                AppState.map.addListener('bounds_changed', () => {
                    AppState.searchBox.setBounds(AppState.map.getBounds());
                });
            }
        };

        /* ========================================
           FORM MODULE
        ======================================== */
        const FormModule = {
            init() {
                const form = document.getElementById('clientForm');

                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await this.handleSubmit();
                });
            },

            async handleSubmit() {
                const id = document.getElementById('clientId').value;
                const clientData = {
                    name: document.getElementById('clientName').value,
                    phone: document.getElementById('clientPhone').value,
                    address: document.getElementById('clientAddress').value,
                    latitude: parseFloat(document.getElementById('clientLat').value),
                    longitude: parseFloat(document.getElementById('clientLng').value)
                };

                Utils.showLoader(true);

                try {
                    let savedClient;

                    if (id) {
                        // Atualizar
                        savedClient = await SupabaseModule.updateClient(id, clientData);
                        const index = AppState.clients.findIndex(c => c.id === id);
                        if (index !== -1) {
                            AppState.clients[index] = savedClient;
                        }
                        Utils.showToast('Cliente atualizado com sucesso!');
                    } else {
                        // Criar novo
                        savedClient = await SupabaseModule.saveClient(clientData);
                        AppState.clients.unshift(savedClient);
                        Utils.showToast('Cliente adicionado com sucesso!');
                    }

                    ClientsModule.renderList();
                    MapModule.renderMarkers();
                    this.closeModal();
                } catch (error) {
                    Utils.showToast('Erro ao salvar cliente', 'error');
                } finally {
                    Utils.showLoader(false);
                }
            },

            closeModal() {
                document.getElementById('clientModal').classList.remove('active');
                document.getElementById('clientForm').reset();
            }
        };

        /* ========================================
           EVENT HANDLERS
        ======================================== */
        const EventHandlers = {
            init() {
                // Sidebar
                document.getElementById('toggleSidebar').addEventListener('click', () => {
                    document.getElementById('sidebar').classList.toggle('open');
                });

                document.getElementById('closeSidebar').addEventListener('click', () => {
                    document.getElementById('sidebar').classList.remove('open');
                });

                // Modal
                document.getElementById('btnAddClient').addEventListener('click', () => {
                    const center = AppState.map.getCenter();
                    ClientsModule.openAddClientModal(center.lat(), center.lng());
                });

                document.getElementById('closeModal').addEventListener('click', () => {
                    FormModule.closeModal();
                });

                document.getElementById('btnCancelForm').addEventListener('click', () => {
                    FormModule.closeModal();
                });

                // Map Controls
                document.getElementById('btnToggle3D').addEventListener('click', () => {
                    MapModule.toggle3D();
                });

                document.getElementById('btnMyLocation').addEventListener('click', () => {
                    MapModule.goToMyLocation();
                });

                // Fechar modal ao clicar fora
                document.getElementById('clientModal').addEventListener('click', (e) => {
                    if (e.target.id === 'clientModal') {
                        FormModule.closeModal();
                    }
                });

                // Cleanup
                window.addEventListener('beforeunload', () => {
                    if (AppState.watchId) {
                        navigator.geolocation.clearWatch(AppState.watchId);
                    }
                });
            }
        };

        /* ========================================
           INICIALIZAÇÃO
        ======================================== */
        async function initMap() {
            console.log('🚀 Inicializando aplicação...');

            // Inicializar Supabase
            SupabaseModule.init();

            // Inicializar Mapa
            if (MapModule.init()) {
                // Inicializar módulos
                EventHandlers.init();
                FormModule.init();
                SearchModule.init();
                GeolocationModule.startTracking();

                // Carregar clientes
                await SupabaseModule.loadClients();

                console.log('✅ Aplicação inicializada');
            }
        }

        // Expor para Google Maps
        window.initMap = initMap;
    </script>

</body>
</html>
