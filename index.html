<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Mapa de Clientes - Google Maps</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìç</text></svg>">

<style>
    :root {
        --primary-color: #4285f4;
        --success-color: #34a853;
        --warning-color: #fbbc04;
        --error-color: #ea4335;
        --bg-overlay: rgba(0, 0, 0, 0.5);
        --shadow-sm: 0 2px 6px rgba(0,0,0,0.3);
        --shadow-lg: 0 4px 12px rgba(0,0,0,0.4);
    }

    body, html {
        margin: 0;
        padding: 0;
        height: 100%;
        width: 100%;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        overflow: hidden;
    }

    #map {
        height: 100%;
        width: 100%;
        position: absolute;
        top: 0;
        left: 0;
        opacity: 0;
        transition: opacity 0.5s ease-in-out;
        /* GPU acceleration otimizada para multim√≠dia de carro */
        transform: translateZ(0);
        -webkit-transform: translateZ(0);
        will-change: transform;
        /* Otimiza√ß√µes de renderiza√ß√£o */
        -webkit-backface-visibility: hidden;
        backface-visibility: hidden;
        -webkit-perspective: 1000;
        perspective: 1000;
        /* Permitir todos os gestos (rota√ß√£o, zoom, arrasto) */
        touch-action: manipulation;
        -webkit-overflow-scrolling: touch;
        -webkit-font-smoothing: antialiased;
    }

    #map.loaded {
        opacity: 1;
        will-change: auto; /* Remove will-change ap√≥s carregamento */
    }

    /* ===========================
       LOADING SCREEN
       =========================== */
    #loading-screen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        transition: opacity 0.5s ease-in-out, visibility 0.5s;
    }

    #loading-screen.hidden {
        opacity: 0;
        visibility: hidden;
    }

    .loading-content {
        text-align: center;
        color: white;
    }

    .spinner {
        width: 60px;
        height: 60px;
        margin: 0 auto 24px;
        position: relative;
    }

    .spinner::before {
        content: '';
        box-sizing: border-box;
        position: absolute;
        top: 50%;
        left: 50%;
        width: 60px;
        height: 60px;
        margin-top: -30px;
        margin-left: -30px;
        border-radius: 50%;
        border: 4px solid rgba(255, 255, 255, 0.2);
        border-top-color: white;
        animation: spinner 0.8s linear infinite;
    }

    @keyframes spinner {
        to { transform: rotate(360deg); }
    }

    .loading-text {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 8px;
        animation: pulse-text 2s ease-in-out infinite;
    }

    .loading-subtext {
        font-size: 14px;
        opacity: 0.9;
        font-weight: 400;
    }

    @keyframes pulse-text {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.6; }
    }

    /* ===========================
       CONTROLES DO MAPA
       =========================== */
    .map-control {
        position: fixed;
        top: 90px;
        right: 20px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        z-index: 9999;
        opacity: 0;
        transform: translateX(100px);
        transition: opacity 0.5s ease-in-out 0.3s, transform 0.5s ease-in-out 0.3s;
    }

    .map-control.visible {
        opacity: 1;
        transform: translateX(0);
    }

    .control-btn {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        border: none;
        background: white;
        box-shadow: var(--shadow-sm);
        font-size: 18px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        position: relative;
        color: #333;
        /* Centralizar √≠cone perfeitamente */
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0;
        line-height: 1;
    }

    .control-btn:hover {
        box-shadow: var(--shadow-lg);
        transform: translateY(-2px);
    }

    .control-btn:active {
        transform: translateY(0) scale(0.95);
    }

    .control-btn.active {
        background: var(--primary-color);
        color: white;
    }

    .control-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none !important;
    }

    /* Indicador de carregamento no bot√£o */
    .control-btn.loading::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 20px;
        height: 20px;
        margin-top: -10px;
        margin-left: -10px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-top-color: white;
        border-radius: 50%;
        animation: spinner 0.6s linear infinite;
    }

    .control-btn.loading {
        color: transparent;
    }

    /* ===========================
       MARCADOR DA LOCALIZA√á√ÉO
       =========================== */
    .location-marker {
        width: 20px;
        height: 20px;
        background: var(--primary-color);
        border: 3px solid white;
        border-radius: 50%;
        box-shadow: 0 2px 6px rgba(0,0,0,0.4);
        position: relative;
        /* Transi√ß√£o suave para movimentos fluidos */
        transition: transform 0.1s ease-out;
        will-change: transform;
    }

    .location-marker::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 8px;
        height: 8px;
        background: white;
        border-radius: 50%;
    }

    @keyframes pulse {
        0% { box-shadow: 0 0 0 0 rgba(66,133,244,0.7); }
        70% { box-shadow: 0 0 0 10px rgba(66,133,244,0); }
        100% { box-shadow: 0 0 0 0 rgba(66,133,244,0); }
    }

    .location-marker.active {
        animation: pulse 2s infinite;
    }

    /* ===========================
       SISTEMA DE NOTIFICA√á√ïES
       =========================== */
    #toast-container {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 10001;
        display: flex;
        flex-direction: column;
        gap: 10px;
        max-width: 90%;
        width: 400px;
    }

    .toast {
        background: white;
        padding: 16px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        display: flex;
        align-items: center;
        gap: 12px;
        animation: slideDown 0.3s ease-out;
        border-left: 4px solid var(--primary-color);
    }

    .toast.success { border-left-color: var(--success-color); }
    .toast.warning { border-left-color: var(--warning-color); }
    .toast.error { border-left-color: var(--error-color); }

    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .toast.hiding {
        animation: slideUp 0.3s ease-out forwards;
    }

    @keyframes slideUp {
        from {
            opacity: 1;
            transform: translateY(0);
        }
        to {
            opacity: 0;
            transform: translateY(-20px);
        }
    }

    .toast-icon {
        font-size: 20px;
        flex-shrink: 0;
    }

    .toast-content {
        flex: 1;
    }

    .toast-title {
        font-weight: 600;
        margin-bottom: 4px;
        color: #333;
    }

    .toast-message {
        font-size: 14px;
        color: #666;
    }

    /* ===========================
       STATUS BAR
       =========================== */
    #status-bar {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        padding: 12px 20px;
        border-radius: 24px;
        box-shadow: var(--shadow-sm);
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 14px;
        color: #333;
        z-index: 9999;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    #status-bar.visible {
        opacity: 1;
    }

    .status-indicator {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--success-color);
        animation: blink 2s infinite;
    }

    @keyframes blink {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.3; }
    }

    .status-indicator.inactive {
        background: #ccc;
        animation: none;
    }

    /* ===========================
       BOT√ÉO ADICIONAR CLIENTE
       =========================== */
    #btn-add-client {
        position: fixed;
        bottom: 80px;
        left: 50%;
        transform: translateX(-50%);
        background: var(--primary-color);
        color: white;
        border: none;
        padding: 16px 32px;
        border-radius: 30px;
        font-size: 16px;
        font-weight: 600;
        box-shadow: var(--shadow-lg);
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 10px;
        z-index: 9999;
        opacity: 0;
        transition: all 0.3s ease;
    }

    #btn-add-client.visible {
        opacity: 1;
    }

    #btn-add-client:hover {
        transform: translateX(-50%) translateY(-3px);
        box-shadow: 0 6px 20px rgba(66, 133, 244, 0.4);
    }

    #btn-add-client:active {
        transform: translateX(-50%) translateY(-1px);
    }

    /* ===========================
       MODAL ADICIONAR CLIENTE
       =========================== */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: var(--bg-overlay);
        z-index: 10004;
        display: none;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .modal-overlay.active {
        display: flex;
        opacity: 1;
    }

    .modal-container {
        background: white;
        border-radius: 16px;
        width: 90%;
        max-width: 500px;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        transform: scale(0.9);
        transition: transform 0.3s ease;
    }

    .modal-overlay.active .modal-container {
        transform: scale(1);
    }

    .modal-close {
        width: 32px;
        height: 32px;
        border: none;
        background: rgba(255, 255, 255, 0.9);
        border-radius: 50%;
        font-size: 18px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
        box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        flex-shrink: 0;
    }

    .modal-close:hover {
        background: white;
        transform: rotate(90deg);
    }

    .modal-body {
        padding: 24px;
    }

    /* QR Code Scanner */
    .qr-scanner-section {
        margin-bottom: 24px;
    }

    .scanner-title {
        font-size: 14px;
        font-weight: 600;
        color: #666;
        margin-bottom: 12px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .qr-camera-container {
        position: relative;
        width: 100%;
        max-width: 400px;
        margin: 0 auto;
        background: #000;
        border-radius: 12px;
        overflow: hidden;
        display: none;
    }

    .qr-camera-container.active {
        display: block;
    }

    #qr-video {
        width: 100%;
        height: auto;
        max-height: 300px;
        min-height: 200px;
        object-fit: cover;
        display: block;
        background: #000;
    }

    #qr-video:not([src]) {
        opacity: 0.3;
    }

    /* V√≠deo do scanner de pacotes - mesmos estilos */
    #qr-package-video {
        width: 100%;
        height: auto;
        max-height: 300px;
        min-height: 200px;
        object-fit: cover;
        display: block;
        background: #000;
    }

    #qr-package-video:not([src]) {
        opacity: 0.3;
    }

    #qr-canvas,
    #qr-package-canvas {
        display: none;
    }

    .qr-overlay {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 200px;
        height: 200px;
        border: 2px solid rgba(255, 255, 255, 0.5);
        border-radius: 12px;
        pointer-events: none;
    }

    .qr-overlay::before,
    .qr-overlay::after {
        content: '';
        position: absolute;
        width: 20px;
        height: 20px;
        border: 3px solid white;
    }

    .qr-overlay::before {
        top: -3px;
        left: -3px;
        border-right: none;
        border-bottom: none;
    }

    .qr-overlay::after {
        top: -3px;
        right: -3px;
        border-left: none;
        border-bottom: none;
    }

    .qr-overlay-bottom-left::before,
    .qr-overlay-bottom-right::after {
        content: '';
        position: absolute;
        width: 20px;
        height: 20px;
        border: 3px solid white;
    }

    .qr-overlay-bottom-left::before {
        bottom: -3px;
        left: -3px;
        border-right: none;
        border-top: none;
    }

    .qr-overlay-bottom-right::after {
        bottom: -3px;
        right: -3px;
        border-left: none;
        border-top: none;
    }

    .scanning-line {
        position: absolute;
        width: 100%;
        height: 2px;
        background: linear-gradient(90deg, transparent, var(--success-color), transparent);
        top: 50%;
        animation: scan 2s linear infinite;
        pointer-events: none;
    }

    @keyframes scan {
        0% { top: 25%; opacity: 0; }
        50% { opacity: 1; }
        100% { top: 75%; opacity: 0; }
    }

    .camera-controls {
        position: absolute;
        bottom: 12px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 10px;
        z-index: 10;
    }

    .camera-btn {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        border: none;
        background: rgba(255, 255, 255, 0.9);
        color: #333;
        font-size: 18px;
        cursor: pointer;
        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        transition: all 0.2s ease;
    }

    .camera-btn:hover {
        background: white;
        transform: scale(1.1);
    }

    .camera-btn:active {
        transform: scale(0.95);
    }

    .address-display {
        margin-bottom: 24px;
        padding: 16px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 12px;
        color: white;
        display: none;
        animation: slideIn 0.3s ease-out;
    }

    .address-display.active {
        display: block;
    }

    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @keyframes highlight-pulse {
        0% {
            background: #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transform: scale(1);
        }
        50% {
            background: #e3f2fd;
            box-shadow: 0 4px 12px rgba(33,150,243,0.3);
            transform: scale(1.02);
        }
        100% {
            background: #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transform: scale(1);
        }
    }

    .address-label {
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        opacity: 0.9;
        margin-bottom: 8px;
    }

    .address-text {
        font-size: 15px;
        font-weight: 500;
        line-height: 1.5;
    }

    .address-icon {
        font-size: 20px;
        margin-right: 8px;
    }

    .qr-status {
        position: absolute;
        top: 12px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 6px 12px;
        border-radius: 16px;
        font-size: 12px;
        font-weight: 500;
        z-index: 10;
        white-space: nowrap;
    }

    .qr-status.success {
        background: rgba(52, 168, 83, 0.9);
    }

    .qr-result {
        margin-top: 12px;
        padding: 12px;
        background: #e8f5e9;
        border-left: 4px solid var(--success-color);
        border-radius: 4px;
        display: none;
    }

    .qr-result.active {
        display: block;
    }

    .qr-result-text {
        font-size: 13px;
        color: #2e7d32;
        word-break: break-all;
    }

    /* Formul√°rio */
    .form-group {
        margin-bottom: 20px;
    }

    .form-label {
        display: block;
        font-size: 14px;
        font-weight: 600;
        color: #333;
        margin-bottom: 8px;
    }

    .form-input {
        width: 100%;
        padding: 12px 16px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 16px;
        font-family: inherit;
        transition: all 0.2s ease;
        box-sizing: border-box;
    }

    .form-input:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.1);
    }

    .form-input:disabled {
        background: #f5f5f5;
        color: #999;
        cursor: not-allowed;
    }

    .form-input::placeholder {
        color: #999;
    }

    .form-textarea {
        min-height: 80px;
        resize: vertical;
        font-family: inherit;
    }

    .form-footer {
        padding: 16px 24px;
        border-top: 1px solid #e0e0e0;
        display: flex;
        gap: 12px;
        justify-content: flex-end;
    }

    .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .btn-secondary {
        background: #f5f5f5;
        color: #666;
    }

    .btn-secondary:hover {
        background: #e0e0e0;
    }

    .btn-primary {
        background: var(--primary-color);
        color: white;
    }

    .btn-primary:hover {
        background: #3367d6;
    }

    .btn-primary:disabled {
        background: #ccc;
        cursor: not-allowed;
    }

    /* Loading no modal */
    .btn.loading {
        position: relative;
        color: transparent;
    }

    .btn.loading::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 16px;
        height: 16px;
        margin-top: -8px;
        margin-left: -8px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-top-color: white;
        border-radius: 50%;
        animation: spinner 0.6s linear infinite;
    }

    /* ===========================
       MENU LATERAL (SIDEBAR)
       =========================== */
    .sidebar {
        position: fixed;
        top: 0;
        left: -400px;
        width: 400px;
        height: 100%;
        background: white;
        box-shadow: 2px 0 12px rgba(0,0,0,0.15);
        z-index: 10003;
        transition: left 0.3s ease;
        display: flex;
        flex-direction: column;
    }

    .sidebar.open {
        left: 0;
    }

    .sidebar-header {
        padding: 20px;
        border-bottom: 2px solid #e0e0e0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .sidebar-title {
        font-size: 20px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .sidebar-close {
        width: 32px;
        height: 32px;
        border: none;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 50%;
        color: white;
        font-size: 18px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
    }

    .sidebar-close:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: rotate(90deg);
    }

    .sidebar-search {
        padding: 16px;
        border-bottom: 1px solid #e0e0e0;
    }

    .search-container {
        position: relative;
        display: flex;
        gap: 8px;
        align-items: center;
    }

    .search-input-wrapper {
        position: relative;
        flex: 1;
    }

    .search-icon {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 18px;
        color: #999;
        pointer-events: none;
    }

    .search-input {
        width: 100%;
        padding: 12px 12px 12px 42px;
        border: 2px solid #e0e0e0;
        border-radius: 24px;
        font-size: 15px;
        font-family: inherit;
        transition: all 0.2s ease;
        box-sizing: border-box;
    }

    .search-input:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.1);
    }

    .search-input::placeholder {
        color: #999;
    }

    .btn-scan-package {
        background: var(--primary-color);
        color: white;
        border: none;
        border-radius: 50%;
        width: 44px;
        height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        cursor: pointer;
        transition: all 0.2s ease;
        flex-shrink: 0;
        box-shadow: 0 2px 4px rgba(0,0,0,0.15);
    }

    .btn-scan-package:hover {
        background: #1976D2;
        transform: scale(1.05);
        box-shadow: 0 3px 6px rgba(33,150,243,0.4);
    }

    .btn-scan-package:active {
        transform: scale(0.95);
    }

    /* Resultado do scanner de pacotes */
    .scan-result {
        display: none;
        margin-top: 20px;
        padding: 16px;
        background: #f5f5f5;
        border-radius: 8px;
    }

    .scan-result.active {
        display: block;
    }

    .scan-result-label {
        font-weight: 600;
        color: #333;
        margin-bottom: 8px;
    }

    .scan-result-text {
        color: #666;
    }

    /* Upload de Planilha */
    .upload-area {
        border: 2px dashed #ccc;
        border-radius: 12px;
        padding: 40px 20px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        background: #fafafa;
    }

    .upload-area:hover {
        border-color: var(--primary-color);
        background: #f0f7ff;
    }

    .upload-area.dragover {
        border-color: var(--primary-color);
        background: #e3f2fd;
        transform: scale(1.02);
    }

    .upload-icon {
        font-size: 48px;
        margin-bottom: 12px;
    }

    .upload-text {
        font-size: 16px;
        font-weight: 600;
        color: #333;
        margin-bottom: 4px;
    }

    .upload-subtext {
        font-size: 14px;
        color: #666;
        margin-bottom: 8px;
    }

    .upload-formats {
        font-size: 12px;
        color: #999;
    }

    .upload-progress {
        text-align: center;
        padding: 20px;
    }

    .progress-bar-container {
        width: 100%;
        height: 8px;
        background: #e0e0e0;
        border-radius: 4px;
        overflow: hidden;
        margin-bottom: 12px;
    }

    .progress-bar {
        height: 100%;
        background: linear-gradient(90deg, var(--primary-color), #1976D2);
        width: 0%;
        transition: width 0.3s ease;
        animation: progress-pulse 1.5s ease-in-out infinite;
    }

    @keyframes progress-pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
    }

    .progress-text {
        font-size: 14px;
        color: #666;
    }

    .upload-result {
        text-align: center;
        padding: 20px;
    }

    .result-icon {
        font-size: 48px;
        margin-bottom: 12px;
    }

    .result-text {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 8px;
    }

    .result-details {
        font-size: 14px;
        color: #666;
        margin-top: 10px;
        line-height: 1.6;
    }

    .sidebar-content {
        flex: 1;
        overflow-y: auto;
        padding: 16px;
    }

    .clients-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .client-card {
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 12px;
        padding: 16px;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .client-card:hover {
        border-color: var(--primary-color);
        box-shadow: 0 2px 8px rgba(66, 133, 244, 0.15);
        transform: translateY(-2px);
    }

    .client-card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 8px;
        gap: 8px;
    }

    .client-name {
        font-size: 16px;
        font-weight: 600;
        color: #333;
        display: flex;
        align-items: center;
        gap: 8px;
        flex: 1;
    }

    .client-actions {
        display: flex;
        gap: 8px;
        opacity: 1;
    }

    .client-action-btn {
        background: none;
        border: none;
        padding: 6px 10px;
        cursor: pointer;
        font-size: 20px;
        border-radius: 6px;
        transition: all 0.2s ease;
        line-height: 1;
        min-width: 38px;
        min-height: 38px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .client-action-btn:hover {
        background: #f0f0f0;
        transform: scale(1.1);
    }

    .client-action-btn.navigate-btn:hover {
        background: #e8f5e9;
    }

    .client-action-btn.edit-btn:hover {
        background: #e3f2fd;
    }

    .client-action-btn.delete-btn:hover {
        background: #ffebee;
    }

    .client-info {
        font-size: 14px;
        color: #666;
        margin-bottom: 4px;
        display: flex;
        align-items: flex-start;
        gap: 8px;
    }

    .client-info.phone-info {
        align-items: center;
        justify-content: space-between;
    }

    .client-info-icon {
        font-size: 14px;
        opacity: 0.7;
        flex-shrink: 0;
        margin-top: 2px;
    }

    .phone-actions {
        display: flex;
        gap: 12px;
        margin-left: auto;
    }

    .phone-action-btn {
        border: none;
        padding: 0;
        cursor: pointer;
        border-radius: 50%;
        transition: all 0.2s ease;
        text-decoration: none;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 38px;
        height: 38px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.15);
    }

    .phone-action-btn svg {
        width: 20px;
        height: 20px;
    }

    .phone-action-btn svg {
        transition: all 0.2s ease;
    }

    /* Classes para estado resetado - for√ßa re-render */
    .phone-action-btn.btn-reset {
        pointer-events: auto !important;
        outline: none !important;
    }

    .phone-action-btn.call-btn {
        background: #2196F3;
        box-shadow: 0 2px 4px rgba(0,0,0,0.15);
        transform: scale(1);
    }

    .phone-action-btn.call-btn:link,
    .phone-action-btn.call-btn:visited,
    .phone-action-btn.call-btn:focus,
    .phone-action-btn.call-btn:active,
    .phone-action-btn.call-btn:focus-visible {
        background: #2196F3;
        box-shadow: 0 2px 4px rgba(0,0,0,0.15);
        transform: scale(1);
    }

    /* Hover apenas em desktop - n√£o em touch */
    @media (hover: hover) and (pointer: fine) {
        .phone-action-btn.call-btn:hover:not(:active) {
            background: #1976D2;
            transform: scale(1.1);
            box-shadow: 0 3px 6px rgba(33,150,243,0.4);
        }
    }

    .phone-action-btn.whatsapp-btn {
        background: #25D366;
        box-shadow: 0 2px 4px rgba(0,0,0,0.15);
        transform: scale(1);
    }

    .phone-action-btn.whatsapp-btn:link,
    .phone-action-btn.whatsapp-btn:visited,
    .phone-action-btn.whatsapp-btn:focus,
    .phone-action-btn.whatsapp-btn:active,
    .phone-action-btn.whatsapp-btn:focus-visible {
        background: #25D366;
        box-shadow: 0 2px 4px rgba(0,0,0,0.15);
        transform: scale(1);
    }

    /* Hover apenas em desktop - n√£o em touch */
    @media (hover: hover) and (pointer: fine) {
        .phone-action-btn.whatsapp-btn:hover:not(:active) {
            background: #128C7E;
            transform: scale(1.1);
            box-shadow: 0 3px 6px rgba(37,211,102,0.4);
        }
    }

    .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: #999;
    }

    .empty-state-icon {
        font-size: 48px;
        margin-bottom: 16px;
        opacity: 0.5;
    }

    .empty-state-text {
        font-size: 16px;
        font-weight: 500;
        margin-bottom: 8px;
    }

    .empty-state-subtext {
        font-size: 14px;
    }

    .sidebar-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 10002;
        display: none;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .sidebar-overlay.active {
        display: block;
        opacity: 1;
    }

    .client-count {
        display: inline-block;
        background: rgba(255, 255, 255, 0.2);
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 13px;
        font-weight: 600;
    }

    /* ===========================
       RESPONSIVO
       =========================== */
    @media (max-width: 768px) {
        .map-control {
            top: 70px;
            right: 10px;
        }

        .control-btn {
            width: 44px;
            height: 44px;
            font-size: 16px;
        }

        #toast-container {
            width: calc(100% - 40px);
        }

        .toast {
            padding: 12px 16px;
        }

        .loading-text {
            font-size: 16px;
        }

        .loading-subtext {
            font-size: 13px;
        }

        #status-bar {
            bottom: 10px;
            font-size: 13px;
            padding: 10px 16px;
        }

        #btn-add-client {
            bottom: 60px;
            padding: 14px 24px;
            font-size: 15px;
        }

        /* Ajustes para mobile - bot√µes maiores */
        .phone-action-btn {
            width: 42px;
            height: 42px;
        }

        .phone-action-btn svg {
            width: 22px;
            height: 22px;
        }

        .phone-actions {
            gap: 14px;
        }

        .client-action-btn {
            font-size: 22px;
            min-width: 42px;
            min-height: 42px;
            padding: 8px 12px;
        }

        .client-actions {
            gap: 10px;
        }

        /* Desabilitar hover em mobile - evitar estados persistentes */
        .phone-action-btn {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        .phone-action-btn.call-btn,
        .phone-action-btn.call-btn:link,
        .phone-action-btn.call-btn:visited,
        .phone-action-btn.call-btn:focus,
        .phone-action-btn.call-btn:active,
        .phone-action-btn.call-btn:focus-visible,
        .phone-action-btn.call-btn:hover {
            background: #2196F3;
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
            transform: scale(1);
        }

        .phone-action-btn.whatsapp-btn,
        .phone-action-btn.whatsapp-btn:link,
        .phone-action-btn.whatsapp-btn:visited,
        .phone-action-btn.whatsapp-btn:focus,
        .phone-action-btn.whatsapp-btn:active,
        .phone-action-btn.whatsapp-btn:focus-visible,
        .phone-action-btn.whatsapp-btn:hover {
            background: #25D366;
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
            transform: scale(1);
        }

        .modal-container {
            width: 95%;
            max-height: 95vh;
        }

        .modal-body {
            padding: 20px;
        }

        .scanner-title {
            font-size: 13px;
        }

        .modal-close {
            width: 28px;
            height: 28px;
            font-size: 16px;
        }

        .qr-camera-container {
            max-width: 100%;
        }

        #qr-video,
        #qr-package-video {
            max-height: 250px;
        }

        .qr-overlay {
            width: 180px;
            height: 180px;
        }

        .qr-upload-area {
            padding: 24px;
        }

        .qr-icon {
            font-size: 40px;
        }

        .form-footer {
            padding: 12px 20px;
            flex-direction: column-reverse;
        }

        .btn {
            width: 100%;
        }

        .sidebar {
            width: 100%;
            left: -100%;
        }

        .sidebar.open {
            left: 0;
        }

        .sidebar-title {
            font-size: 18px;
        }

        .sidebar-content {
            padding: 12px;
        }

        .client-card {
            padding: 14px;
        }
    }

    /* Esconder o bot√£o X padr√£o do Google Maps InfoWindow */
    .gm-style-iw-chr {
        display: none !important;
    }

    .gm-ui-hover-effect {
        display: none !important;
    }
</style>
</head>
<body>

<!-- Loading Screen -->
<div id="loading-screen">
    <div class="loading-content">
        <div class="spinner"></div>
        <div class="loading-text" id="loading-text">Inicializando mapa...</div>
        <div class="loading-subtext" id="loading-subtext">Aguarde um momento</div>
    </div>
</div>

<!-- Mapa -->
<div id="map"></div>

<!-- Controles -->
<div class="map-control">
    <button id="btnToggle3D" class="control-btn" title="Alternar visualiza√ß√£o 3D">3D</button>
    <button id="btnCenterLocation" class="control-btn" title="Centralizar na minha localiza√ß√£o">üìç</button>
    <button id="btnToggleRoute" class="control-btn" title="Planejar rota de entrega">üöó</button>
    <button id="btnClearRoute" class="control-btn" title="Limpar rotas e marcadores" style="display: none;">üóëÔ∏è</button>
    <button id="btnOpenSidebar" class="control-btn" title="Ver lista de clientes">üë•</button>
    <button id="btnUploadSpreadsheet" class="control-btn" title="Atualizar planilha do dia">üìä</button>
    <button id="btnToggleClients" class="control-btn" title="Mostrar/Ocultar clientes no mapa">üë§</button>
    <button id="btnShowMatchedClients" class="control-btn" title="Mostrar clientes identificados na planilha">üìç</button>
</div>

<!-- Container de Notifica√ß√µes -->
<div id="toast-container"></div>

<!-- Status Bar -->
<div id="status-bar">
    <div class="status-indicator" id="status-indicator"></div>
    <span id="status-text">Rastreando localiza√ß√£o</span>
</div>

<!-- Bot√£o Adicionar Cliente -->
<button id="btn-add-client">
    <span>‚ûï</span>
    <span>Adicionar Cliente</span>
</button>

<!-- Sidebar - Menu Lateral -->
<div class="sidebar-overlay" id="sidebar-overlay"></div>

<div class="sidebar" id="sidebar">
    <div class="sidebar-header">
        <div class="sidebar-title">
            <span>üë•</span>
            <span>Clientes</span>
            <span class="client-count" id="client-count">0</span>
        </div>
        <button class="sidebar-close" id="sidebar-close">‚úï</button>
    </div>

    <div class="sidebar-search">
        <div class="search-container">
            <div class="search-input-wrapper">
                <span class="search-icon">üîç</span>
                <input
                    type="text"
                    class="search-input"
                    id="search-input"
                    placeholder="Buscar por nome, endere√ßo ou telefone..."
                >
            </div>
            <button class="btn-scan-package" id="btn-scan-package" title="Escanear c√≥digo QR do pacote">üì¶</button>
        </div>
    </div>

    <div class="sidebar-content">
        <div class="clients-list" id="clients-list">
            <!-- Lista de clientes ser√° inserida aqui -->
            <div class="empty-state">
                <div class="empty-state-icon">üìã</div>
                <div class="empty-state-text">Nenhum cliente cadastrado</div>
                <div class="empty-state-subtext">Adicione clientes para v√™-los aqui</div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Adicionar Cliente -->
<div class="modal-overlay" id="modal-add-client">
    <div class="modal-container">
        <div class="modal-body">
            <!-- Scanner QR Code -->
            <div class="qr-scanner-section">
                <div class="scanner-title">
                    <span>üì∏ Aponte a c√¢mera para o QR Code</span>
                    <button class="modal-close" id="modal-close">‚úï</button>
                </div>

                <div class="qr-camera-container active" id="qr-camera-container">
                    <video id="qr-video" autoplay playsinline></video>
                    <canvas id="qr-canvas"></canvas>

                    <div class="qr-overlay">
                        <div class="qr-overlay-bottom-left"></div>
                        <div class="qr-overlay-bottom-right"></div>
                    </div>

                    <div class="scanning-line"></div>

                    <div class="qr-status" id="qr-status">Procurando QR Code...</div>

                    <div class="camera-controls">
                        <button class="camera-btn" id="btn-stop-camera" title="Fechar c√¢mera">‚úï</button>
                        <button class="camera-btn" id="btn-switch-camera" title="Trocar c√¢mera">üîÑ</button>
                    </div>
                </div>
            </div>

            <!-- Display do Endere√ßo -->
            <div class="address-display" id="address-display">
                <div class="address-label">üìç Endere√ßo do Cliente</div>
                <div class="address-text" id="address-text"></div>
            </div>

            <!-- Formul√°rio -->
            <form id="form-add-client">

                <div class="form-group">
                    <label class="form-label" for="input-name">Nome do Cliente *</label>
                    <input
                        type="text"
                        class="form-input"
                        id="input-name"
                        placeholder="Digite o nome do cliente"
                        required
                    >
                </div>

                <div class="form-group">
                    <label class="form-label" for="input-phone">Telefone</label>
                    <input
                        type="tel"
                        class="form-input"
                        id="input-phone"
                        placeholder="(91)9 9942-1942"
                        maxlength="16"
                    >
                </div>
            </form>
        </div>

        <div class="form-footer">
            <button type="button" class="btn btn-secondary" id="btn-cancel">Cancelar</button>
            <button type="submit" class="btn btn-primary" id="btn-save" form="form-add-client">Salvar Cliente</button>
        </div>
    </div>
</div>

<!-- Modal Scanner de Pacotes -->
<div class="modal-overlay" id="modal-scan-package">
    <div class="modal-container">
        <div class="modal-body">
            <!-- Scanner QR Code -->
            <div class="qr-scanner-section">
                <div class="scanner-title">
                    <span>üì¶ Escanear C√≥digo do Pacote</span>
                    <button class="modal-close" id="modal-scan-close">‚úï</button>
                </div>

                <div class="qr-camera-container" id="qr-package-camera-container">
                    <video id="qr-package-video" autoplay playsinline></video>
                    <canvas id="qr-package-canvas"></canvas>

                    <div class="qr-overlay">
                        <div class="qr-overlay-bottom-left"></div>
                        <div class="qr-overlay-bottom-right"></div>
                    </div>

                    <div class="scanning-line"></div>

                    <div class="qr-status" id="qr-package-status">Procurando c√≥digo QR...</div>

                    <div class="camera-controls">
                        <button class="camera-btn" id="btn-package-stop-camera" title="Fechar c√¢mera">‚úï</button>
                        <button class="camera-btn" id="btn-package-switch-camera" title="Trocar c√¢mera">üîÑ</button>
                    </div>
                </div>
            </div>

            <!-- Resultado da busca -->
            <div class="scan-result" id="scan-result">
                <div class="scan-result-label">üìã Cliente Encontrado:</div>
                <div class="scan-result-text" id="scan-result-text"></div>
            </div>
        </div>

        <div class="form-footer">
            <button type="button" class="btn btn-secondary" id="btn-package-close">Fechar</button>
        </div>
    </div>
</div>

<!-- Modal Upload de Planilha -->
<div class="modal-overlay" id="modal-upload-spreadsheet">
    <div class="modal-container">
        <div class="modal-body">
            <div class="scanner-title">
                <span>üìä Atualizar Planilha do Dia</span>
                <button class="modal-close" id="modal-upload-close">‚úï</button>
            </div>

            <div class="upload-info" style="background: #fff3cd; padding: 12px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #ffc107;">
                <div style="font-weight: 600; color: #856404; margin-bottom: 4px;">‚ö†Ô∏è Aten√ß√£o</div>
                <div style="font-size: 13px; color: #856404;">
                    Ao fazer upload de uma nova planilha, todos os dados anteriores ser√£o substitu√≠dos e a roteiriza√ß√£o ser√° resetada.
                </div>
            </div>

            <div class="upload-area" id="upload-area">
                <div class="upload-icon">üìä</div>
                <div class="upload-text">Arraste a planilha aqui</div>
                <div class="upload-subtext">ou clique para selecionar</div>
                <div class="upload-formats">Formatos: Excel (.xlsx, .xls) ou CSV (.csv)</div>
                <input type="file" id="file-input" accept=".xlsx,.xls,.csv" style="display: none;">
            </div>

            <div class="upload-progress" id="upload-progress" style="display: none;">
                <div class="progress-bar-container">
                    <div class="progress-bar" id="progress-bar"></div>
                </div>
                <div class="progress-text" id="progress-text">Processando planilha...</div>
            </div>

            <div class="upload-result" id="upload-result" style="display: none;">
                <div class="result-icon" id="result-icon"></div>
                <div class="result-text" id="result-text"></div>
                <div class="result-details" id="result-details"></div>
            </div>
        </div>
    </div>
</div>

<!-- SheetJS - Biblioteca para processamento de Excel -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<!-- jsQR - Biblioteca de leitura de QR Code -->
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>

<script>
    const SUPABASE_URL = "https://dctlgztkqtktxnmiuqgr.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRjdGxnenRrcXRrdHhubWl1cWdyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2MzMwNDIsImV4cCI6MjA4MDIwOTA0Mn0.Ctlx8A4QBFxa7Iu6fObw_OthHfA2XrzY47UiMMIhbIU";

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Dados da planilha Excel - Mapeamento de QR codes para endere√ßos
    const addressDatabase = {
  "BR2548334621214": {
    "address": "Alameda Moraes, 246, Rua ao lado do Conselho tutela\nBairro: Praia Grande (Mosqueiro)\nBel√©m - 66914-090",
    "latitude": -1.1424655,
    "longitude": -48.4652878,
    "city": "Bel√©m",
    "zipcode": "66914-090",
    "sequence": 1
  },
  "BR258090515239N": {
    "address": "Alameda Moraes, 246, Rua ao lado do Conselho tutela\nBairro: Praia Grande (Mosqueiro)\nBel√©m - 66914-090",
    "latitude": -1.1424655,
    "longitude": -48.4652878,
    "city": "Bel√©m",
    "zipcode": "66914-090",
    "sequence": 2
  },
  "BR2543386241922": {
    "address": "Alameda Moraes, 246\nBairro: Praia Grande (Mosqueiro)\nBel√©m - 66914-090",
    "latitude": -1.1424655,
    "longitude": -48.4652878,
    "city": "Bel√©m",
    "zipcode": "66914-090",
    "sequence": 3
  },
  "BR257485707468Y": {
    "address": "Alameda Moraes, 246\nBairro: Praia Grande (Mosqueiro)\nBel√©m - 66914-090",
    "latitude": -1.1424655,
    "longitude": -48.4652878,
    "city": "Bel√©m",
    "zipcode": "66914-090",
    "sequence": 4
  },
  "BR2590650161019": {
    "address": "Alameda Petr√≥polis, 42, Casa branca com muro baixinho\nBairro: Praia Grande (Mosqueiro)\nBel√©m - 66914-100",
    "latitude": -1.1432,
    "longitude": -48.4659004,
    "city": "Bel√©m",
    "zipcode": "66914-100",
    "sequence": 5
  },
  "BR259792298200M": {
    "address": "Alameda Ribamar Santos, 15, Ao lado da LR mat. De constru√ß\nBairro: Praia Grande\nBel√©m - 66911-120",
    "latitude": -1.1438776,
    "longitude": -48.4640884,
    "city": "Bel√©m",
    "zipcode": "66911-120",
    "sequence": 6
  },
  "BR255026824340N": {
    "address": "Avenida Beira-Mar - Rua: Dos Escoteiros Pr√≥ximo A Rua: Alameda Moraes, 1657, Condominio prive do farol, Bel√©m, Par√°, 66910150\nBel√©m - 66910150",
    "latitude": -1.1451693,
    "longitude": -48.4655266,
    "city": "Bel√©m",
    "zipcode": "66910150",
    "sequence": 7
  },
  "BR255669520013M": {
    "address": "Passagem S√£o Domingos, 33, Pr√≥ximo √† Rua das Mangueiras\nBairro: Praia Grande (Mosqueiro)\nBel√©m - 66914-080",
    "latitude": -1.1456899,
    "longitude": -48.4648368,
    "city": "Bel√©m",
    "zipcode": "66914-080",
    "sequence": 8
  },
  "BR2532092523217": {
    "address": "Rua Raimundo Cintra, 39, Entre S√£o Domingos e Santa Ter\nBairro: Mangueiras (Mosqueiro)\nBel√©m - 66912-220",
    "latitude": -1.1466,
    "longitude": -48.462101,
    "city": "Bel√©m",
    "zipcode": "66912-220",
    "sequence": 9
  },
  "BR252457049287C": {
    "address": "Rua Raimundo Cintra, 12\nBairro: Mangueiras (Mosqueiro)\nBel√©m - 66912-220",
    "latitude": -1.1470315,
    "longitude": -48.4626465,
    "city": "Bel√©m",
    "zipcode": "66912-220",
    "sequence": 10
  },
  "BR257080667441M": {
    "address": "Passg Santa Rita De Kace, 31\nBairro: Ariramba (Mosqueiro)\nBel√©m - 66914-110",
    "latitude": -1.1463585,
    "longitude": -48.4638905,
    "city": "Bel√©m",
    "zipcode": "66914-110",
    "sequence": 11
  },
  "BR259832570656I": {
    "address": "Passg Santa Rita De Kace, 31\nBairro: Ariramba (Mosqueiro)\nBel√©m - 66914-110",
    "latitude": -1.1463585,
    "longitude": -48.4638905,
    "city": "Bel√©m",
    "zipcode": "66914-110",
    "sequence": 12
  },
  "BR2555419499636": {
    "address": "Passagem Mirim, 2, Av. Beira Mar\nBairro: Praia grande mosqueiro\nBel√©m - 66914-510",
    "latitude": -1.15,
    "longitude": -48.4671,
    "city": "Bel√©m",
    "zipcode": "66914-510",
    "sequence": 13
  },
  "BR2510739661481": {
    "address": "Rua do Carmo, 83, Casa\nBairro: Praia Grande (Mosqueiro)\nBel√©m - 66914-040",
    "latitude": -1.1504477,
    "longitude": -48.4675026,
    "city": "Bel√©m",
    "zipcode": "66914-040",
    "sequence": 14
  },
  "BR256427341903Q": {
    "address": "Rua Quinze de Novembro, 39, Praia grande casa verde\nBairro: Vila (Mosqueiro)\nBel√©m - 66910-000",
    "latitude": -1.1509,
    "longitude": -48.4693985,
    "city": "Bel√©m",
    "zipcode": "66910-000",
    "sequence": 15
  },
  "BR252765984646G": {
    "address": "Rua Quinze de Novembro, 39, Praia grande casa verde\nBairro: Vila (Mosqueiro)\nBel√©m - 66910-000",
    "latitude": -1.1509,
    "longitude": -48.4693985,
    "city": "Bel√©m",
    "zipcode": "66910-000",
    "sequence": 16
  },
  "BR2508214594606": {
    "address": "Alameda Fran√ßa, 33\nBairro: Praia Grande (Mosqueiro)\nBel√©m - 66914-230",
    "latitude": -1.151652,
    "longitude": -48.4677925,
    "city": "Bel√©m",
    "zipcode": "66914-230",
    "sequence": 17
  },
  "BR257708180761F": {
    "address": "Avenida Beira-Mar, 1076, Proximo a barraca carioquinha\nBairro: Vila (Mosqueiro)\nBel√©m - 66910-150",
    "latitude": -1.1522,
    "longitude": -48.4702988,
    "city": "Bel√©m",
    "zipcode": "66910-150",
    "sequence": 18
  },
  "BR2570195095799": {
    "address": "Rua Coronel Jos√© do √ì, 137, Pr√≥ximo a alameda Raimunda\nBairro: Vila (Mosqueiro)\nBel√©m - 66910-010",
    "latitude": -1.1536975,
    "longitude": -48.4707031,
    "city": "Bel√©m",
    "zipcode": "66910-010",
    "sequence": 19
  },
  "BR252206059319K": {
    "address": "Travessa Lauro Sodr√©, 198 a\nBairro: Vila (Mosqueiro)\nBel√©m - 66910-170",
    "latitude": -1.154588,
    "longitude": -48.4708481,
    "city": "Bel√©m",
    "zipcode": "66910-170",
    "sequence": 20
  },
  "BR258463997845D": {
    "address": "Travessa Lauro Sodr√©, 156, Pr√≥ximo ao Hospital Municipal\nBairro: Vila (Mosqueiro)\nBel√©m - 66910-170",
    "latitude": -1.154617,
    "longitude": -48.470768,
    "city": "Bel√©m",
    "zipcode": "66910-170",
    "sequence": 21
  },
  "BR250808162475E": {
    "address": "Travessa Lauro Sodr√©, 235, Ao lado do hospital geral\nBairro: Vila (Mosqueiro)\nBel√©m - 66910-170",
    "latitude": -1.1545,
    "longitude": -48.4700012,
    "city": "Bel√©m",
    "zipcode": "66910-170",
    "sequence": 22
  },
  "BR250622958347D": {
    "address": "Rua Quinze de Novembro, 728\nBairro: Vila (Mosqueiro)\nBel√©m - 66910-000",
    "latitude": -1.1571,
    "longitude": -48.4695015,
    "city": "Bel√©m",
    "zipcode": "66910-000",
    "sequence": 23
  },
  "BR253698799515E": {
    "address": "Rua Quinze de Novembro, 688, Entre o hospital e as 5 bocas\nBairro: Vila (Mosqueiro)\nBel√©m - 66910-000",
    "latitude": -1.1568567,
    "longitude": -48.4692841,
    "city": "Bel√©m",
    "zipcode": "66910-000",
    "sequence": 24
  },
  "BR257375048849G": {
    "address": "Rua Quinze de Novembro, 830\nBairro: Vila (Mosqueiro)\nBel√©m - 66910-000",
    "latitude": -1.1584749,
    "longitude": -48.4690933,
    "city": "Bel√©m",
    "zipcode": "66910-000",
    "sequence": 25
  },
  "BR2570810926273": {
    "address": "Travessa Coronel Jos√© Mota, 263, Proximidade da Av 16 de Novemb\nBairro: Vila (Mosqueiro)\nBel√©m - 66910-680",
    "latitude": -1.1585106,
    "longitude": -48.4683007,
    "city": "Bel√©m",
    "zipcode": "66910-680",
    "sequence": 26
  },
  "BR2589228991775": {
    "address": "Rua Quinze de Novembro, 18, Passagem sao sebastiao\nBairro: Vila (Mosqueiro)\nBel√©m - 66910-000",
    "latitude": -1.1597145,
    "longitude": -48.469059,
    "city": "Bel√©m",
    "zipcode": "66910-000",
    "sequence": 27
  },
  "BR255892110928M": {
    "address": "Rua Quinze de Novembro, 18, Passagem sao sebastiao\nBairro: Vila (Mosqueiro)\nBel√©m - 66910-000",
    "latitude": -1.1597145,
    "longitude": -48.469059,
    "city": "Bel√©m",
    "zipcode": "66910-000",
    "sequence": 28
  },
  "BR254165660090X": {
    "address": "Rua Quinze de Novembro, 18, Ao lado da NutriPets ra√ß√µes\nBairro: Vila (Mosqueiro)\nBel√©m - 66910-000",
    "latitude": -1.1597145,
    "longitude": -48.469059,
    "city": "Bel√©m",
    "zipcode": "66910-000",
    "sequence": 29
  },
  "BR255864217202N": {
    "address": "Rua Quinze de Novembro, 18, Ao lado da NutriPets ra√ß√µes\nBairro: Vila (Mosqueiro)\nBel√©m - 66910-000",
    "latitude": -1.1597145,
    "longitude": -48.469059,
    "city": "Bel√©m",
    "zipcode": "66910-000",
    "sequence": 30
  },
  "BR2559482212905": {
    "address": "Rua Quinze de Novembro, 1021, Entre cinco bocas e Get√∫lio\nBairro: Vila (Mosqueiro)\nBel√©m - 66910-000",
    "latitude": -1.1600853,
    "longitude": -48.4689713,
    "city": "Bel√©m",
    "zipcode": "66910-000",
    "sequence": 31
  },
  "BR257588309119A": {
    "address": "Rua Quinze de Novembro, 121, Pr√≥ximo as cinco bocas\nBairro: Vila (Mosqueiro)\nBel√©m - 66910-000",
    "latitude": -1.1589,
    "longitude": -48.4688988,
    "city": "Bel√©m",
    "zipcode": "66910-000",
    "sequence": 32
  },
  "BR256931637480Z": {
    "address": "Rua Quinze de Novembro, 10, Alemeda terra prometida, Bel√©m, Par√°, 66910000\nBel√©m - 66910000",
    "latitude": -1.1587799,
    "longitude": -48.4689636,
    "city": "Bel√©m",
    "zipcode": "66910000",
    "sequence": 33
  },
  "BR2558435081671": {
    "address": "Avenida Dezesseis de Novembro, 2909, Em frente ao quiosque ki gosto\nBairro: Vila (Mosqueiro)\nBel√©m - 66910-140",
    "latitude": -1.1566,
    "longitude": -48.467701,
    "city": "Bel√©m",
    "zipcode": "66910-140",
    "sequence": 34
  },
  "BR258040408902Y": {
    "address": "Rua Padre Manoel Raiol, 220, Muro amarelo com telhas vermel\nBairro: Vila (Mosqueiro)\nBel√©m - 66910-040",
    "latitude": -1.1570348,
    "longitude": -48.467514,
    "city": "Bel√©m",
    "zipcode": "66910-040",
    "sequence": 35
  },
  "BR257612403013T": {
    "address": "Avenida Dezesseis de Novembro, 72, Em frente dep√≥sito Xavier ao lado Jo√£o motos\nBairro: Vila (Mosqueiro)\nBel√©m - 66910-140",
    "latitude": -1.1532554,
    "longitude": -48.466176,
    "city": "Bel√©m",
    "zipcode": "66910-140",
    "sequence": 36
  },
  "BR258316357232J": {
    "address": "Avenida Dezesseis de Novembro, 72, Em frente dep√≥sito Xavier ao lado Jo√£o motos\nBairro: Vila (Mosqueiro)\nBel√©m - 66910-140",
    "latitude": -1.1532554,
    "longitude": -48.466176,
    "city": "Bel√©m",
    "zipcode": "66910-140",
    "sequence": 37
  },
  "BR2553020039350": {
    "address": "Avenida Dezesseis de Novembro, 72, Em frente dep√≥sito Xavier ao lado Jo√£o motos\nBairro: Vila (Mosqueiro)\nBel√©m - 66910-140",
    "latitude": -1.1532554,
    "longitude": -48.466176,
    "city": "Bel√©m",
    "zipcode": "66910-140",
    "sequence": 38
  },
  "BR257648789028P": {
    "address": "Avenida Dezesseis de Novembro, 72, Em frente dep√≥sito Xavier ao lado Jo√£o motos\nBairro: Vila (Mosqueiro)\nBel√©m - 66910-140",
    "latitude": -1.1532554,
    "longitude": -48.466176,
    "city": "Bel√©m",
    "zipcode": "66910-140",
    "sequence": 39
  },
  "BR258126401029R": {
    "address": "Avenida Dezesseis de Novembro, 72\nBairro: Vila (Mosqueiro)\nBel√©m - 66910-140",
    "latitude": -1.1532554,
    "longitude": -48.466176,
    "city": "Bel√©m",
    "zipcode": "66910-140",
    "sequence": 40
  },
  "BR2531457461885": {
    "address": "Avenida Dezesseis de Novembro, 72, Em frente deposito Xavier ao lado Jo√£o motos\nBairro: Vila (Mosqueiro)\nBel√©m - 66910-140",
    "latitude": -1.1532554,
    "longitude": -48.466176,
    "city": "Bel√©m",
    "zipcode": "66910-140",
    "sequence": 41
  },
  "BR253333999131P": {
    "address": "Avenida Dezesseis de Novembro, 2391, Ao lado da barbearia adryan\nBairro: Vila (Mosqueiro)\nBel√©m - 66910-140",
    "latitude": -1.1524897,
    "longitude": -48.4659386,
    "city": "Bel√©m",
    "zipcode": "66910-140",
    "sequence": 42
  },
  "BR253625124030V": {
    "address": "Passagem Atl√¢ntida, 03, Em frente ao Cantinho Azulino\nBairro: Vila (Mosqueiro)\nBel√©m - 66910-520",
    "latitude": -1.1530946,
    "longitude": -48.4672508,
    "city": "Bel√©m",
    "zipcode": "66910-520",
    "sequence": 43
  },
  "BR257518523148D": {
    "address": "Alameda Ferreira, 28, Ao lado do comercial Ant√¥nio\nBairro: Vila (Mosqueiro)\nBel√©m - 66910-050",
    "latitude": -1.1531883,
    "longitude": -48.466831,
    "city": "Bel√©m",
    "zipcode": "66910-050",
    "sequence": 44
  },
  "BR259312148009G": {
    "address": "Passagem Atl√¢ntida, 03, Ao lado da  antena\nBairro: Vila (Mosqueiro)\nBel√©m - 66910-520",
    "latitude": -1.1530946,
    "longitude": -48.4672508,
    "city": "Bel√©m",
    "zipcode": "66910-520",
    "sequence": 45
  },
  "BR256031024378C": {
    "address": "Alameda Bela Vista, 6, 16 de novembro/ Camilo salgado\nBairro: Vila (Mosqueiro)\nBel√©m - 66910-390",
    "latitude": -1.1538,
    "longitude": -48.4674988,
    "city": "Bel√©m",
    "zipcode": "66910-390",
    "sequence": 46
  },
  "BR252838900075R": {
    "address": "Travessa Bela Vista, 2, Pr√≥ximo ao hospital geral\nBairro: Praia Grande\nBel√©m - 66912-140",
    "latitude": -1.1538016,
    "longitude": -48.4650497,
    "city": "Bel√©m",
    "zipcode": "66912-140",
    "sequence": 47
  },
  "BR250305017276D": {
    "address": "Rua Sandro Carvalho, 68-A, Paquet√°\nBairro: Mangueiras (Mosqueiro)\nBel√©m - 66912-180",
    "latitude": -1.1528,
    "longitude": -48.4622993,
    "city": "Bel√©m",
    "zipcode": "66912-180",
    "sequence": 48
  },
  "BR259426316988F": {
    "address": "Rua Sandro Carvalho, 68-A, Paquet√°\nBairro: Mangueiras (Mosqueiro)\nBel√©m - 66912-180",
    "latitude": -1.1528,
    "longitude": -48.4622993,
    "city": "Bel√©m",
    "zipcode": "66912-180",
    "sequence": 49
  },
  "BR2573946235544": {
    "address": "Rua Bariloche, 30, Casa\nBairro: Mangueiras (Mosqueiro)\nBel√©m - 66912-130",
    "latitude": -1.1523347,
    "longitude": -48.4615555,
    "city": "Bel√©m",
    "zipcode": "66912-130",
    "sequence": 50
  },
  "BR258040312070F": {
    "address": "Rua Bariloche, 30, Casa\nBairro: Mangueiras (Mosqueiro)\nBel√©m - 66912-130",
    "latitude": -1.1523347,
    "longitude": -48.4615555,
    "city": "Bel√©m",
    "zipcode": "66912-130",
    "sequence": 52
  },
  "BR2561235030362": {
    "address": "Alameda Paquet√°, 4, pr√≥ximo ao comercial Caroline\nBairro: Mangueiras (Mosqueiro)\nBel√©m - 66912-210",
    "latitude": -1.1530893,
    "longitude": -48.4613724,
    "city": "Bel√©m",
    "zipcode": "66912-210",
    "sequence": 53
  },
  "BR252010309093W": {
    "address": "Alameda Paquet√°, 4, pr√≥ximo ao comercial Caroline\nBairro: Mangueiras (Mosqueiro)\nBel√©m - 66912-210",
    "latitude": -1.1530893,
    "longitude": -48.4613724,
    "city": "Bel√©m",
    "zipcode": "66912-210",
    "sequence": 54
  },
  "BR2512319420247": {
    "address": "Travessa Santa Helena, O1, Atr√°s da loja Dluna Beach\nBairro: Mangueiras (Mosqueiro)\nBel√©m - 66912-200",
    "latitude": -1.1548012,
    "longitude": -48.4614143,
    "city": "Bel√©m",
    "zipcode": "66912-200",
    "sequence": 55
  },
  "BR254841014012P": {
    "address": "Pra√ßa do carmo, 27, Bar do seu bene\nBairro: Cidade velha\nBel√©m - 66912-230",
    "latitude": -1.1591978,
    "longitude": -48.4569525,
    "city": "Bel√©m",
    "zipcode": "66912-230",
    "sequence": 56
  },
  "BR258670218678R": {
    "address": "Travessa Bela Vista, 87\nBairro: Mangueiras (Mosqueiro)\nBel√©m - 66912-140",
    "latitude": -1.1542,
    "longitude": -48.4594002,
    "city": "Bel√©m",
    "zipcode": "66912-140",
    "sequence": 57
  },
  "BR254442724443V": {
    "address": "Alameda Paquet√°, 900, Final do asfalto lado direito\nBairro: Mangueiras (Mosqueiro)\nBel√©m - 66912-210",
    "latitude": -1.1533793,
    "longitude": -48.4588051,
    "city": "Bel√©m",
    "zipcode": "66912-210",
    "sequence": 58
  },
  "BR257300548797C": {
    "address": "Rua Bahamas, 26\nBairro: Mangueiras (Mosqueiro)\nBel√©m - 66912-120",
    "latitude": -1.1521145,
    "longitude": -48.4601555,
    "city": "Bel√©m",
    "zipcode": "66912-120",
    "sequence": 59
  },
  "BR255604031541B": {
    "address": "Alameda do Carmo, 33, Pr√≥ximo a igreja Reis dos Reis\nBairro: Mangueiras (Mosqueiro)\nBel√©m - 66912-230",
    "latitude": -1.1513,
    "longitude": -48.4594002,
    "city": "Bel√©m",
    "zipcode": "66912-230",
    "sequence": 60
  },
  "BR258852981488Q": {
    "address": "Rua Nova, 255\nBairro: Mangueiras (Mosqueiro)\nBel√©m - 66912-080",
    "latitude": -1.1500554,
    "longitude": -48.461853,
    "city": "Bel√©m",
    "zipcode": "66912-080",
    "sequence": 61
  },
  "BR2530998956863": {
    "address": "Avenida Camilo Salgado Filho, 612, Centro Educacional L√°pis na M√£\nBairro: Mangueiras (Mosqueiro)\nBel√©m - 66912-250",
    "latitude": -1.1501131,
    "longitude": -48.4624329,
    "city": "Bel√©m",
    "zipcode": "66912-250",
    "sequence": 62
  },
  "BR2556101372242": {
    "address": "Rua do Carmo, 26\nBairro: Praia Grande (Mosqueiro)\nBel√©m - 66914-040",
    "latitude": -1.151163,
    "longitude": -48.4636841,
    "city": "Bel√©m",
    "zipcode": "66914-040",
    "sequence": 63
  },
  "BR257690813744P": {
    "address": "Rua Raimundo Cintra, 33, Atraz da panificadora Martinez\nBairro: Mangueiras (Mosqueiro)\nBel√©m - 66912-220",
    "latitude": -1.1497903,
    "longitude": -48.4638405,
    "city": "Bel√©m",
    "zipcode": "66912-220",
    "sequence": 64
  },
  "BR251048356165R": {
    "address": "Rua Bariloche, 17, Acesso pela sta terezinha\nBairro: Mangueiras (Mosqueiro)\nBel√©m - 66912-130",
    "latitude": -1.1482842,
    "longitude": -48.4596596,
    "city": "Bel√©m",
    "zipcode": "66912-130",
    "sequence": 65
  },
  "BR251297883486O": {
    "address": "Rua Bariloche, 17, Acesso pela rua santa Terezinh\nBairro: Mangueiras (Mosqueiro)\nBel√©m - 66912-130",
    "latitude": -1.1482842,
    "longitude": -48.4596596,
    "city": "Bel√©m",
    "zipcode": "66912-130",
    "sequence": 66
  },
  "BR2502916709275": {
    "address": "Ria nova, 195\nBairro: Mangueiras (Mosqueiro)\nBel√©m - 66912-060",
    "latitude": -1.1469001,
    "longitude": -48.4600983,
    "city": "Bel√©m",
    "zipcode": "66912-060",
    "sequence": 67
  },
  "BR250880859719J": {
    "address": "Avenida Principal, 14, Rua ao lado do varej√£o do cime\nBairro: Mangueiras (Mosqueiro)\nBel√©m - 66912-040",
    "latitude": -1.1448848,
    "longitude": -48.4607849,
    "city": "Bel√©m",
    "zipcode": "66912-040",
    "sequence": 68
  },
  "BR258628300510C": {
    "address": "Avenida Principal, 14, Rua ao lado do varej√£o do cime\nBairro: Mangueiras (Mosqueiro)\nBel√©m - 66912-040",
    "latitude": -1.1448848,
    "longitude": -48.4607849,
    "city": "Bel√©m",
    "zipcode": "66912-040",
    "sequence": 69
  },
  "BR257630269023H": {
    "address": "Avenida Principal, 14, Rua ao lado do varej√£o do cime\nBairro: Mangueiras (Mosqueiro)\nBel√©m - 66912-040",
    "latitude": -1.1448848,
    "longitude": -48.4607849,
    "city": "Bel√©m",
    "zipcode": "66912-040",
    "sequence": 70
  },
  "BR252728742822U": {
    "address": "Alameda Teres√≥polis, 182, Rua da creche\nBairro: Mangueiras (Mosqueiro)\nBel√©m - 66912-060",
    "latitude": -1.143436,
    "longitude": -48.4600372,
    "city": "Bel√©m",
    "zipcode": "66912-060",
    "sequence": 71
  },
  "BR255642613681K": {
    "address": "Alameda Petr√≥polis, 1000, Casa amarela con rosa\nBairro: Praia Grande (Mosqueiro)\nBel√©m - 66914-100",
    "latitude": -1.1434402,
    "longitude": -48.4619141,
    "city": "Bel√©m",
    "zipcode": "66914-100",
    "sequence": 72
  },
  "BR251146466899J": {
    "address": "Avenida Dezesseis de Novembro, 1220, Mundo dos colch√µes ao lado do\nBairro: Vila (Mosqueiro)\nBel√©m - 66910-140",
    "latitude": -1.1423743,
    "longitude": -48.461216,
    "city": "Bel√©m",
    "zipcode": "66910-140",
    "sequence": 73
  },
  "BR256373097735V": {
    "address": "Avenida Dezesseis de Novembro, 1220, Mundo dos colch√µes ao lado do\nBairro: Vila (Mosqueiro)\nBel√©m - 66910-140",
    "latitude": -1.1423743,
    "longitude": -48.461216,
    "city": "Bel√©m",
    "zipcode": "66910-140",
    "sequence": 74
  }
};
</script>

<!-- Google Maps -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyApaDb9rSw2sNTaY7fjBqmrgjWYD9xwjcU&loading=async&callback=initMap&v=beta&libraries=places,geometry,marker"></script>

<script>
let map;
let is3D = false;
let userLocationMarker = null;
let watchId = null;
let _animating3D = false;
let locationAccuracy = null;
let deliveryMarkers = {}; // Armazena marcadores de endere√ßos de entrega
let directionsService = null; // Servi√ßo de rotas do Google Maps
let directionsRenderer = null; // Renderizador de rotas
let routeMode = false; // Modo de planejamento de rota ativo/inativo
let lastPositionUpdate = 0; // Timestamp da √∫ltima atualiza√ß√£o de posi√ß√£o
let updateThrottle = 200; // Atualizar posi√ß√£o no m√°ximo a cada 200ms (mais fluido)
let lastKnownPosition = null; // √öltima posi√ß√£o conhecida para interpola√ß√£o
let currentInfoWindow = null; // InfoWindow atualmente aberta

// IMPORTANTE: Inicializar array de polylines globalmente
if (!window.routePolylines) {
    window.routePolylines = [];
}

const MAP_ID = "ebb7ca4503045feabc75b373";

// IMPORTANTE: Substitua pelo seu Project ID do Google Cloud Platform
// Encontre em: https://console.cloud.google.com/ ‚Üí Configura√ß√µes do projeto
const GOOGLE_CLOUD_PROJECT_ID = "mapas-clientes-479801"; // ‚úÖ Configurado!
const GOOGLE_MAPS_API_KEY = "AIzaSyApaDb9rSw2sNTaY7fjBqmrgjWYD9xwjcU"; // API Key para Fleet Routing

// ===========================
// SISTEMA DE NOTIFICA√á√ïES
// ===========================

function showToast(title, message, type = 'info', duration = 4000) {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;

    const icons = {
        success: '‚úì',
        error: '‚úï',
        warning: '‚ö†',
        info: '‚Ñπ'
    };

    toast.innerHTML = `
        <div class="toast-icon">${icons[type] || icons.info}</div>
        <div class="toast-content">
            <div class="toast-title">${title}</div>
            ${message ? `<div class="toast-message">${message}</div>` : ''}
        </div>
    `;

    container.appendChild(toast);

    setTimeout(() => {
        toast.classList.add('hiding');
        setTimeout(() => toast.remove(), 300);
    }, duration);
}

function updateLoadingScreen(text, subtext) {
    document.getElementById('loading-text').textContent = text;
    document.getElementById('loading-subtext').textContent = subtext;
}

function hideLoadingScreen() {
    const loadingScreen = document.getElementById('loading-screen');
    const mapElement = document.getElementById('map');
    const controls = document.querySelector('.map-control');

    loadingScreen.classList.add('hidden');
    mapElement.classList.add('loaded');
    controls.classList.add('visible');

    setTimeout(() => {
        document.getElementById('status-bar').classList.add('visible');
    }, 500);
}

function updateStatus(text, active = true) {
    document.getElementById('status-text').textContent = text;
    const indicator = document.getElementById('status-indicator');

    if (active) {
        indicator.classList.remove('inactive');
    } else {
        indicator.classList.add('inactive');
    }
}

// ===========================
// INICIALIZA√á√ÉO DO MAPA
// ===========================

window.initMap = function () {
    console.log('Iniciando mapa...');
    updateLoadingScreen('Carregando mapa...', 'Preparando visualiza√ß√£o');

    try {
        map = new google.maps.Map(document.getElementById("map"), {
            center: {lat: -23.5505, lng: -46.6333},
            zoom: 17,
            mapId: MAP_ID,
            tilt: 0,
            heading: 0,
            gestureHandling: "greedy",
            rotateControl: true,
            zoomControl: true,
            streetViewControl: false,
            fullscreenControl: false, // Desabilitar fullscreen para performance
            mapTypeControl: false, // Desabilitar controle de tipo de mapa
            scaleControl: false, // Desabilitar escala
            // Otimiza√ß√µes de performance para multim√≠dia de carro
            disableDefaultUI: false,
            clickableIcons: false, // Desabilita cliques em POIs
            disableDoubleClickZoom: false,
            draggable: true,
            scrollwheel: true,
            minZoom: 10, // Limitar zoom m√≠nimo para menos detalhes
            maxZoom: 20, // Limitar zoom m√°ximo para melhor performance
            // Otimiza√ß√µes de renderiza√ß√£o
            renderingType: 'RASTER', // Usar renderiza√ß√£o raster (mais leve que VECTOR)
            // Reduzir detalhes do mapa
            styles: [
                {
                    featureType: "poi",
                    elementType: "labels",
                    stylers: [{ visibility: "off" }] // Ocultar labels de POIs
                },
                {
                    featureType: "transit",
                    elementType: "labels",
                    stylers: [{ visibility: "off" }] // Ocultar labels de transporte
                }
            ]
        });

        // Inicializar servi√ßos de rota
        directionsService = new google.maps.DirectionsService();
        directionsRenderer = new google.maps.DirectionsRenderer({
            map: map,
            suppressMarkers: false, // N√£o suprimir marcadores (A, B, C, etc.)
            polylineOptions: {
                strokeColor: '#4285f4',
                strokeWeight: 5,
                strokeOpacity: 0.7
            }
        });

        // Otimiza√ß√µes adicionais para performance em multim√≠dia de carro
        // Debounce para eventos de drag (arrasto) - melhora fluidez
        let dragTimeout;
        map.addListener('dragstart', () => {
            if (dragTimeout) clearTimeout(dragTimeout);
        });

        map.addListener('drag', () => {
            if (dragTimeout) clearTimeout(dragTimeout);
            dragTimeout = setTimeout(() => {
                // For√ßa renderiza√ß√£o ap√≥s arrasto parar
                google.maps.event.trigger(map, 'resize');
            }, 100);
        });

        // Fechar InfoWindow ao clicar no mapa (fora dos marcadores)
        map.addListener('click', () => {
            if (currentInfoWindow) {
                currentInfoWindow.close();
                currentInfoWindow = null;
            }
        });

        // Desabilitar anima√ß√µes em zoom para melhor performance
        map.addListener('zoom_changed', () => {
            if (dragTimeout) clearTimeout(dragTimeout);
        });

        console.log('Mapa criado, aguardando tiles...');

        // Timeout de seguran√ßa: se o mapa n√£o carregar em 15s, for√ßa o in√≠cio do tracking
        const safetyTimeout = setTimeout(() => {
            console.warn('Timeout: for√ßando in√≠cio do tracking de localiza√ß√£o');
            updateLoadingScreen('Obtendo sua localiza√ß√£o...', 'Ative o GPS para melhor precis√£o');
            startLocationTracking();
        }, 15000);

        // Espera o mapa carregar completamente
        google.maps.event.addListenerOnce(map, 'tilesloaded', () => {
            clearTimeout(safetyTimeout);
            console.log('Tiles carregados, iniciando tracking...');
            updateLoadingScreen('Obtendo sua localiza√ß√£o...', 'Ative o GPS para melhor precis√£o');
            startLocationTracking();
        });
    } catch (error) {
        console.error('Erro ao criar mapa:', error);
        hideLoadingScreen();
        showToast('Erro ao inicializar mapa', error.message, 'error', 8000);
    }
}

// ===========================
// RASTREAMENTO EM TEMPO REAL
// ===========================

function startLocationTracking() {
    console.log('Iniciando rastreamento de localiza√ß√£o...');

    if (!navigator.geolocation) {
        console.error('Geolocaliza√ß√£o n√£o suportada');
        hideLoadingScreen();
        showToast('GPS n√£o suportado', 'Seu navegador n√£o suporta geolocaliza√ß√£o', 'error', 6000);
        updateStatus('GPS indispon√≠vel', false);
        return;
    }

    const markerDiv = document.createElement('div');
    markerDiv.className = 'location-marker active';

    const geoOptions = {
        enableHighAccuracy: true, // M√°xima precis√£o do GPS
        timeout: 15000, // Timeout aumentado para 15s
        maximumAge: 0 // Sempre buscar posi√ß√£o atualizada (sem cache)
    };

    console.log('Solicitando posi√ß√£o do GPS...');
    navigator.geolocation.getCurrentPosition(
        pos => {
            try {
                console.log('Posi√ß√£o obtida:', pos.coords.latitude, pos.coords.longitude);
                const c = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                locationAccuracy = pos.coords.accuracy;

                map.setCenter(c);
                map.setZoom(17);

                // Tenta usar AdvancedMarkerElement (recomendado pelo Google desde 2024)
                if (google.maps.marker && google.maps.marker.AdvancedMarkerElement) {
                    console.log('Criando AdvancedMarkerElement...');
                    userLocationMarker = new google.maps.marker.AdvancedMarkerElement({
                        map,
                        position: c,
                        content: markerDiv,
                        title: "Sua Localiza√ß√£o"
                    });
                    console.log('AdvancedMarkerElement criado com sucesso');
                } else {
                    // Fallback para Marker cl√°ssico se AdvancedMarker n√£o estiver dispon√≠vel
                    console.warn('AdvancedMarkerElement n√£o dispon√≠vel, usando Marker cl√°ssico');
                    userLocationMarker = new google.maps.Marker({
                        map,
                        position: c,
                        title: "Sua Localiza√ß√£o",
                        icon: {
                            path: google.maps.SymbolPath.CIRCLE,
                            scale: 8,
                            fillColor: "#4285f4",
                            fillOpacity: 1,
                            strokeColor: "white",
                            strokeWeight: 3
                        }
                    });
                    console.log('Marker cl√°ssico criado com sucesso');
                }

                console.log('Escondendo loading screen...');
                hideLoadingScreen();
                showAddClientButton(); // Mostrar bot√£o adicionar cliente

                // N√ÉO adicionar marcadores automaticamente
                // Eles ser√£o adicionados apenas quando o usu√°rio ativar o modo de rota
            } catch (error) {
                console.error('Erro ao criar marcador:', error);
                hideLoadingScreen();
                showToast('Erro ao criar marcador', error.message, 'error', 6000);
            }

            showToast(
                'Localiza√ß√£o obtida!',
                `Precis√£o: ${Math.round(locationAccuracy)}m`,
                'success',
                3000
            );

            updateStatus(`Precis√£o: ${Math.round(locationAccuracy)}m`, true);

            watchId = navigator.geolocation.watchPosition(
                updateUserLocation,
                handleGeoError,
                geoOptions
            );
        },
        error => {
            hideLoadingScreen();
            handleGeoError(error, true);
        },
        geoOptions
    );
}

function updateUserLocation(position) {
    // Throttle: atualizar apenas a cada X milissegundos (performance)
    const now = Date.now();
    if (now - lastPositionUpdate < updateThrottle) {
        return; // Ignora updates muito frequentes
    }
    lastPositionUpdate = now;

    const newPos = {
        lat: position.coords.latitude,
        lng: position.coords.longitude
    };

    if (!userLocationMarker) return;

    try {
        // Interpola√ß√£o suave entre posi√ß√µes para movimento fluido
        if (lastKnownPosition) {
            // Calcular dist√¢ncia entre posi√ß√µes
            const latDiff = newPos.lat - lastKnownPosition.lat;
            const lngDiff = newPos.lng - lastKnownPosition.lng;
            const distance = Math.sqrt(latDiff * latDiff + lngDiff * lngDiff);

            // Se movimento muito pequeno (< 0.00001 graus ‚âà 1 metro), ignorar para evitar "tremor"
            if (distance < 0.00001) {
                return;
            }

            // Anima√ß√£o suave com interpola√ß√£o (easing)
            const steps = 10; // N√∫mero de passos da anima√ß√£o
            const stepDelay = updateThrottle / steps; // Delay entre cada passo
            let currentStep = 0;

            const animate = () => {
                if (currentStep >= steps) {
                    lastKnownPosition = newPos;
                    return;
                }

                currentStep++;
                const progress = currentStep / steps;

                // Easing function (easeOutQuad) para movimento mais natural
                const easeProgress = 1 - (1 - progress) * (1 - progress);

                const interpolatedPos = {
                    lat: lastKnownPosition.lat + (latDiff * easeProgress),
                    lng: lastKnownPosition.lng + (lngDiff * easeProgress)
                };

                // Atualizar posi√ß√£o do marcador
                if (userLocationMarker.position !== undefined) {
                    userLocationMarker.position = interpolatedPos;
                } else if (userLocationMarker.setPosition) {
                    userLocationMarker.setPosition(interpolatedPos);
                }

                setTimeout(animate, stepDelay);
            };

            animate();
        } else {
            // Primeira atualiza√ß√£o, sem interpola√ß√£o
            if (userLocationMarker.position !== undefined) {
                userLocationMarker.position = newPos;
            } else if (userLocationMarker.setPosition) {
                userLocationMarker.setPosition(newPos);
            }
            lastKnownPosition = newPos;
        }

        // Atualiza precis√£o
        locationAccuracy = position.coords.accuracy;
        updateStatus(`Precis√£o: ${Math.round(locationAccuracy)}m`, true);

        // Log para debug (opcional)
        if (position.coords.speed !== null && position.coords.speed > 0) {
            console.log(`Velocidade: ${Math.round(position.coords.speed * 3.6)} km/h`);
        }

    } catch (error) {
        console.error('Erro ao atualizar posi√ß√£o do marcador:', error);
    }
}

function handleGeoError(error, isInitial = false) {
    console.warn("Erro de geolocaliza√ß√£o:", error);

    let errorTitle = 'Erro de GPS';
    let errorMessage = '';

    switch(error.code) {
        case error.PERMISSION_DENIED:
            errorTitle = 'Permiss√£o negada';
            errorMessage = 'Por favor, permita o acesso √† localiza√ß√£o';
            break;
        case error.POSITION_UNAVAILABLE:
            errorTitle = 'Localiza√ß√£o indispon√≠vel';
            errorMessage = 'N√£o foi poss√≠vel obter sua posi√ß√£o';
            break;
        case error.TIMEOUT:
            errorTitle = 'Tempo esgotado';
            errorMessage = 'A solicita√ß√£o demorou muito. Tentando novamente...';
            break;
        default:
            errorMessage = 'Erro desconhecido ao obter localiza√ß√£o';
    }

    showToast(errorTitle, errorMessage, 'error', 6000);
    updateStatus('GPS com erro', false);

    if (isInitial) {
        map.setCenter({ lat: -23.5505, lng: -46.6333 });
    }
}

// ===========================
// MARCADORES DE ENTREGAS
// ===========================

// Fun√ß√£o auxiliar para criar SVG de pin do Google Maps com n√∫mero (suporta 1-99)
function createPinSVG(number) {
    // Ajustar tamanho da fonte baseado no n√∫mero de d√≠gitos
    const fontSize = number >= 10 ? '11' : '13';

    // SVG do pin do Google Maps (formato teardrop/gota invertida)
    const svg = `
        <svg width="32" height="44" viewBox="0 0 32 44" xmlns="http://www.w3.org/2000/svg">
            <!-- Sombra -->
            <ellipse cx="16" cy="42" rx="6.5" ry="2" fill="rgba(0,0,0,0.35)"/>

            <!-- Pin vermelho com gradiente sutil -->
            <defs>
                <linearGradient id="pinGradient${number}" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color:#EA4335;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#C5221F;stop-opacity:1" />
                </linearGradient>
            </defs>
            <path d="M16 0 C7.164 0 0 7.164 0 16 C0 28 16 44 16 44 S32 28 32 16 C32 7.164 24.836 0 16 0 Z"
                  fill="url(#pinGradient${number})"
                  stroke="#FFFFFF"
                  stroke-width="2"/>

            <!-- C√≠rculo branco interno maior -->
            <circle cx="16" cy="16" r="10" fill="#FFFFFF"/>

            <!-- Sombra interna sutil no c√≠rculo -->
            <circle cx="16" cy="16" r="10" fill="none" stroke="rgba(0,0,0,0.08)" stroke-width="0.5"/>

            <!-- N√∫mero com contorno para melhor legibilidade -->
            <text x="16" y="17"
                  text-anchor="middle"
                  dominant-baseline="central"
                  font-family="'Arial Black', Arial, sans-serif"
                  font-size="${fontSize}"
                  font-weight="900"
                  fill="#EA4335"
                  stroke="#FFFFFF"
                  stroke-width="0.8"
                  paint-order="stroke">${number}</text>
        </svg>
    `;

    return 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(svg);
}

async function addDeliveryMarkers() {
    console.log('üîµ Adicionando marcadores de entrega...');

    // PASSO 1: Remover TODOS os marcadores anteriores
    const markerCount = Object.keys(deliveryMarkers).length;
    if (markerCount > 0) {
        console.log(`üóëÔ∏è Removendo ${markerCount} marcadores anteriores...`);
        Object.values(deliveryMarkers).forEach(marker => {
            try {
                if (marker.map !== undefined) {
                    marker.map = null; // AdvancedMarkerElement
                } else if (marker.setMap) {
                    marker.setMap(null); // Marker cl√°ssico
                }
            } catch (e) {
                console.warn('Erro ao remover marcador:', e);
            }
        });
    }

    // PASSO 2: Resetar objeto completamente
    deliveryMarkers = {};

    // PASSO 3: Buscar dados da planilha (delivery_data) do Supabase
    let deliveryData = [];
    try {
        const { data, error } = await supabase
            .from('delivery_data')
            .select('*')
            .order('sequence', { ascending: true });

        if (error) throw error;
        deliveryData = data || [];
    } catch (error) {
        console.error('Erro ao buscar delivery_data:', error);
        showToast(
            'Erro ao carregar dados',
            'N√£o foi poss√≠vel buscar os dados da planilha',
            'error',
            4000
        );
        return;
    }

    if (deliveryData.length === 0) {
        console.log('‚ö†Ô∏è Nenhum dado encontrado na planilha');
        showToast(
            'Nenhuma entrega encontrada',
            'Fa√ßa upload de uma planilha para planejar rotas',
            'warning',
            4000
        );
        return;
    }

    // PASSO 4: Agrupar entregas por coordenadas (endere√ßo)
    const groupedByLocation = {};

    deliveryData.forEach((delivery) => {
        if (!delivery.latitude || !delivery.longitude) {
            console.warn(`Entrega ${delivery.spx_tn} n√£o tem coordenadas v√°lidas`);
            return;
        }

        const coordKey = `${delivery.latitude.toFixed(6)},${delivery.longitude.toFixed(6)}`;
        if (!groupedByLocation[coordKey]) {
            groupedByLocation[coordKey] = {
                position: { lat: delivery.latitude, lng: delivery.longitude },
                address: delivery.destination_address,
                bairro: delivery.bairro,
                city: delivery.city,
                zipcode: delivery.zipcode,
                deliveries: []
            };
        }
        groupedByLocation[coordKey].deliveries.push({
            id: delivery.id,
            spx_tn: delivery.spx_tn,
            sequence: delivery.sequence || groupedByLocation[coordKey].deliveries.length + 1,
            destination_address: delivery.destination_address
        });
    });

    console.log(`üì¶ Total de entregas: ${deliveryData.length}`);
    console.log(`üìç Locais √∫nicos (paradas): ${Object.keys(groupedByLocation).length}`);

    let markerNumber = 1; // Contador para numera√ß√£o sequencial
    const bounds = new google.maps.LatLngBounds();

    // Criar um marcador para cada local √∫nico
    Object.entries(groupedByLocation).forEach(([coordKey, locationData]) => {
        const position = locationData.position;
        const deliveryCount = locationData.deliveries.length;

        // Criar elemento do marcador com pin estilo Google Maps
        const markerDiv = document.createElement('div');
        markerDiv.style.cursor = 'pointer';
        markerDiv.style.transition = 'transform 0.2s';

        // Criar imagem do pin com n√∫mero de entregas
        const pinImg = document.createElement('img');
        pinImg.src = createPinSVG(deliveryCount);
        pinImg.style.width = '32px';
        pinImg.style.height = '44px';
        pinImg.style.display = 'block';

        markerDiv.appendChild(pinImg);

        // Efeito hover
        markerDiv.addEventListener('mouseenter', () => {
            markerDiv.style.transform = 'scale(1.15)';
        });
        markerDiv.addEventListener('mouseleave', () => {
            markerDiv.style.transform = 'scale(1)';
        });

        // Criar InfoWindow customizada mostrando todas as entregas
        const infoWindowContent = document.createElement('div');
        infoWindowContent.style.padding = '8px';
        infoWindowContent.style.maxWidth = '250px';
        infoWindowContent.style.maxHeight = '300px';
        infoWindowContent.style.overflowY = 'auto';

        const headerDiv = document.createElement('div');
        headerDiv.style.display = 'flex';
        headerDiv.style.justifyContent = 'space-between';
        headerDiv.style.alignItems = 'center';
        headerDiv.style.marginBottom = '8px';

        const titleDiv = document.createElement('div');
        titleDiv.style.fontWeight = 'bold';
        titleDiv.style.color = '#EA4335';
        titleDiv.textContent = `üìç ${deliveryCount} entrega${deliveryCount > 1 ? 's' : ''}`;

        const closeBtn = document.createElement('button');
        closeBtn.innerHTML = '√ó';
        closeBtn.style.background = 'none';
        closeBtn.style.border = 'none';
        closeBtn.style.fontSize = '20px';
        closeBtn.style.color = '#666';
        closeBtn.style.cursor = 'pointer';
        closeBtn.style.padding = '0';
        closeBtn.style.marginLeft = '12px';
        closeBtn.style.lineHeight = '1';
        closeBtn.style.fontWeight = 'normal';
        closeBtn.title = 'Fechar';
        closeBtn.addEventListener('click', () => {
            infoWindow.close();
            currentInfoWindow = null;
        });

        headerDiv.appendChild(titleDiv);
        headerDiv.appendChild(closeBtn);
        infoWindowContent.appendChild(headerDiv);

        // Adicionar informa√ß√µes do endere√ßo (parada)
        const addressInfoDiv = document.createElement('div');
        addressInfoDiv.style.fontSize = '12px';
        addressInfoDiv.style.color = '#333';
        addressInfoDiv.style.lineHeight = '1.5';
        addressInfoDiv.style.marginBottom = '10px';
        addressInfoDiv.style.padding = '8px';
        addressInfoDiv.style.background = '#f5f5f5';
        addressInfoDiv.style.borderRadius = '4px';

        let fullAddress = locationData.address || '';
        if (locationData.bairro) fullAddress += `\nBairro: ${locationData.bairro}`;
        if (locationData.city && locationData.zipcode) fullAddress += `\n${locationData.city} - ${locationData.zipcode}`;

        addressInfoDiv.innerHTML = fullAddress.replace(/\n/g, '<br>');
        infoWindowContent.appendChild(addressInfoDiv);

        // T√≠tulo da lista de pacotes
        const packagesTitle = document.createElement('div');
        packagesTitle.style.fontWeight = 'bold';
        packagesTitle.style.fontSize = '11px';
        packagesTitle.style.color = '#666';
        packagesTitle.style.marginBottom = '6px';
        packagesTitle.textContent = `${deliveryCount} pacote${deliveryCount > 1 ? 's' : ''} nesta parada:`;
        infoWindowContent.appendChild(packagesTitle);

        // Adicionar cada pacote (QR code) √† InfoWindow
        locationData.deliveries.forEach((delivery, index) => {
            const deliveryDiv = document.createElement('div');
            deliveryDiv.style.fontSize = '11px';
            deliveryDiv.style.color = '#333';
            deliveryDiv.style.lineHeight = '1.4';
            deliveryDiv.style.marginBottom = '4px';
            deliveryDiv.style.paddingBottom = '4px';
            deliveryDiv.style.paddingLeft = '8px';

            if (index < locationData.deliveries.length - 1) {
                deliveryDiv.style.borderBottom = '1px solid #eee';
            }

            // Linha com Ordem e C√≥digo QR
            const qrDiv = document.createElement('div');
            qrDiv.style.display = 'flex';
            qrDiv.style.justifyContent = 'space-between';
            qrDiv.style.alignItems = 'center';
            qrDiv.style.gap = '8px';

            const sequenceSpan = document.createElement('span');
            sequenceSpan.style.color = '#EA4335';
            sequenceSpan.style.fontWeight = 'bold';
            sequenceSpan.textContent = `Ordem: ${delivery.sequence}`;

            const qrSpan = document.createElement('span');
            qrSpan.style.fontSize = '10px';
            qrSpan.style.color = '#666';
            qrSpan.style.fontFamily = 'monospace';
            qrSpan.textContent = delivery.spx_tn;

            qrDiv.appendChild(sequenceSpan);
            qrDiv.appendChild(qrSpan);

            deliveryDiv.appendChild(qrDiv);
            infoWindowContent.appendChild(deliveryDiv);
        });

        const infoWindow = new google.maps.InfoWindow({
            content: infoWindowContent,
            maxWidth: 280,
            disableAutoPan: false
        });

        try {
            // Criar marcador usando AdvancedMarkerElement (preferencial)
            if (google.maps.marker && google.maps.marker.AdvancedMarkerElement) {
                const marker = new google.maps.marker.AdvancedMarkerElement({
                    map,
                    position,
                    content: markerDiv,
                    title: `${deliveryCount} entrega${deliveryCount > 1 ? 's' : ''} neste local`
                });

                // Adicionar listener de clique no marcador
                marker.addListener('click', () => {
                    // Fechar InfoWindow anterior se existir
                    if (currentInfoWindow) {
                        currentInfoWindow.close();
                    }

                    // Abrir nova InfoWindow
                    infoWindow.open(map, marker);
                    currentInfoWindow = infoWindow;

                    // Centralizar mapa suavemente
                    map.panTo(position);
                });

                // Armazenar o marcador com a chave da coordenada
                deliveryMarkers[coordKey] = marker;
            } else {
                // Fallback: usar Marker cl√°ssico com √≠cone SVG
                const marker = new google.maps.Marker({
                    map,
                    position,
                    title: `${deliveryCount} entrega${deliveryCount > 1 ? 's' : ''} neste local`,
                    icon: {
                        url: createPinSVG(deliveryCount),
                        scaledSize: new google.maps.Size(32, 44),
                        anchor: new google.maps.Point(16, 44) // Ancorar na ponta do pin
                    }
                });

                // Adicionar listener de clique
                marker.addListener('click', () => {
                    // Fechar InfoWindow anterior se existir
                    if (currentInfoWindow) {
                        currentInfoWindow.close();
                    }

                    // Abrir nova InfoWindow
                    infoWindow.open(map, marker);
                    currentInfoWindow = infoWindow;

                    // Centralizar mapa suavemente
                    map.panTo(position);
                });

                // Armazenar o marcador com a chave da coordenada
                deliveryMarkers[coordKey] = marker;
            }

            // Adicionar posi√ß√£o aos bounds
            bounds.extend(position);

            markerNumber++; // Incrementar contador (n√£o usado mais, mas mantido para compatibilidade)
        } catch (error) {
            console.error('Erro ao criar marcador de entrega:', error);
        }
    });

    console.log(`‚úÖ Total: ${Object.keys(deliveryMarkers).length} marcadores criados para ${Object.keys(addressDatabase).length} entregas`);

    // Ajustar mapa para mostrar todos os marcadores
    if (!bounds.isEmpty()) {
        map.fitBounds(bounds, {
            padding: 80 // Adicionar margem de 80px ao redor
        });
        console.log('üó∫Ô∏è Mapa ajustado para mostrar todos os marcadores');
    }
}

// ===========================
// ANIMA√á√ÉO 2D ‚áÑ 3D
// ===========================

function animateValue(start, end, duration, onUpdate, onFinish) {
    const startTime = performance.now();
    let frameCount = 0;

    function frame(time) {
        const progress = Math.min((time - startTime) / duration, 1);

        // Easing function para anima√ß√£o mais suave (easeInOutCubic)
        const eased = progress < 0.5
            ? 4 * progress * progress * progress
            : 1 - Math.pow(-2 * progress + 2, 3) / 2;

        const value = start + (end - start) * eased;

        // Limitar updates para 60fps m√°ximo
        frameCount++;
        if (frameCount % 1 === 0) { // Atualiza a cada frame
            onUpdate(value);
        }

        if (progress < 1) {
            requestAnimationFrame(frame);
        } else {
            onUpdate(end); // Garantir valor final exato
            if (onFinish) onFinish();
        }
    }

    requestAnimationFrame(frame);
}

document.getElementById("btnToggle3D").onclick = () => {
    const btn = document.getElementById("btnToggle3D");

    if (_animating3D) return;
    _animating3D = true;

    btn.classList.add('loading');
    btn.disabled = true;

    if (!is3D) {
        is3D = true;

        animateValue(map.getTilt(), 67, 600, val => map.setTilt(val));
        animateValue(map.getHeading(), 45, 600, val => map.setHeading(val), () => {
            _animating3D = false;
            btn.classList.remove('loading');
            btn.classList.add('active');
            btn.textContent = "2D";
            btn.disabled = false;
            showToast('Modo 3D ativado', 'Arraste para rotacionar', 'success', 2000);
        });

    } else {
        is3D = false;

        animateValue(map.getTilt(), 0, 600, val => map.setTilt(val));
        animateValue(map.getHeading(), 0, 600, val => map.setHeading(val), () => {
            _animating3D = false;
            btn.classList.remove('loading', 'active');
            btn.textContent = "3D";
            btn.disabled = false;
            showToast('Modo 2D ativado', '', 'success', 2000);
        });
    }
};

// ===========================
// CENTRALIZAR LOCALIZA√á√ÉO
// ===========================

document.getElementById("btnCenterLocation").onclick = () => {
    const btn = document.getElementById("btnCenterLocation");

    if (!userLocationMarker) {
        showToast('Localiza√ß√£o n√£o dispon√≠vel', 'Aguarde obter sua posi√ß√£o GPS', 'warning', 3000);
        return;
    }

    // Pega a posi√ß√£o atual do marcador (compat√≠vel com ambos os tipos)
    let currentPosition;
    if (userLocationMarker.position) {
        currentPosition = userLocationMarker.position;
    } else if (userLocationMarker.getPosition) {
        currentPosition = userLocationMarker.getPosition();
    }

    if (!currentPosition) {
        showToast('Erro ao centralizar', 'Posi√ß√£o n√£o encontrada', 'error', 3000);
        return;
    }

    // Feedback visual no bot√£o
    btn.classList.add('loading');
    btn.disabled = true;

    // Anima o zoom e centraliza
    map.panTo(currentPosition);

    // Se estiver muito distante, ajusta o zoom
    const currentZoom = map.getZoom();
    if (currentZoom < 16) {
        map.setZoom(17);
    }

    // Remove o loading ap√≥s a anima√ß√£o
    setTimeout(() => {
        btn.classList.remove('loading');
        btn.disabled = false;
        showToast(
            'Centralizado!',
            `Precis√£o: ${Math.round(locationAccuracy)}m`,
            'success',
            2000
        );
    }, 400);
};

// ===========================
// MODAL E QR CODE SCANNER
// ===========================

const modal = document.getElementById('modal-add-client');
const btnAddClient = document.getElementById('btn-add-client');
const btnModalClose = document.getElementById('modal-close');
const btnCancel = document.getElementById('btn-cancel');
const btnSave = document.getElementById('btn-save');
const form = document.getElementById('form-add-client');

const addressDisplay = document.getElementById('address-display');
const addressText = document.getElementById('address-text');

const inputName = document.getElementById('input-name');
const inputPhone = document.getElementById('input-phone');

let scannedAddress = '';
let scannedQRCode = ''; // Armazena o c√≥digo QR escaneado
let scannedLatLng = null; // Armazena coordenadas do endere√ßo escaneado

// Mostrar bot√£o ap√≥s carregar o mapa
function showAddClientButton() {
    setTimeout(() => {
        btnAddClient.classList.add('visible');
    }, 800);
}

// Abrir modal
async function openModal() {
    modal.classList.add('active');
    document.body.style.overflow = 'hidden';

    // Verificar se c√¢mera est√° dispon√≠vel
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        showToast(
            'C√¢mera n√£o dispon√≠vel',
            'Seu navegador n√£o suporta acesso √† c√¢mera',
            'error',
            5000
        );
        return;
    }

    // Abrir c√¢mera automaticamente
    try {
        await startCamera();
    } catch (error) {
        console.error('Erro ao abrir c√¢mera:', error);

        let errorMessage = 'Verifique as permiss√µes do navegador';

        // Mensagens de erro mais espec√≠ficas
        if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
            errorMessage = 'Permiss√£o negada. Permita o acesso √† c√¢mera nas configura√ß√µes do navegador.';
        } else if (error.name === 'NotFoundError' || error.name === 'DevicesNotFoundError') {
            errorMessage = 'Nenhuma c√¢mera encontrada no dispositivo.';
        } else if (error.name === 'NotReadableError' || error.name === 'TrackStartError') {
            errorMessage = 'C√¢mera j√° est√° em uso por outro aplicativo.';
        } else if (error.name === 'OverconstrainedError') {
            errorMessage = 'C√¢mera n√£o atende aos requisitos necess√°rios.';
        } else if (error.name === 'SecurityError') {
            errorMessage = 'Acesso √† c√¢mera bloqueado por pol√≠tica de seguran√ßa.';
        }

        showToast(
            'Erro ao abrir c√¢mera',
            errorMessage,
            'error',
            7000
        );
    }
}

// Fechar modal
function closeModal() {
    modal.classList.remove('active');
    document.body.style.overflow = '';
    resetForm();
}

// Resetar formul√°rio
function resetForm() {
    form.reset();
    addressDisplay.classList.remove('active');
    addressText.textContent = '';
    scannedAddress = '';
    scannedQRCode = '';
    scannedLatLng = null;
    stopCamera(); // Parar c√¢mera ao fechar modal

    // Resetar modo de edi√ß√£o
    isEditMode = false;
    editingClientId = null;
    btnSave.textContent = 'Salvar Cliente';

    // Restaurar t√≠tulo do scanner
    const scannerTitle = document.querySelector('.scanner-title span');
    if (scannerTitle) {
        scannerTitle.textContent = 'üì∏ Aponte a c√¢mera para o QR Code';
    }
}

// Event listeners do modal
btnAddClient.addEventListener('click', openModal);
btnModalClose.addEventListener('click', closeModal);
btnCancel.addEventListener('click', closeModal);

// Fechar modal ao clicar fora
modal.addEventListener('click', (e) => {
    if (e.target === modal) {
        closeModal();
    }
});

// ===========================
// M√ÅSCARA DE TELEFONE
// ===========================

inputPhone.addEventListener('input', (e) => {
    let value = e.target.value.replace(/\D/g, ''); // Remove tudo que n√£o √© n√∫mero

    // Limita a 11 d√≠gitos
    if (value.length > 11) {
        value = value.slice(0, 11);
    }

    // Aplica a m√°scara conforme o usu√°rio digita
    let formatted = '';

    if (value.length > 0) {
        formatted = '(' + value.substring(0, 2); // (DD
    }
    if (value.length >= 3) {
        formatted += ')' + value.substring(2, 3); // (DD)D
    }
    if (value.length >= 4) {
        formatted += ' ' + value.substring(3, 7); // (DD)D DDDD
    }
    if (value.length >= 8) {
        formatted += '-' + value.substring(7, 11); // (DD)D DDDD-DDDD
    }

    e.target.value = formatted;
});

// Permitir apenas n√∫meros e teclas de controle
inputPhone.addEventListener('keydown', (e) => {
    const allowedKeys = ['Backspace', 'Delete', 'Tab', 'ArrowLeft', 'ArrowRight', 'Home', 'End'];
    const isNumber = /^[0-9]$/.test(e.key);

    if (!isNumber && !allowedKeys.includes(e.key) && !e.ctrlKey && !e.metaKey) {
        e.preventDefault();
    }
});

// ===========================
// QR CODE SCANNER COM C√ÇMERA
// ===========================

const btnStopCamera = document.getElementById('btn-stop-camera');
const btnSwitchCamera = document.getElementById('btn-switch-camera');
const qrCameraContainer = document.getElementById('qr-camera-container');
const qrVideo = document.getElementById('qr-video');
const qrCanvas = document.getElementById('qr-canvas');
const qrStatus = document.getElementById('qr-status');

let videoStream = null;
let scanningInterval = null;
let currentFacingMode = 'environment'; // Come√ßa com c√¢mera traseira
let lastScannedCode = null;

// Fechar c√¢mera
btnStopCamera.addEventListener('click', () => {
    stopCamera();
});

// Trocar c√¢mera (frontal/traseira)
btnSwitchCamera.addEventListener('click', async () => {
    currentFacingMode = currentFacingMode === 'environment' ? 'user' : 'environment';
    stopCamera();
    await startCamera();
});

// Iniciar c√¢mera
async function startCamera() {
    // Parar c√¢mera existente antes de iniciar nova
    stopCamera();

    const constraints = {
        video: {
            facingMode: currentFacingMode,
            width: { ideal: 1280 },
            height: { ideal: 720 }
        }
    };

    try {
        videoStream = await navigator.mediaDevices.getUserMedia(constraints);

        // Garantir que o v√≠deo recebe o stream
        qrVideo.srcObject = videoStream;

        // Mostrar container da c√¢mera
        qrCameraContainer.classList.add('active');

        // Aguardar v√≠deo carregar e iniciar reprodu√ß√£o
        return new Promise((resolve, reject) => {
            qrVideo.onloadedmetadata = async () => {
                try {
                    // For√ßar play do v√≠deo
                    await qrVideo.play();

                    // Iniciar scanning ap√≥s v√≠deo come√ßar
                    startScanning();

                    resolve();
                } catch (playError) {
                    console.error('Erro ao iniciar reprodu√ß√£o do v√≠deo:', playError);
                    reject(playError);
                }
            };

            qrVideo.onerror = (error) => {
                console.error('Erro no elemento de v√≠deo:', error);
                reject(error);
            };

            // Timeout de seguran√ßa
            setTimeout(() => {
                if (qrVideo.readyState < 2) {
                    reject(new Error('Timeout ao carregar v√≠deo'));
                }
            }, 10000);
        });

    } catch (error) {
        // Limpar em caso de erro
        stopCamera();
        qrCameraContainer.classList.remove('active');
        throw error;
    }
}

// Parar c√¢mera
function stopCamera() {
    // Parar todas as tracks do stream
    if (videoStream) {
        videoStream.getTracks().forEach(track => {
            track.stop();
            track.enabled = false;
        });
        videoStream = null;
    }

    // Parar intervalo de scanning
    if (scanningInterval) {
        clearInterval(scanningInterval);
        scanningInterval = null;
    }

    // Limpar v√≠deo completamente
    qrVideo.pause();
    qrVideo.srcObject = null;
    qrVideo.load(); // For√ßa reload do elemento de v√≠deo

    // Remover event listeners antigos
    qrVideo.onloadedmetadata = null;
    qrVideo.onerror = null;

    // Esconder container
    qrCameraContainer.classList.remove('active');

    // Resetar status
    qrStatus.textContent = 'Procurando QR Code...';
    qrStatus.classList.remove('success');
    lastScannedCode = null;
}

// Iniciar loop de scanning
function startScanning() {
    const canvasContext = qrCanvas.getContext('2d', { willReadFrequently: true });

    scanningInterval = setInterval(() => {
        if (qrVideo.readyState === qrVideo.HAVE_ENOUGH_DATA) {
            // Ajustar canvas para o tamanho do v√≠deo
            qrCanvas.width = qrVideo.videoWidth;
            qrCanvas.height = qrVideo.videoHeight;

            // Desenhar frame atual do v√≠deo no canvas
            canvasContext.drawImage(qrVideo, 0, 0, qrCanvas.width, qrCanvas.height);

            // Obter dados da imagem
            const imageData = canvasContext.getImageData(0, 0, qrCanvas.width, qrCanvas.height);

            // Tentar decodificar QR code
            const code = jsQR(imageData.data, imageData.width, imageData.height, {
                inversionAttempts: "dontInvert",
            });

            if (code && code.data !== lastScannedCode) {
                lastScannedCode = code.data;
                console.log('QR Code detectado:', code.data);

                // Feedback visual
                qrStatus.textContent = '‚úì QR Code detectado!';
                qrStatus.classList.add('success');

                // Som de beep (opcional)
                playBeep();

                // Processar resultado
                handleQRCodeResult(code.data);

                // Parar scanning ap√≥s detectar
                setTimeout(() => {
                    stopCamera();
                }, 1000);
            }
        }
    }, 100); // Scan a cada 100ms (10 fps)
}

// Som de beep ao detectar QR code
function playBeep() {
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();

    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);

    oscillator.frequency.value = 800;
    oscillator.type = 'sine';

    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);

    oscillator.start(audioContext.currentTime);
    oscillator.stop(audioContext.currentTime + 0.2);
}

// Processar resultado do QR Code
async function handleQRCodeResult(qrData) {
    console.log('Processando QR Code:', qrData);

    // Buscar endere√ßo no banco de dados
    const addressData = await lookupAddressData(qrData);

    if (addressData) {
        // Endere√ßo encontrado - armazenar dados completos
        scannedAddress = addressData.address;
        scannedQRCode = qrData;
        scannedLatLng = {
            latitude: addressData.latitude,
            longitude: addressData.longitude
        };

        addressText.textContent = addressData.address;
        addressDisplay.classList.add('active');

        showToast(
            '‚úì Endere√ßo encontrado!',
            'Preencha o nome do cliente',
            'success',
            3000
        );
    } else {
        // Endere√ßo n√£o encontrado - mostrar c√≥digo
        scannedAddress = `C√≥digo QR: ${qrData} (Endere√ßo n√£o cadastrado)`;
        scannedQRCode = qrData;
        scannedLatLng = null; // Sem coordenadas

        addressText.textContent = scannedAddress;
        addressDisplay.classList.add('active');

        showToast(
            '‚ö†Ô∏è Endere√ßo n√£o cadastrado',
            'Este QR code n√£o est√° no banco de dados',
            'warning',
            4000
        );
    }

    // Focar automaticamente no campo de nome
    setTimeout(() => {
        inputName.focus();
    }, 500);
}

// Buscar dados completos do endere√ßo no banco de dados (delivery_data)
async function lookupAddressData(qrCode) {
    try {
        // Buscar na tabela delivery_data pelo SPX TN (c√≥digo QR)
        const { data, error } = await supabase
            .from('delivery_data')
            .select('*')
            .eq('spx_tn', qrCode)
            .single();

        if (error) {
            console.warn('Erro ao buscar QR code:', error);
            // Fallback: buscar no addressDatabase hardcoded (compatibilidade)
            if (addressDatabase[qrCode]) {
                return addressDatabase[qrCode];
            }
            return null;
        }

        if (data) {
            // Formatar endere√ßo no mesmo padr√£o
            let formattedAddress = data.destination_address || '';
            if (data.bairro) {
                formattedAddress += `\nBairro: ${data.bairro}`;
            }
            if (data.city && data.zipcode) {
                formattedAddress += `\n${data.city} - ${data.zipcode}`;
            }

            return {
                address: formattedAddress,
                latitude: data.latitude,
                longitude: data.longitude
            };
        }

        // Se n√£o encontrou no Supabase, tentar no addressDatabase
        if (addressDatabase[qrCode]) {
            return addressDatabase[qrCode];
        }

        return null;

    } catch (error) {
        console.error('Erro ao buscar endere√ßo:', error);
        // Fallback: buscar no addressDatabase
        if (addressDatabase[qrCode]) {
            return addressDatabase[qrCode];
        }
        return null;
    }
}

// Buscar endere√ßo no banco de dados (fun√ß√£o legada - mantida para compatibilidade)
async function lookupAddress(qrCode) {
    const data = await lookupAddressData(qrCode);
    return data ? data.address : null;
}

// ===========================
// SALVAR CLIENTE
// ===========================

form.addEventListener('submit', async (e) => {
    e.preventDefault();

    // Preparar dados do cliente
    const clientData = {
        name: inputName.value.trim(),
        phone: inputPhone.value.trim(),
        address: scannedAddress,
        created_at: new Date().toISOString()
    };

    // SEMPRE adicionar coordenadas da localiza√ß√£o atual do usu√°rio
    let currentPosition = null;
    if (userLocationMarker) {
        if (userLocationMarker.position) {
            currentPosition = userLocationMarker.position;
        } else if (userLocationMarker.getPosition) {
            currentPosition = userLocationMarker.getPosition();
        }
    }

    if (currentPosition) {
        clientData.latitude = currentPosition.lat;
        clientData.longitude = currentPosition.lng;
        console.log('üìç Salvando localiza√ß√£o atual:', currentPosition);
    } else {
        // Fallback: usar coordenadas do QR code se dispon√≠veis
        if (scannedLatLng) {
            clientData.latitude = scannedLatLng.latitude;
            clientData.longitude = scannedLatLng.longitude;
            console.log('üìç Usando coordenadas do QR code:', scannedLatLng);
        } else {
            console.warn('‚ö†Ô∏è Nenhuma coordenada dispon√≠vel para salvar');
        }
    }

    // Valida√ß√£o
    if (!clientData.name) {
        showToast(
            'Campo obrigat√≥rio',
            'Preencha o nome do cliente',
            'error',
            4000
        );
        return;
    }

    if (!clientData.address) {
        showToast(
            'Escaneie o QR Code',
            '√â necess√°rio escanear o QR Code do pacote primeiro',
            'error',
            4000
        );
        return;
    }

    // Loading
    btnSave.classList.add('loading');
    btnSave.disabled = true;

    try {
        if (isEditMode && editingClientId) {
            // MODO EDI√á√ÉO - Atualizar cliente existente
            const { data, error } = await supabase
                .from('clients')
                .update(clientData)
                .eq('id', editingClientId)
                .select();

            if (error) throw error;

            console.log('Cliente atualizado:', data);

            showToast(
                'Cliente atualizado!',
                `${clientData.name} foi atualizado com sucesso`,
                'success',
                4000
            );
        } else {
            // MODO CRIA√á√ÉO - Inserir novo cliente
            const { data, error } = await supabase
                .from('clients')
                .insert([clientData])
                .select();

            if (error) throw error;

            console.log('Cliente salvo:', data);

            showToast(
                'Cliente adicionado!',
                `${clientData.name} foi cadastrado com sucesso`,
                'success',
                4000
            );
        }

        // Atualizar lista de clientes no sidebar
        await loadClients();

        closeModal();

    } catch (error) {
        console.error('Erro ao salvar cliente:', error);
        showToast(
            'Erro ao salvar',
            error.message || 'N√£o foi poss√≠vel salvar o cliente',
            'error',
            5000
        );
    } finally {
        btnSave.classList.remove('loading');
        btnSave.disabled = false;
    }
});

// ===========================
// SIDEBAR - MENU LATERAL
// ===========================

const sidebar = document.getElementById('sidebar');
const sidebarOverlay = document.getElementById('sidebar-overlay');
const btnOpenSidebar = document.getElementById('btnOpenSidebar');
const btnCloseSidebar = document.getElementById('sidebar-close');
const clientsList = document.getElementById('clients-list');
const searchInput = document.getElementById('search-input');
const clientCount = document.getElementById('client-count');

let allClients = [];
let filteredClients = [];

// Abrir sidebar
btnOpenSidebar.addEventListener('click', () => {
    openSidebar();
    loadClients();
});

// Fechar sidebar
btnCloseSidebar.addEventListener('click', closeSidebar);
sidebarOverlay.addEventListener('click', closeSidebar);

function openSidebar() {
    sidebar.classList.add('open');
    sidebarOverlay.classList.add('active');
}

function closeSidebar() {
    sidebar.classList.remove('open');
    sidebarOverlay.classList.remove('active');
}

// Busca em tempo real
searchInput.addEventListener('input', (e) => {
    const searchTerm = e.target.value.toLowerCase().trim();

    if (searchTerm === '') {
        filteredClients = allClients;
    } else {
        filteredClients = allClients.filter(client => {
            const name = (client.name || '').toLowerCase();
            const address = (client.address || '').toLowerCase();
            const phone = (client.phone || '').toLowerCase();

            return name.includes(searchTerm) ||
                   address.includes(searchTerm) ||
                   phone.includes(searchTerm);
        });
    }

    renderClients(filteredClients);
});

// Carregar clientes do Supabase
async function loadClients() {
    try {
        const { data, error } = await supabase
            .from('clients')
            .select('*')
            .order('created_at', { ascending: false });

        if (error) {
            console.error('Erro do Supabase:', error);
            throw error;
        }

        allClients = data || [];
        filteredClients = allClients;

        renderClients(filteredClients);
        updateClientCount(allClients.length);

        console.log(`${allClients.length} cliente(s) carregado(s)`);

    } catch (error) {
        console.error('Erro ao carregar clientes:', error);

        // Mostrar mensagem mais espec√≠fica
        let errorMsg = 'N√£o foi poss√≠vel carregar a lista de clientes';

        if (error.message && error.message.includes('Failed to fetch')) {
            errorMsg = 'Verifique se a tabela "clients" existe no Supabase';
        } else if (error.code) {
            errorMsg = `Erro Supabase: ${error.message}`;
        }

        showToast(
            'Erro ao carregar',
            errorMsg,
            'error',
            6000
        );

        // Mostrar empty state mesmo com erro
        renderClients([]);
    }
}

// Renderizar lista de clientes
function renderClients(clients) {
    if (!clients || clients.length === 0) {
        clientsList.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">üìã</div>
                <div class="empty-state-text">Nenhum cliente encontrado</div>
                <div class="empty-state-subtext">${searchInput.value ? 'Tente outra busca' : 'Adicione clientes para v√™-los aqui'}</div>
            </div>
        `;
        return;
    }

    const clientsHTML = clients.map(client => `
        <div class="client-card" data-client-id="${client.id}">
            <div class="client-card-header">
                <div class="client-name">
                    <span>üë§</span>
                    <span>${escapeHtml(client.name)}</span>
                </div>
                <div class="client-actions">
                    <button class="client-action-btn navigate-btn" data-client-id="${client.id}" title="Navegar at√© o cliente">
                        üß≠
                    </button>
                    <button class="client-action-btn edit-btn" data-client-id="${client.id}" title="Editar">
                        ‚úèÔ∏è
                    </button>
                    <button class="client-action-btn delete-btn" data-client-id="${client.id}" title="Excluir">
                        üóëÔ∏è
                    </button>
                </div>
            </div>
            ${client.phone ? `
                <div class="client-info phone-info">
                    <span class="client-info-icon">üìû</span>
                    <span>${escapeHtml(client.phone)}</span>
                    <div class="phone-actions">
                        <a href="tel:${client.phone.replace(/\D/g, '')}" class="phone-action-btn call-btn" title="Ligar" onclick="event.stopPropagation()">
                            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02l-2.2 2.2z" fill="white"/>
                            </svg>
                        </a>
                        <a href="https://wa.me/55${client.phone.replace(/\D/g, '')}" target="_blank" class="phone-action-btn whatsapp-btn" title="WhatsApp" onclick="event.stopPropagation()">
                            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M12.04 2c-5.46 0-9.91 4.45-9.91 9.91 0 1.75.46 3.45 1.32 4.95L2.05 22l5.25-1.38c1.45.79 3.08 1.21 4.74 1.21 5.46 0 9.91-4.45 9.91-9.91 0-2.65-1.03-5.14-2.9-7.01A9.816 9.816 0 0012.04 2m.01 1.67c2.2 0 4.26.86 5.82 2.42a8.225 8.225 0 012.41 5.83c0 4.54-3.7 8.23-8.24 8.23-1.48 0-2.93-.39-4.19-1.15l-.3-.17-3.12.82.83-3.04-.2-.32a8.188 8.188 0 01-1.26-4.38c.01-4.54 3.7-8.24 8.25-8.24M8.53 7.33c-.16 0-.43.06-.66.31-.22.25-.87.85-.87 2.07 0 1.22.89 2.39 1 2.56.14.17 1.76 2.67 4.25 3.73.59.27 1.05.42 1.41.53.59.19 1.13.16 1.56.1.48-.07 1.46-.6 1.67-1.18.21-.58.21-1.07.15-1.18-.07-.1-.23-.16-.48-.27-.25-.14-1.47-.74-1.69-.82-.23-.08-.37-.12-.56.12-.16.25-.64.81-.78.97-.15.17-.29.19-.53.07-.26-.13-1.06-.39-2-1.23-.74-.66-1.23-1.47-1.38-1.72-.14-.25-.02-.39.11-.5.11-.11.25-.29.37-.44.13-.14.17-.25.25-.41.08-.17.04-.31-.02-.43-.06-.11-.56-1.35-.76-1.84-.2-.48-.4-.42-.56-.43-.14 0-.3-.01-.47-.01z" fill="white"/>
                            </svg>
                        </a>
                    </div>
                </div>
            ` : ''}
            ${client.address ? `
                <div class="client-info">
                    <span class="client-info-icon">üìç</span>
                    <span>${escapeHtml(client.address.replace(/C√≥digo QR:.*?\(/g, '(').replace(/BR\d+/g, '').trim())}</span>
                </div>
            ` : ''}
        </div>
    `).join('');

    clientsList.innerHTML = clientsHTML;

    // Adicionar event listeners aos cards
    document.querySelectorAll('.client-card').forEach(card => {
        card.addEventListener('click', (e) => {
            // N√£o abrir detalhes se clicou em um bot√£o de a√ß√£o
            if (e.target.closest('.client-action-btn')) {
                return;
            }

            const clientId = card.getAttribute('data-client-id');
            const client = clients.find(c => c.id === clientId);
            if (client) {
                showClientDetails(client);
            }
        });
    });

    // Event listeners para bot√µes de navegar
    document.querySelectorAll('.navigate-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const clientId = btn.getAttribute('data-client-id');
            const client = clients.find(c => c.id === clientId);
            if (client) {
                navigateToClient(client);
            }
        });
    });

    // Event listeners para bot√µes de editar
    document.querySelectorAll('.edit-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const clientId = btn.getAttribute('data-client-id');
            const client = clients.find(c => c.id === clientId);
            if (client) {
                editClient(client);
            }
        });
    });

    // Event listeners para bot√µes de excluir
    document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const clientId = btn.getAttribute('data-client-id');
            const client = clients.find(c => c.id === clientId);
            if (client) {
                deleteClient(client);
            }
        });
    });

    // Event listeners para bot√µes de telefone - reset agressivo com class toggle
    document.querySelectorAll('.phone-action-btn').forEach(btn => {
        // Touchstart - preparar para reset
        btn.addEventListener('touchstart', function(e) {
            e.stopPropagation();
            this.setAttribute('data-touched', 'true');
        }, { passive: true });

        // Touch end - resetar com class toggle para for√ßar re-render
        btn.addEventListener('touchend', function(e) {
            e.stopPropagation();
            const element = this;

            // Reset imediato com requestAnimationFrame para for√ßar reflow
            requestAnimationFrame(() => {
                element.blur();

                // Remove e readiciona classe para for√ßar re-render
                element.classList.remove('btn-reset');
                void element.offsetWidth; // For√ßa reflow
                element.classList.add('btn-reset');

                // Remove todos os estilos inline
                element.removeAttribute('style');

                // Remove atributo de touch
                element.removeAttribute('data-touched');
            });

            // Segundo reset ap√≥s um delay
            setTimeout(() => {
                element.blur();
                element.removeAttribute('style');
                element.classList.remove('btn-reset');
                void element.offsetWidth;
                element.classList.add('btn-reset');
            }, 100);
        });

        // Click - reset similar
        btn.addEventListener('click', function(e) {
            const element = this;

            requestAnimationFrame(() => {
                element.blur();
                element.classList.remove('btn-reset');
                void element.offsetWidth;
                element.classList.add('btn-reset');
                element.removeAttribute('style');
            });

            setTimeout(() => {
                element.blur();
                element.removeAttribute('style');
            }, 150);
        });

        // Mouseout - limpar estados residuais
        btn.addEventListener('mouseout', function() {
            this.blur();
            this.removeAttribute('style');
        });
    });

    // Listener global para resetar quando volta do app externo
    window.removeEventListener('focus', resetPhoneButtonsFocus);
    window.addEventListener('focus', resetPhoneButtonsFocus);

    // Listener para quando a p√°gina fica vis√≠vel novamente
    document.removeEventListener('visibilitychange', resetPhoneButtonsFocus);
    document.addEventListener('visibilitychange', function() {
        if (!document.hidden) {
            resetPhoneButtonsFocus();
        }
    });
}

// Fun√ß√£o para resetar foco dos bot√µes de telefone - vers√£o agressiva
function resetPhoneButtonsFocus() {
    requestAnimationFrame(() => {
        // Resetar TODOS os bot√µes de telefone
        document.querySelectorAll('.phone-action-btn').forEach(btn => {
            // Remove foco
            btn.blur();

            // Remove todos os estilos inline
            btn.removeAttribute('style');

            // Remove e readiciona classe para for√ßar re-render
            btn.classList.remove('btn-reset');
            void btn.offsetWidth; // For√ßa reflow
            btn.classList.add('btn-reset');

            // Remove atributos residuais
            btn.removeAttribute('data-touched');
        });

        // Remover foco dos cards
        document.querySelectorAll('.client-card').forEach(card => {
            card.blur();
            card.style.outline = 'none';
        });

        // Criar input tempor√°rio para roubar foco completamente
        const tempInput = document.createElement('input');
        tempInput.style.cssText = 'position:absolute;opacity:0;height:0;width:0;left:-9999px;pointer-events:none;';
        tempInput.setAttribute('tabindex', '-1');
        tempInput.setAttribute('aria-hidden', 'true');
        document.body.appendChild(tempInput);

        tempInput.focus();

        setTimeout(() => {
            tempInput.blur();
            if (document.body.contains(tempInput)) {
                document.body.removeChild(tempInput);
            }

            // Reset final dos bot√µes
            document.querySelectorAll('.phone-action-btn').forEach(btn => {
                btn.removeAttribute('style');
                btn.blur();
            });
        }, 50);
    });
}

// Atualizar contador de clientes
function updateClientCount(count) {
    clientCount.textContent = count;
}

// Mostrar detalhes do cliente e centralizar no mapa
function showClientDetails(client) {
    // Fechar sidebar
    closeSidebar();

    let targetPosition = null;
    let qrCodeMatch = null;

    // Prioridade 1: Usar coordenadas salvas no cliente (se dispon√≠veis)
    if (client.latitude && client.longitude) {
        targetPosition = {
            lat: client.latitude,
            lng: client.longitude
        };
        console.log('Usando coordenadas do cliente:', targetPosition);
    } else {
        // Prioridade 2: Procurar nos dados da planilha pelo endere√ßo do cliente
        for (const [qrCode, data] of Object.entries(addressDatabase)) {
            if (client.address && client.address.includes(data.address.split('\n')[0])) {
                targetPosition = {
                    lat: data.latitude,
                    lng: data.longitude
                };
                qrCodeMatch = qrCode;
                console.log('Coordenadas encontradas na planilha:', targetPosition);
                break;
            }
        }
    }

    if (targetPosition) {
        // Centralizar no endere√ßo encontrado
        map.setCenter(targetPosition);
        map.setZoom(18);

        // Criar marcador tempor√°rio para mostrar a localiza√ß√£o do cliente
        const clientMarkerDiv = document.createElement('div');
        clientMarkerDiv.style.width = '40px';
        clientMarkerDiv.style.height = '40px';
        clientMarkerDiv.style.background = '#4285f4';
        clientMarkerDiv.style.border = '3px solid white';
        clientMarkerDiv.style.borderRadius = '50%';
        clientMarkerDiv.style.boxShadow = '0 2px 10px rgba(0,0,0,0.4)';
        clientMarkerDiv.style.display = 'flex';
        clientMarkerDiv.style.alignItems = 'center';
        clientMarkerDiv.style.justifyContent = 'center';
        clientMarkerDiv.style.fontSize = '20px';
        clientMarkerDiv.innerHTML = 'üë§';

        let tempMarker;
        try {
            if (google.maps.marker && google.maps.marker.AdvancedMarkerElement) {
                tempMarker = new google.maps.marker.AdvancedMarkerElement({
                    map,
                    position: targetPosition,
                    content: clientMarkerDiv,
                    title: client.name
                });
            } else {
                tempMarker = new google.maps.Marker({
                    map,
                    position: targetPosition,
                    title: client.name,
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 12,
                        fillColor: '#4285f4',
                        fillOpacity: 1,
                        strokeColor: 'white',
                        strokeWeight: 3
                    },
                    label: {
                        text: 'üë§',
                        color: 'white',
                        fontSize: '16px'
                    }
                });
            }

            // Remover marcador tempor√°rio ap√≥s 5 segundos
            setTimeout(() => {
                if (tempMarker.map !== undefined) {
                    tempMarker.map = null;
                } else if (tempMarker.setMap) {
                    tempMarker.setMap(null);
                }
            }, 5000);
        } catch (error) {
            console.warn('Erro ao criar marcador tempor√°rio:', error);
        }

        // Destacar o marcador correspondente (apenas se estiver no modo de rota)
        if (qrCodeMatch && deliveryMarkers[qrCodeMatch]) {
            try {
                // Verificar se √© AdvancedMarkerElement ou Marker cl√°ssico
                const marker = deliveryMarkers[qrCodeMatch];

                if (marker.content && marker.content.style) {
                    // AdvancedMarkerElement
                    const markerElement = marker.content;
                    markerElement.style.transform = 'scale(1.5)';
                    markerElement.style.background = '#fbbc04'; // Amarelo para destaque

                    setTimeout(() => {
                        markerElement.style.transform = 'scale(1)';
                        markerElement.style.background = '#ea4335'; // Voltar ao vermelho
                    }, 2000);
                } else if (marker.setIcon) {
                    // Marker cl√°ssico - trocar cor temporariamente
                    const originalIcon = marker.getIcon();
                    marker.setIcon({
                        ...originalIcon,
                        fillColor: '#fbbc04',
                        scale: 12
                    });

                    setTimeout(() => {
                        marker.setIcon(originalIcon);
                    }, 2000);
                }
            } catch (error) {
                console.warn('Erro ao destacar marcador:', error);
            }
        }

        showToast(
            `üìç ${client.name}`,
            client.address,
            'success',
            4000
        );
    } else {
        // Se n√£o encontrar coordenadas, apenas mostrar informa√ß√µes
        showToast(
            client.name,
            `üìû ${client.phone || 'Sem telefone'}\nüìç ${client.address}`,
            'info',
            5000
        );
    }
}

// ===========================
// EDITAR CLIENTE
// ===========================

let isEditMode = false;
let editingClientId = null;

async function editClient(client) {
    isEditMode = true;
    editingClientId = client.id;

    // Abrir modal (sem fechar sidebar)
    modal.classList.add('active');
    document.body.style.overflow = 'hidden';

    // Preencher campos com dados atuais
    inputName.value = client.name || '';
    inputPhone.value = client.phone || '';

    // Mostrar endere√ßo
    scannedAddress = client.address || '';
    addressText.textContent = scannedAddress;
    if (scannedAddress) {
        addressDisplay.classList.add('active');
    }

    // Salvar coordenadas existentes
    if (client.latitude && client.longitude) {
        scannedLatLng = {
            latitude: client.latitude,
            longitude: client.longitude
        };
    }

    // Trocar texto do bot√£o
    btnSave.textContent = 'Atualizar Cliente';

    // Modificar o t√≠tulo do scanner
    const scannerTitle = document.querySelector('.scanner-title span');
    if (scannerTitle) {
        scannerTitle.textContent = '‚úèÔ∏è Editando Cliente';
    }

    // Iniciar c√¢mera para o scanner QR Code
    try {
        await startCamera();
    } catch (error) {
        console.error('Erro ao abrir c√¢mera no modo de edi√ß√£o:', error);

        // Mensagem de erro para o usu√°rio
        let errorMessage = 'Verifique as permiss√µes do navegador';

        if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
            errorMessage = 'Permiss√£o negada. Permita o acesso √† c√¢mera nas configura√ß√µes do navegador.';
        } else if (error.name === 'NotFoundError' || error.name === 'DevicesNotFoundError') {
            errorMessage = 'Nenhuma c√¢mera encontrada no dispositivo.';
        } else if (error.name === 'NotReadableError' || error.name === 'TrackStartError') {
            errorMessage = 'C√¢mera j√° est√° em uso por outro aplicativo.';
        }

        showToast(
            'Erro ao abrir c√¢mera',
            errorMessage,
            'error',
            5000
        );
    }

    // Focar no nome
    setTimeout(() => {
        inputName.focus();
        inputName.select();
    }, 300);
}

// ===========================
// EXCLUIR CLIENTE
// ===========================

function deleteClient(client) {
    // Criar modal de confirma√ß√£o customizado
    const confirmModal = document.createElement('div');
    confirmModal.className = 'modal-overlay';
    confirmModal.style.zIndex = '10004';
    confirmModal.innerHTML = `
        <div class="modal-container" style="max-width: 400px;">
            <div class="modal-body" style="padding: 24px;">
                <h3 style="margin: 0 0 16px 0; color: #ea4335; font-size: 20px;">
                    üóëÔ∏è Confirmar Exclus√£o
                </h3>
                <p style="margin: 0 0 8px 0; color: #333; font-size: 16px;">
                    Deseja realmente excluir este cliente?
                </p>
                <div style="background: #f5f5f5; padding: 12px; border-radius: 8px; margin-top: 12px;">
                    <p style="margin: 0 0 4px 0; font-weight: 600; color: #333;">
                        ${escapeHtml(client.name)}
                    </p>
                    <p style="margin: 0; font-size: 14px; color: #666;">
                        ${client.phone ? 'üìû ' + escapeHtml(client.phone) : ''}
                    </p>
                </div>
                <p style="margin: 16px 0 0 0; font-size: 13px; color: #999;">
                    Esta a√ß√£o n√£o pode ser desfeita.
                </p>
            </div>
            <div class="form-footer">
                <button type="button" class="btn btn-secondary" id="btn-confirm-cancel">
                    Cancelar
                </button>
                <button type="button" class="btn btn-primary" id="btn-confirm-delete" style="background: #ea4335;">
                    Excluir
                </button>
            </div>
        </div>
    `;

    document.body.appendChild(confirmModal);

    // Animar entrada
    setTimeout(() => {
        confirmModal.classList.add('active');
    }, 10);

    // Bot√£o Cancelar
    const btnCancel = confirmModal.querySelector('#btn-confirm-cancel');
    btnCancel.addEventListener('click', () => {
        confirmModal.classList.remove('active');
        setTimeout(() => {
            confirmModal.remove();
        }, 300);
    });

    // Bot√£o Excluir
    const btnDelete = confirmModal.querySelector('#btn-confirm-delete');
    btnDelete.addEventListener('click', async () => {
        btnDelete.classList.add('loading');
        btnDelete.disabled = true;
        btnDelete.textContent = 'Excluindo...';

        try {
            // Excluir do Supabase
            const { error } = await supabase
                .from('clients')
                .delete()
                .eq('id', client.id);

            if (error) throw error;

            console.log('Cliente exclu√≠do:', client.id);

            showToast(
                'Cliente exclu√≠do!',
                `${client.name} foi removido com sucesso`,
                'success',
                3000
            );

            // Fechar modal de confirma√ß√£o
            confirmModal.classList.remove('active');
            setTimeout(() => {
                confirmModal.remove();
            }, 300);

            // Atualizar lista de clientes
            await loadClients();

        } catch (error) {
            console.error('Erro ao excluir cliente:', error);
            showToast(
                'Erro ao excluir',
                error.message || 'N√£o foi poss√≠vel excluir o cliente',
                'error',
                5000
            );
            btnDelete.classList.remove('loading');
            btnDelete.disabled = false;
            btnDelete.textContent = 'Excluir';
        }
    });

    // Fechar ao clicar fora
    confirmModal.addEventListener('click', (e) => {
        if (e.target === confirmModal) {
            confirmModal.classList.remove('active');
            setTimeout(() => {
                confirmModal.remove();
            }, 300);
        }
    });
}

// ===========================
// NAVEGAR AT√â O CLIENTE
// ===========================

async function navigateToClient(client) {
    // Fechar sidebar
    closeSidebar();

    // Verificar se temos coordenadas do destino
    let destination = null;

    if (client.latitude && client.longitude) {
        destination = { lat: client.latitude, lng: client.longitude };
    } else {
        // Tentar encontrar no addressDatabase pelo endere√ßo
        const qrCodeMatch = Object.keys(addressDatabase).find(qr =>
            client.address && client.address.includes(qr)
        );

        if (qrCodeMatch && addressDatabase[qrCodeMatch]) {
            destination = {
                lat: addressDatabase[qrCodeMatch].latitude,
                lng: addressDatabase[qrCodeMatch].longitude
            };
        }
    }

    if (!destination) {
        showToast(
            '‚ö†Ô∏è Coordenadas n√£o encontradas',
            'Este cliente n√£o possui coordenadas GPS salvas',
            'error',
            4000
        );
        return;
    }

    // Obter localiza√ß√£o atual do usu√°rio
    let userPosition = null;
    if (userLocationMarker) {
        if (userLocationMarker.position) {
            userPosition = userLocationMarker.position;
        } else if (userLocationMarker.getPosition) {
            userPosition = userLocationMarker.getPosition();
        }
    }

    if (!userPosition) {
        showToast(
            '‚ö†Ô∏è Localiza√ß√£o n√£o dispon√≠vel',
            'Ative a localiza√ß√£o GPS para navegar',
            'error',
            4000
        );
        return;
    }

    showToast(
        'üß≠ Calculando rota...',
        `Tra√ßando caminho at√© ${client.name}`,
        'info',
        3000
    );

    try {
        // Usar Directions API para rota ponto-a-ponto
        const directionsService = new google.maps.DirectionsService();

        const request = {
            origin: userPosition,
            destination: destination,
            travelMode: google.maps.TravelMode.DRIVING,
            optimizeWaypoints: false,
            language: 'pt-BR',
            region: 'BR'
        };

        const result = await directionsService.route(request);

        if (result.status === 'OK') {
            // Limpar rotas antigas
            if (window.routePolylines && window.routePolylines.length > 0) {
                window.routePolylines.forEach(polyline => {
                    if (polyline.setMap) {
                        polyline.setMap(null);
                    }
                });
                window.routePolylines = [];
            }

            // Desenhar nova rota
            const route = result.routes[0];
            const leg = route.legs[0];

            // Criar polyline para a rota
            const polyline = new google.maps.Polyline({
                path: route.overview_path,
                geodesic: true,
                strokeColor: '#4285f4',
                strokeOpacity: 0.8,
                strokeWeight: 5,
                map: map
            });

            window.routePolylines = [polyline];

            // Ajustar mapa para mostrar toda a rota
            const bounds = new google.maps.LatLngBounds();
            bounds.extend(userPosition);
            bounds.extend(destination);
            map.fitBounds(bounds);

            // Criar marcador no destino
            const destinationMarkerDiv = document.createElement('div');
            destinationMarkerDiv.style.width = '40px';
            destinationMarkerDiv.style.height = '40px';
            destinationMarkerDiv.style.background = '#34a853';
            destinationMarkerDiv.style.border = '3px solid white';
            destinationMarkerDiv.style.borderRadius = '50%';
            destinationMarkerDiv.style.display = 'flex';
            destinationMarkerDiv.style.alignItems = 'center';
            destinationMarkerDiv.style.justifyContent = 'center';
            destinationMarkerDiv.style.fontSize = '20px';
            destinationMarkerDiv.style.boxShadow = '0 2px 6px rgba(0,0,0,0.4)';
            destinationMarkerDiv.innerHTML = 'üéØ';

            const destinationMarker = new google.maps.marker.AdvancedMarkerElement({
                position: destination,
                map: map,
                content: destinationMarkerDiv,
                title: client.name
            });

            // Remover marcador ap√≥s 10 segundos
            setTimeout(() => {
                if (destinationMarker.map !== undefined) {
                    destinationMarker.map = null;
                } else if (destinationMarker.setMap) {
                    destinationMarker.setMap(null);
                }
            }, 10000);

            // Formatar dist√¢ncia e dura√ß√£o
            const distance = leg.distance.text;
            const duration = leg.duration.text;

            showToast(
                `üéØ Rota para ${client.name}`,
                `üìè Dist√¢ncia: ${distance}\n‚è±Ô∏è Tempo estimado: ${duration}`,
                'success',
                8000
            );

            console.log('‚úÖ Rota calculada:', {
                distance: leg.distance,
                duration: leg.duration,
                steps: leg.steps.length
            });

        } else {
            throw new Error(`Directions API retornou status: ${result.status}`);
        }

    } catch (error) {
        console.error('Erro ao calcular rota:', error);
        showToast(
            '‚ùå Erro ao calcular rota',
            error.message || 'N√£o foi poss√≠vel tra√ßar o caminho',
            'error',
            5000
        );
    }
}

// Fun√ß√£o helper para escape HTML
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Carregar clientes ao inicializar e verificar se h√° dados da planilha
setTimeout(async () => {
    loadClients();

    // Verificar se h√° dados da planilha salvos no Supabase
    try {
        const { data, error } = await supabase
            .from('delivery_data')
            .select('id')
            .limit(1);

        if (!error && data && data.length > 0) {
            // Se h√° dados da planilha, mudar bot√£o para modo "Limpar"
            setButtonToClearMode();
            console.log('üìä Planilha detectada no banco de dados');
        } else {
            // Sem dados, manter bot√£o em modo "Upload"
            setButtonToUploadMode();
            console.log('üìã Nenhuma planilha no banco de dados');
        }
    } catch (error) {
        console.error('Erro ao verificar dados da planilha:', error);
    }
}, 2000);

// ===========================
// SISTEMA DE ROTAS DE ENTREGA
// ===========================

const btnToggleRoute = document.getElementById('btnToggleRoute');

btnToggleRoute.addEventListener('click', () => {
    if (!routeMode) {
        // Ativar modo de rota
        activateRouteMode();
    } else {
        // Desativar modo de rota
        deactivateRouteMode();
    }
});

// Bot√£o de limpar rotas e marcadores
const btnClearRoute = document.getElementById('btnClearRoute');
btnClearRoute.addEventListener('click', () => {
    clearAllRoutesAndMarkers();
});

async function activateRouteMode() {
    routeMode = true;
    btnToggleRoute.classList.add('active');

    // Esconder bot√£o de planejar rota e mostrar bot√£o de limpar
    btnToggleRoute.style.display = 'none';
    document.getElementById('btnClearRoute').style.display = 'flex';

    // Reativar DirectionsRenderer se necess√°rio
    if (directionsRenderer && !directionsRenderer.getMap()) {
        console.log('üîµ Reativando DirectionsRenderer...');
        directionsRenderer.setMap(map);
    }

    // Obter posi√ß√£o atual do usu√°rio
    let currentPosition;
    if (userLocationMarker) {
        if (userLocationMarker.position) {
            currentPosition = userLocationMarker.position;
        } else if (userLocationMarker.getPosition) {
            currentPosition = userLocationMarker.getPosition();
        }
    }

    if (!currentPosition) {
        showToast(
            'Localiza√ß√£o n√£o dispon√≠vel',
            'Aguarde obter sua posi√ß√£o GPS para calcular rotas',
            'warning',
            4000
        );
        deactivateRouteMode();
        return;
    }

    // NOVO: Adicionar marcadores do Supabase SOMENTE quando clicar
    await addDeliveryMarkers();

    // Calcular rota otimizada para todos os pontos de entrega
    await calculateOptimizedRouteFromDB(currentPosition);
}

function deactivateRouteMode() {
    routeMode = false;
    btnToggleRoute.classList.remove('active');

    // Mostrar bot√£o de planejar rota e esconder bot√£o de limpar
    btnToggleRoute.style.display = 'flex';
    document.getElementById('btnClearRoute').style.display = 'none';

    // Limpar rota do mapa COMPLETAMENTE
    if (directionsRenderer) {
        directionsRenderer.setDirections({routes: []});
        directionsRenderer.setMap(null);
    }

    // Limpar polylines (rotas em segmentos)
    if (window.routePolylines) {
        window.routePolylines.forEach(polyline => {
            polyline.setMap(null);
        });
        window.routePolylines = [];
    }

    // Remover marcadores de entrega
    Object.values(deliveryMarkers).forEach(marker => {
        if (marker.map) {
            marker.map = null; // Remove do mapa
        } else if (marker.setMap) {
            marker.setMap(null);
        }
    });

    showToast(
        'Modo de rota desativado',
        'Marcadores de entrega ocultados',
        'info',
        2000
    );
}

// Nova fun√ß√£o: Limpar TUDO (marcadores + rotas + cluster)
function clearAllRoutesAndMarkers() {
    console.log('üóëÔ∏è ========================================');
    console.log('üóëÔ∏è INICIANDO LIMPEZA COMPLETA...');
    console.log('üóëÔ∏è ========================================');

    // Desativar modo de rota se estiver ativo
    if (routeMode) {
        console.log('üî¥ Desativando modo de rota...');
        routeMode = false;
        btnToggleRoute.classList.remove('active');
    }

    // Esconder bot√£o de limpar e mostrar bot√£o de planejar rota novamente
    document.getElementById('btnClearRoute').style.display = 'none';
    btnToggleRoute.style.display = 'flex';

    // 1. Limpar DirectionsRenderer COMPLETAMENTE
    if (directionsRenderer) {
        console.log('üóëÔ∏è Limpando DirectionsRenderer...');
        try {
            directionsRenderer.setDirections({routes: []});
            directionsRenderer.setMap(null);
            directionsRenderer.setPanel(null);
            // Recriar DirectionsRenderer limpo
            directionsRenderer = new google.maps.DirectionsRenderer({
                map: null, // Inicialmente sem mapa
                suppressMarkers: false,
                polylineOptions: {
                    strokeColor: '#4285f4',
                    strokeWeight: 5,
                    strokeOpacity: 0.7
                }
            });
        } catch (e) {
            console.warn('Erro ao limpar DirectionsRenderer:', e);
        }
    }

    // 2. Limpar TODAS as polylines (array + verifica√ß√£o extra)
    let polylinesRemoved = 0;

    if (window.routePolylines && window.routePolylines.length > 0) {
        console.log(`üóëÔ∏è Removendo ${window.routePolylines.length} polylines do array...`);
        window.routePolylines.forEach(polyline => {
            try {
                if (polyline && polyline.setMap) {
                    polyline.setMap(null);
                    polylinesRemoved++;
                }
            } catch (e) {
                console.warn('Erro ao remover polyline:', e);
            }
        });
        window.routePolylines = [];
    } else {
        console.log('üóëÔ∏è Nenhuma polyline encontrada no array');
    }

    console.log(`‚úÖ ${polylinesRemoved} polylines removidas`);

    // 3. Remover TODOS os marcadores de entrega
    const markerCount = Object.keys(deliveryMarkers).length;
    if (markerCount > 0) {
        console.log(`üóëÔ∏è Removendo ${markerCount} marcadores de entrega...`);
        Object.values(deliveryMarkers).forEach(marker => {
            try {
                if (marker.map !== undefined) {
                    marker.map = null; // AdvancedMarkerElement
                } else if (marker.setMap) {
                    marker.setMap(null); // Marker cl√°ssico
                }
            } catch (e) {
                console.warn('Erro ao remover marcador:', e);
            }
        });
    }

    // 4. RESETAR completamente o objeto de marcadores
    deliveryMarkers = {};

    console.log('‚úÖ ========================================');
    console.log('‚úÖ LIMPEZA COMPLETA REALIZADA!');
    console.log('‚úÖ ========================================');

    showToast(
        'üóëÔ∏è Tudo limpo!',
        'Rotas e marcadores removidos do mapa',
        'success',
        3000
    );
}

async function calculateOptimizedRoute(origin) {
    // Marcadores j√° foram adicionados em activateRouteMode()
    // Removido: addDeliveryMarkers();

    showToast(
        'Calculando rota otimizada...',
        'Usando Fleet Routing API para todos os 73 endere√ßos',
        'info',
        4000
    );

    // Verificar se Project ID foi configurado
    if (GOOGLE_CLOUD_PROJECT_ID === "SEU_PROJECT_ID_AQUI") {
        showToast(
            '‚ö†Ô∏è Configura√ß√£o necess√°ria',
            'Configure o GOOGLE_CLOUD_PROJECT_ID no c√≥digo (linha 1799)',
            'error',
            8000
        );
        deactivateRouteMode();
        return;
    }

    // Obter todos os pontos de entrega
    let deliveryPoints = Object.values(addressDatabase).map(data => ({
        location: {lat: data.latitude, lng: data.longitude},
        address: data.address
    }));

    console.log(`Total de endere√ßos na planilha: ${deliveryPoints.length}`);

    // Remover pontos duplicados (mesmas coordenadas)
    const uniquePoints = [];
    const seenCoords = new Set();

    deliveryPoints.forEach(point => {
        const coordKey = `${point.location.lat.toFixed(6)},${point.location.lng.toFixed(6)}`;
        if (!seenCoords.has(coordKey)) {
            seenCoords.add(coordKey);
            uniquePoints.push(point);
        }
    });

    console.log(`Endere√ßos √∫nicos (sem duplicatas): ${uniquePoints.length}`);

    if (uniquePoints.length === 0) {
        showToast(
            'Nenhuma entrega encontrada',
            'N√£o h√° endere√ßos cadastrados para criar uma rota',
            'warning',
            4000
        );
        deactivateRouteMode();
        return;
    }

    // Usar Fleet Routing API para TODOS os pontos
    try {
        await calculateFleetRoute(origin, uniquePoints);
    } catch (error) {
        console.error('‚ùå ERRO ao calcular rota com Fleet API:', error);
        console.error('Mensagem do erro:', error.message);

        // Fallback para Directions API com limite de 23 pontos
        console.log('‚ö†Ô∏è USANDO FALLBACK: Directions API (limite de 23 pontos)...');

        showToast(
            '‚ö†Ô∏è Usando modo fallback',
            'Fleet API falhou. Calculando com 23 pontos mais pr√≥ximos.',
            'warning',
            6000
        );

        await calculateDirectionsRoute(origin, uniquePoints);
    }
}

// Nova fun√ß√£o: Calcular rota usando dados do Supabase
async function calculateOptimizedRouteFromDB(origin) {
    showToast(
        'Calculando rota otimizada...',
        'Buscando dados da planilha de entregas',
        'info',
        4000
    );

    try {
        // Buscar todos os dados da planilha do Supabase
        const { data: deliveryData, error } = await supabase
            .from('delivery_data')
            .select('*')
            .order('sequence', { ascending: true });

        if (error) throw error;

        if (!deliveryData || deliveryData.length === 0) {
            showToast(
                'Nenhuma entrega encontrada',
                'Fa√ßa upload de uma planilha para planejar rotas',
                'warning',
                4000
            );
            deactivateRouteMode();
            return;
        }

        // Criar array de pontos de entrega com endere√ßos formatados
        let deliveryPoints = deliveryData
            .filter(delivery => delivery.latitude && delivery.longitude)
            .map(delivery => {
                let address = delivery.destination_address || '';
                if (delivery.bairro) address += `, ${delivery.bairro}`;
                if (delivery.city) address += `, ${delivery.city}`;

                return {
                    location: { lat: delivery.latitude, lng: delivery.longitude },
                    address: address,
                    spx_tn: delivery.spx_tn,
                    sequence: delivery.sequence
                };
            });

        console.log(`Total de entregas na planilha: ${deliveryPoints.length}`);

        // Remover pontos duplicados (mesmas coordenadas)
        const uniquePoints = [];
        const seenCoords = new Set();

        deliveryPoints.forEach(point => {
            const coordKey = `${point.location.lat.toFixed(6)},${point.location.lng.toFixed(6)}`;
            if (!seenCoords.has(coordKey)) {
                seenCoords.add(coordKey);
                uniquePoints.push(point);
            }
        });

        console.log(`Endere√ßos √∫nicos (sem duplicatas): ${uniquePoints.length}`);

        if (uniquePoints.length === 0) {
            showToast(
                'Nenhuma entrega encontrada',
                'N√£o h√° clientes com coordenadas v√°lidas',
                'warning',
                4000
            );
            deactivateRouteMode();
            return;
        }

        // Verificar configura√ß√£o do Project ID
        if (typeof GOOGLE_CLOUD_PROJECT_ID !== 'undefined' && GOOGLE_CLOUD_PROJECT_ID !== "SEU_PROJECT_ID_AQUI") {
            // Usar Fleet Routing API se configurado
            await calculateFleetRoute(origin, uniquePoints);
        } else {
            // Fallback: usar Directions API (limitado a 23 pontos)
            if (uniquePoints.length > 23) {
                showToast(
                    '‚ö†Ô∏è Limite de endere√ßos',
                    `Voc√™ tem ${uniquePoints.length} entregas. Configure o Fleet Routing API para otimizar todas.`,
                    'warning',
                    6000
                );
                // Usar apenas os 23 primeiros
                const limitedPoints = uniquePoints.slice(0, 23);
                await calculateDirectionsRoute(origin, limitedPoints);
            } else {
                await calculateDirectionsRoute(origin, uniquePoints);
            }
        }

    } catch (error) {
        console.error('Erro ao calcular rota:', error);
        showToast(
            'Erro ao calcular rota',
            error.message || 'N√£o foi poss√≠vel processar os dados',
            'error',
            5000
        );
        deactivateRouteMode();
    }
}

// Nova fun√ß√£o: Fleet Routing API via Backend (suporta todos os pontos)
async function calculateFleetRoute(origin, deliveryPoints) {
    console.log(`üöÄ Chamando backend para otimizar ${deliveryPoints.length} pontos`);
    console.log(`Project ID: ${GOOGLE_CLOUD_PROJECT_ID}`);

    // Chamar API serverless do backend (Cloudflare Pages Function)
    const backendUrl = '/api/optimize-route';

    // Transformar deliveryPoints para o formato esperado pelo backend
    const formattedPoints = deliveryPoints.map(point => ({
        lat: point.location.lat,
        lng: point.location.lng,
        address: point.address || ''
    }));

    const payload = {
        origin: origin,
        deliveryPoints: formattedPoints,
        projectId: GOOGLE_CLOUD_PROJECT_ID
    };

    console.log('üì§ Enviando requisi√ß√£o para backend...');
    console.log('URL:', backendUrl);
    console.log(`Pontos: ${deliveryPoints.length}`);

    const response = await fetch(backendUrl, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(payload)
    });

    console.log(`üì• Resposta backend: Status ${response.status}`);

    if (!response.ok) {
        const errorData = await response.json();
        console.error('‚ùå ERRO do Backend:');
        console.error('Status:', response.status);
        console.error('Erro completo:', JSON.stringify(errorData, null, 2));

        // Logar detalhes espec√≠ficos se existirem
        if (errorData.details) {
            console.error('Detalhes do Google:', errorData.details);
        }
        if (errorData.requestModel) {
            console.error('Modelo enviado:', JSON.stringify(errorData.requestModel, null, 2));
        }

        showToast(
            '‚ùå Erro no Backend',
            errorData.message || 'N√£o foi poss√≠vel calcular a rota',
            'error',
            10000
        );

        throw new Error(`Backend falhou: ${response.status} - ${errorData.message}`);
    }

    const data = await response.json();

    if (!data.success || !data.result) {
        console.error('‚ùå Resposta inv√°lida do backend:', data);
        throw new Error('Resposta inv√°lida do backend');
    }

    console.log('‚úÖ Fleet Routing result:', data.result);
    console.log(`Rotas retornadas: ${data.result.routes?.length || 0}`);

    // Renderizar rota otimizada no mapa (passar deliveryPoints originais para mapear shipmentIndex)
    renderFleetRoute(data.result, origin, deliveryPoints);
}

// Renderizar resultado da Fleet Routing API
async function renderFleetRoute(fleetResult, origin, deliveryPoints) {
    const route = fleetResult.routes[0];

    if (!route || !route.visits) {
        showToast(
            'Erro ao processar rota',
            'N√£o foi poss√≠vel obter rota otimizada',
            'error',
            5000
        );
        deactivateRouteMode();
        return;
    }

    // Criar lista de pontos otimizados (origem + visitas + volta √† origem)
    const allPoints = [origin];

    console.log(`üìç Processando ${route.visits.length} visitas na ordem otimizada...`);

    route.visits.forEach((visit, index) => {
        // A Fleet API retorna apenas o shipmentIndex, n√£o as coordenadas
        // Precisamos buscar as coordenadas nos deliveryPoints originais
        let shipmentIndex = visit.shipmentIndex;

        // Fallback: se shipmentIndex n√£o existe, extrair do shipmentLabel
        if (shipmentIndex === undefined && visit.shipmentLabel) {
            // shipmentLabel √© "Entrega N" -> extrair N e converter para √≠ndice (N-1)
            const match = visit.shipmentLabel.match(/Entrega (\d+)/);
            if (match) {
                shipmentIndex = parseInt(match[1]) - 1; // Label come√ßa em 1, √≠ndice em 0
                console.log(`üîÑ Usando label para obter √≠ndice: ${visit.shipmentLabel} -> √≠ndice ${shipmentIndex}`);
            }
        }

        if (shipmentIndex !== undefined && deliveryPoints[shipmentIndex]) {
            const point = deliveryPoints[shipmentIndex].location;
            allPoints.push({
                lat: point.lat,
                lng: point.lng
            });
            console.log(`‚úÖ Visita ${index + 1}: Entrega #${shipmentIndex + 1} - ${visit.shipmentLabel}`);
        } else {
            console.warn(`‚ö†Ô∏è Visita ${index} sem shipmentIndex v√°lido:`, visit);
        }
    });

    // Adicionar retorno √† origem
    allPoints.push(origin);

    console.log(`Rota otimizada com ${route.visits.length} pontos de entrega`);
    console.log(`Total de pontos na rota: ${allPoints.length} (incluindo origem e retorno)`);

    // Desenhar a rota DIRETAMENTE usando m√∫ltiplas requisi√ß√µes √† Directions API
    // Dividir em segmentos de at√© 25 pontos cada
    await drawRouteInSegments(allPoints, route.visits.length);
}

// Desenhar rota em m√∫ltiplos segmentos (para mais de 25 pontos)
async function drawRouteInSegments(allPoints, totalDeliveries) {
    console.log(`üîµ Desenhando rota com ${allPoints.length} pontos totais`);

    // PASSO 1: Limpar TODAS as rotas anteriores COMPLETAMENTE
    if (directionsRenderer) {
        directionsRenderer.setMap(null);
    }

    // PASSO 2: Limpar polylines antigas se existirem
    if (window.routePolylines && window.routePolylines.length > 0) {
        console.log(`üóëÔ∏è Removendo ${window.routePolylines.length} polylines antigas antes de desenhar...`);
        window.routePolylines.forEach(polyline => {
            try {
                polyline.setMap(null);
            } catch (e) {
                console.warn('Erro ao remover polyline antiga:', e);
            }
        });
    }

    // PASSO 3: Resetar array de polylines
    window.routePolylines = [];

    // Dividir pontos em segmentos de at√© 25 (origem + 23 waypoints + destino)
    const segments = [];
    const maxWaypoints = 23;

    for (let i = 0; i < allPoints.length - 1; i += maxWaypoints + 1) {
        const segmentStart = i;
        const segmentEnd = Math.min(i + maxWaypoints + 1, allPoints.length - 1);

        const origin = allPoints[segmentStart];
        const destination = allPoints[segmentEnd];
        const waypoints = [];

        for (let j = segmentStart + 1; j < segmentEnd; j++) {
            waypoints.push({
                location: allPoints[j],
                stopover: true
            });
        }

        segments.push({ origin, destination, waypoints });
    }

    console.log(`Rota dividida em ${segments.length} segmento(s)`);

    // Desenhar todos os segmentos
    const polylines = [];
    const bounds = new google.maps.LatLngBounds();
    let totalDistance = 0;
    let totalDuration = 0;

    for (let i = 0; i < segments.length; i++) {
        const segment = segments[i];

        try {
            const result = await new Promise((resolve, reject) => {
                directionsService.route({
                    origin: segment.origin,
                    destination: segment.destination,
                    waypoints: segment.waypoints,
                    optimizeWaypoints: false, // J√Å otimizado pela Fleet API
                    travelMode: google.maps.TravelMode.DRIVING
                }, (result, status) => {
                    if (status === 'OK') {
                        resolve(result);
                    } else {
                        reject(new Error(`Segment ${i + 1} failed: ${status}`));
                    }
                });
            });

            // Calcular dist√¢ncia e tempo
            result.routes[0].legs.forEach(leg => {
                totalDistance += leg.distance.value;
                totalDuration += leg.duration.value;
            });

            // Criar polyline para este segmento
            const path = result.routes[0].overview_path;
            const polyline = new google.maps.Polyline({
                path: path,
                strokeColor: '#4285f4',
                strokeWeight: 5,
                strokeOpacity: 0.7,
                map: map
            });

            polylines.push(polyline);

            // Expandir bounds
            path.forEach(point => bounds.extend(point));

            console.log(`Segmento ${i + 1}/${segments.length} desenhado: ${segment.waypoints.length + 2} pontos`);

        } catch (error) {
            console.error(`Erro no segmento ${i + 1}:`, error);
        }

        // Pequeno delay entre requisi√ß√µes para evitar rate limit
        if (i < segments.length - 1) {
            await new Promise(resolve => setTimeout(resolve, 300));
        }
    }

    // Armazenar polylines para limpeza posterior
    window.routePolylines = polylines;
    console.log(`‚úÖ ${polylines.length} polylines armazenadas para limpeza futura`);

    // Ajustar zoom para mostrar toda a rota com padding
    if (!bounds.isEmpty()) {
        map.fitBounds(bounds, {
            padding: 100 // Margem de 100px ao redor da rota
        });
        console.log('üó∫Ô∏è Mapa ajustado para mostrar toda a rota otimizada');
    }

    // Mostrar estat√≠sticas
    const distanceKm = (totalDistance / 1000).toFixed(1);
    const durationMin = Math.round(totalDuration / 60);

    showToast(
        '‚úì Rota otimizada completa!',
        `${totalDeliveries} entregas ‚Ä¢ ${distanceKm} km ‚Ä¢ ${durationMin} min`,
        'success',
        10000
    );

    console.log(`‚úì Rota completa: ${totalDeliveries} entregas, ${distanceKm}km, ${durationMin}min`);
}

// Fallback: Directions API (at√© 23 pontos)
async function calculateDirectionsRoute(origin, deliveryPoints) {
    console.log(`Usando Directions API (fallback) com limite de 23 pontos`);

    const nearestPoints = deliveryPoints
        .map(point => ({
            ...point,
            distance: google.maps.geometry.spherical.computeDistanceBetween(
                new google.maps.LatLng(origin.lat, origin.lng),
                new google.maps.LatLng(point.location.lat, point.location.lng)
            )
        }))
        .sort((a, b) => a.distance - b.distance)
        .slice(0, 23);

    const waypoints = nearestPoints.slice(0, -1).map(point => ({
        location: point.location,
        stopover: true
    }));

    const destination = nearestPoints[nearestPoints.length - 1].location;

    const request = {
        origin: origin,
        destination: destination,
        waypoints: waypoints,
        optimizeWaypoints: true,
        travelMode: google.maps.TravelMode.DRIVING
    };

    directionsService.route(request, (result, status) => {
        if (status === 'OK') {
            directionsRenderer.setDirections(result);

            let totalDistance = 0;
            let totalDuration = 0;

            result.routes[0].legs.forEach(leg => {
                totalDistance += leg.distance.value;
                totalDuration += leg.duration.value;
            });

            const distanceKm = (totalDistance / 1000).toFixed(1);
            const durationMin = Math.round(totalDuration / 60);
            const totalPoints = waypoints.length + 2;

            showToast(
                '‚úì Rota calculada (Directions API)!',
                `${totalPoints} pontos de entrega ‚Ä¢ ${distanceKm} km ‚Ä¢ ${durationMin} min`,
                'success',
                8000
            );

            const bounds = new google.maps.LatLngBounds();
            result.routes[0].overview_path.forEach(point => bounds.extend(point));
            map.fitBounds(bounds);
        } else {
            console.error('Erro ao calcular rota:', status);
            showToast('Erro ao calcular rota', 'Tente novamente', 'error', 5000);
            deactivateRouteMode();
        }
    });
}

// ===========================
// SCANNER DE PACOTES
// ===========================

const modalScanPackage = document.getElementById('modal-scan-package');
const btnScanPackage = document.getElementById('btn-scan-package');
const btnModalScanClose = document.getElementById('modal-scan-close');
const btnPackageClose = document.getElementById('btn-package-close');
const btnPackageStopCamera = document.getElementById('btn-package-stop-camera');
const btnPackageSwitchCamera = document.getElementById('btn-package-switch-camera');
const qrPackageCameraContainer = document.getElementById('qr-package-camera-container');
const qrPackageVideo = document.getElementById('qr-package-video');
const qrPackageCanvas = document.getElementById('qr-package-canvas');
const qrPackageStatus = document.getElementById('qr-package-status');
const scanResult = document.getElementById('scan-result');
const scanResultText = document.getElementById('scan-result-text');

let packageVideoStream = null;
let packageScanningInterval = null;
let packageCurrentFacingMode = 'environment';
let packageLastScannedCode = null;

// Abrir modal de scanner de pacotes
async function openPackageScanner() {
    modalScanPackage.classList.add('active');
    document.body.style.overflow = 'hidden';

    // Resetar resultado anterior
    scanResult.classList.remove('active');
    scanResultText.textContent = '';

    // Verificar se c√¢mera est√° dispon√≠vel
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        showToast(
            'C√¢mera n√£o dispon√≠vel',
            'Seu navegador n√£o suporta acesso √† c√¢mera',
            'error',
            5000
        );
        return;
    }

    // Abrir c√¢mera automaticamente
    try {
        await startPackageCamera();
    } catch (error) {
        console.error('Erro ao abrir c√¢mera:', error);

        let errorMessage = 'Verifique as permiss√µes do navegador';

        if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
            errorMessage = 'Permiss√£o negada. Permita o acesso √† c√¢mera nas configura√ß√µes do navegador.';
        } else if (error.name === 'NotFoundError' || error.name === 'DevicesNotFoundError') {
            errorMessage = 'Nenhuma c√¢mera encontrada no dispositivo.';
        } else if (error.name === 'NotReadableError' || error.name === 'TrackStartError') {
            errorMessage = 'C√¢mera j√° est√° em uso por outro aplicativo.';
        }

        showToast(
            'Erro ao abrir c√¢mera',
            errorMessage,
            'error',
            7000
        );
    }
}

// Fechar modal de scanner de pacotes
function closePackageScanner() {
    modalScanPackage.classList.remove('active');
    document.body.style.overflow = '';
    stopPackageCamera();
}

// Iniciar c√¢mera do scanner de pacotes
async function startPackageCamera() {
    stopPackageCamera();

    const constraints = {
        video: {
            facingMode: packageCurrentFacingMode,
            width: { ideal: 1280 },
            height: { ideal: 720 }
        }
    };

    try {
        packageVideoStream = await navigator.mediaDevices.getUserMedia(constraints);
        qrPackageVideo.srcObject = packageVideoStream;
        qrPackageCameraContainer.classList.add('active');

        return new Promise((resolve, reject) => {
            qrPackageVideo.onloadedmetadata = async () => {
                try {
                    await qrPackageVideo.play();
                    startPackageScanning();
                    resolve();
                } catch (playError) {
                    console.error('Erro ao iniciar reprodu√ß√£o do v√≠deo:', playError);
                    reject(playError);
                }
            };

            qrPackageVideo.onerror = (error) => {
                console.error('Erro no elemento de v√≠deo:', error);
                reject(error);
            };

            setTimeout(() => {
                if (qrPackageVideo.readyState < 2) {
                    reject(new Error('Timeout ao carregar v√≠deo'));
                }
            }, 10000);
        });

    } catch (error) {
        stopPackageCamera();
        qrPackageCameraContainer.classList.remove('active');
        throw error;
    }
}

// Parar c√¢mera do scanner de pacotes
function stopPackageCamera() {
    if (packageVideoStream) {
        packageVideoStream.getTracks().forEach(track => {
            track.stop();
            track.enabled = false;
        });
        packageVideoStream = null;
    }

    if (packageScanningInterval) {
        clearInterval(packageScanningInterval);
        packageScanningInterval = null;
    }

    qrPackageVideo.pause();
    qrPackageVideo.srcObject = null;
    qrPackageVideo.load();

    qrPackageVideo.onloadedmetadata = null;
    qrPackageVideo.onerror = null;

    qrPackageCameraContainer.classList.remove('active');
    qrPackageStatus.textContent = 'Procurando c√≥digo QR...';
    qrPackageStatus.classList.remove('success');
    packageLastScannedCode = null;
}

// Iniciar loop de scanning do pacote
function startPackageScanning() {
    const canvasContext = qrPackageCanvas.getContext('2d', { willReadFrequently: true });

    packageScanningInterval = setInterval(() => {
        if (qrPackageVideo.readyState === qrPackageVideo.HAVE_ENOUGH_DATA) {
            qrPackageCanvas.width = qrPackageVideo.videoWidth;
            qrPackageCanvas.height = qrPackageVideo.videoHeight;

            canvasContext.drawImage(qrPackageVideo, 0, 0, qrPackageCanvas.width, qrPackageCanvas.height);

            const imageData = canvasContext.getImageData(0, 0, qrPackageCanvas.width, qrPackageCanvas.height);

            const code = jsQR(imageData.data, imageData.width, imageData.height, {
                inversionAttempts: "dontInvert",
            });

            if (code && code.data !== packageLastScannedCode) {
                packageLastScannedCode = code.data;
                console.log('QR Code do pacote detectado:', code.data);

                qrPackageStatus.textContent = '‚úÖ C√≥digo detectado!';
                qrPackageStatus.classList.add('success');

                // Buscar cliente pelo c√≥digo QR
                findClientByQRCode(code.data);
            }
        }
    }, 100);
}

// Buscar cliente pelo c√≥digo QR do pacote
async function findClientByQRCode(qrCode) {
    try {
        // PASSO 1: Buscar o pacote na planilha do dia (delivery_data)
        const { data: deliveryData, error: deliveryError } = await supabase
            .from('delivery_data')
            .select('*')
            .eq('spx_tn', qrCode)
            .single();

        if (deliveryError && deliveryError.code !== 'PGRST116') {
            console.error('Erro ao buscar na planilha:', deliveryError);
        }

        if (!deliveryData) {
            // Pacote n√£o encontrado na planilha do dia
            scanResult.classList.add('active');
            scanResultText.innerHTML = `
                <strong style="color: #ea4335;">‚ùå Pacote n√£o encontrado</strong><br>
                O c√≥digo <code>${escapeHtml(qrCode)}</code> n√£o est√° na planilha do dia.
            `;

            showToast(
                'Pacote n√£o encontrado',
                'Este c√≥digo QR n√£o est√° na planilha de entregas do dia',
                'error',
                4000
            );

            // Resetar scanner
            setTimeout(() => {
                packageLastScannedCode = null;
                qrPackageStatus.textContent = 'Procurando c√≥digo QR...';
                qrPackageStatus.classList.remove('success');
            }, 3000);
            return;
        }

        // PASSO 2: Buscar clientes cadastrados
        const { data: clients, error: clientsError } = await supabase
            .from('clients')
            .select('*');

        if (clientsError) throw clientsError;

        if (!clients || clients.length === 0) {
            // Nenhum cliente cadastrado
            scanResult.classList.add('active');
            scanResultText.innerHTML = `
                <strong style="color: #ff9800;">‚ö†Ô∏è Nenhum cliente cadastrado</strong><br>
                Pacote encontrado na planilha, mas n√£o h√° clientes cadastrados para verificar.
            `;

            showToast(
                'Nenhum cliente cadastrado',
                'Adicione clientes para verificar correspond√™ncia',
                'warning',
                4000
            );

            setTimeout(() => {
                packageLastScannedCode = null;
                qrPackageStatus.textContent = 'Procurando c√≥digo QR...';
                qrPackageStatus.classList.remove('success');
            }, 3000);
            return;
        }

        // PASSO 3: Verificar se algum cliente tem endere√ßo que bate com o da planilha
        const deliveryAddress = (deliveryData.destination_address || '').toLowerCase().trim();

        let matchedClient = null;

        for (const client of clients) {
            const clientAddress = (client.address || '').toLowerCase().trim();

            // Verificar se os endere√ßos batem (compara√ß√£o flex√≠vel)
            if (clientAddress.includes(deliveryAddress) || deliveryAddress.includes(clientAddress)) {
                matchedClient = client;
                break;
            }

            // Verificar tamb√©m por coordenadas pr√≥ximas (mesma latitude/longitude)
            if (client.latitude && client.longitude && deliveryData.latitude && deliveryData.longitude) {
                const latDiff = Math.abs(client.latitude - deliveryData.latitude);
                const lngDiff = Math.abs(client.longitude - deliveryData.longitude);

                // Se diferen√ßa menor que 0.0001 graus (~11 metros), considera mesmo endere√ßo
                if (latDiff < 0.0001 && lngDiff < 0.0001) {
                    matchedClient = client;
                    break;
                }
            }
        }

        if (matchedClient) {
            // ‚úÖ CLIENTE ENCONTRADO - Endere√ßo bate!
            scanResult.classList.add('active');
            scanResultText.innerHTML = `
                <strong style="color: #4caf50;">‚úÖ Cliente encontrado!</strong><br>
                <strong>${escapeHtml(matchedClient.name)}</strong><br>
                üìû ${escapeHtml(matchedClient.phone || 'Sem telefone')}<br>
                üì¶ SPX TN: ${escapeHtml(qrCode)}<br>
                üìç ${escapeHtml(deliveryData.destination_address || 'Sem endere√ßo')}
            `;

            // Filtrar lista para mostrar apenas este cliente
            highlightClientInList(matchedClient);

            // Parar c√¢mera
            stopPackageCamera();

            // Toast de sucesso
            showToast(
                '‚úÖ Endere√ßo confirmado!',
                `Cliente: ${matchedClient.name}`,
                'success',
                3000
            );

            // Fechar modal ap√≥s 2 segundos
            setTimeout(() => {
                closePackageScanner();
            }, 2000);

        } else {
            // ‚ùå PACOTE NA PLANILHA MAS CLIENTE N√ÉO CADASTRADO
            scanResult.classList.add('active');
            scanResultText.innerHTML = `
                <strong style="color: #ff9800;">‚ö†Ô∏è Cliente n√£o cadastrado</strong><br>
                üì¶ SPX TN: ${escapeHtml(qrCode)}<br>
                üìç Endere√ßo da planilha:<br>
                ${escapeHtml(deliveryData.destination_address || 'Sem endere√ßo')}<br>
                <small style="color: #666;">Nenhum cliente cadastrado corresponde a este endere√ßo.</small>
            `;

            showToast(
                'Cliente n√£o cadastrado',
                'O pacote existe na planilha mas o cliente n√£o foi cadastrado ainda',
                'warning',
                4000
            );

            // Resetar scanner
            setTimeout(() => {
                packageLastScannedCode = null;
                qrPackageStatus.textContent = 'Procurando c√≥digo QR...';
                qrPackageStatus.classList.remove('success');
            }, 3000);
        }

    } catch (error) {
        console.error('Erro ao buscar cliente:', error);
        showToast(
            'Erro na busca',
            'N√£o foi poss√≠vel buscar o cliente',
            'error',
            4000
        );
    }
}

// Destacar cliente na lista
function highlightClientInList(client) {
    // Filtrar lista para mostrar apenas este cliente
    searchInput.value = client.name;

    // Disparar evento de busca
    const event = new Event('input', { bubbles: true });
    searchInput.dispatchEvent(event);

    // Scroll at√© o cliente na lista
    setTimeout(() => {
        const clientCard = document.querySelector(`[data-client-id="${client.id}"]`);
        if (clientCard) {
            clientCard.scrollIntoView({ behavior: 'smooth', block: 'center' });

            // Adicionar destaque visual tempor√°rio
            clientCard.style.animation = 'highlight-pulse 1.5s ease-in-out';

            setTimeout(() => {
                clientCard.style.animation = '';
            }, 1500);
        }
    }, 100);
}

// Event listeners do scanner de pacotes
btnScanPackage.addEventListener('click', openPackageScanner);
btnModalScanClose.addEventListener('click', closePackageScanner);
btnPackageClose.addEventListener('click', closePackageScanner);

btnPackageStopCamera.addEventListener('click', () => {
    stopPackageCamera();
});

btnPackageSwitchCamera.addEventListener('click', async () => {
    packageCurrentFacingMode = packageCurrentFacingMode === 'environment' ? 'user' : 'environment';
    stopPackageCamera();
    await startPackageCamera();
});

// Fechar modal ao clicar fora
modalScanPackage.addEventListener('click', (e) => {
    if (e.target === modalScanPackage) {
        closePackageScanner();
    }
});

// ===========================
// MOSTRAR/OCULTAR CLIENTES NO MAPA
// ===========================

const btnToggleClients = document.getElementById('btnToggleClients');
let clientMarkers = {};
let clientsVisible = false;

// Toggle clientes no mapa
btnToggleClients.addEventListener('click', async () => {
    if (clientsVisible) {
        // Ocultar clientes
        hideClientMarkers();
    } else {
        // Mostrar clientes
        await showClientMarkers();
    }
});

// Mostrar marcadores dos clientes cadastrados
async function showClientMarkers() {
    try {
        // Buscar todos os clientes do banco
        const { data: clients, error } = await supabase
            .from('clients')
            .select('*')
            .order('created_at', { ascending: true });

        if (error) throw error;

        if (!clients || clients.length === 0) {
            showToast(
                'Nenhum cliente cadastrado',
                'Adicione clientes para visualiz√°-los no mapa',
                'warning',
                3000
            );
            return;
        }

        // Criar marcador para cada cliente
        clients.forEach((client, index) => {
            if (!client.latitude || !client.longitude) {
                console.warn(`Cliente ${client.name} n√£o tem coordenadas v√°lidas`);
                return;
            }

            const position = { lat: client.latitude, lng: client.longitude };

            // Criar elemento do marcador com pin azul (diferente dos vermelhos de entrega)
            const markerDiv = document.createElement('div');
            markerDiv.style.cursor = 'pointer';
            markerDiv.style.transition = 'transform 0.2s';

            // Criar pin azul para clientes
            const pinImg = document.createElement('div');
            pinImg.style.width = '28px';
            pinImg.style.height = '28px';
            pinImg.style.background = '#2196F3';
            pinImg.style.border = '3px solid white';
            pinImg.style.borderRadius = '50% 50% 50% 0';
            pinImg.style.transform = 'rotate(-45deg)';
            pinImg.style.boxShadow = '0 2px 5px rgba(0,0,0,0.3)';
            pinImg.style.display = 'flex';
            pinImg.style.alignItems = 'center';
            pinImg.style.justifyContent = 'center';

            const innerCircle = document.createElement('div');
            innerCircle.style.width = '16px';
            innerCircle.style.height = '16px';
            innerCircle.style.background = 'white';
            innerCircle.style.borderRadius = '50%';
            innerCircle.style.transform = 'rotate(45deg)';
            innerCircle.style.fontSize = '10px';
            innerCircle.style.display = 'flex';
            innerCircle.style.alignItems = 'center';
            innerCircle.style.justifyContent = 'center';
            innerCircle.textContent = 'üë§';

            pinImg.appendChild(innerCircle);
            markerDiv.appendChild(pinImg);

            // Efeito hover
            markerDiv.addEventListener('mouseenter', () => {
                markerDiv.style.transform = 'scale(1.15)';
            });
            markerDiv.addEventListener('mouseleave', () => {
                markerDiv.style.transform = 'scale(1)';
            });

            // Criar InfoWindow
            const infoWindowContent = document.createElement('div');
            infoWindowContent.style.padding = '10px';
            infoWindowContent.style.maxWidth = '250px';

            const nameDiv = document.createElement('div');
            nameDiv.style.fontWeight = 'bold';
            nameDiv.style.fontSize = '14px';
            nameDiv.style.color = '#2196F3';
            nameDiv.style.marginBottom = '6px';
            nameDiv.textContent = `üë§ ${client.name}`;

            const phoneDiv = document.createElement('div');
            phoneDiv.style.fontSize = '12px';
            phoneDiv.style.color = '#666';
            phoneDiv.style.marginBottom = '4px';
            phoneDiv.innerHTML = `üìû ${client.phone || 'Sem telefone'}`;

            const addressDiv = document.createElement('div');
            addressDiv.style.fontSize = '12px';
            addressDiv.style.color = '#333';
            addressDiv.style.lineHeight = '1.4';
            addressDiv.innerHTML = `üìç ${client.address.replace(/\n/g, '<br>')}`;

            infoWindowContent.appendChild(nameDiv);
            infoWindowContent.appendChild(phoneDiv);
            infoWindowContent.appendChild(addressDiv);

            const infoWindow = new google.maps.InfoWindow({
                content: infoWindowContent,
                maxWidth: 280
            });

            try {
                // Criar marcador usando AdvancedMarkerElement
                if (google.maps.marker && google.maps.marker.AdvancedMarkerElement) {
                    const marker = new google.maps.marker.AdvancedMarkerElement({
                        map,
                        position,
                        content: markerDiv,
                        title: client.name
                    });

                    marker.addListener('click', () => {
                        if (currentInfoWindow) {
                            currentInfoWindow.close();
                        }
                        infoWindow.open(map, marker);
                        currentInfoWindow = infoWindow;
                        map.panTo(position);
                    });

                    clientMarkers[client.id] = marker;
                } else {
                    // Fallback: Marcador cl√°ssico
                    const marker = new google.maps.Marker({
                        map,
                        position,
                        title: client.name,
                        icon: {
                            path: google.maps.SymbolPath.CIRCLE,
                            fillColor: '#2196F3',
                            fillOpacity: 1,
                            strokeColor: 'white',
                            strokeWeight: 2,
                            scale: 8
                        }
                    });

                    marker.addListener('click', () => {
                        if (currentInfoWindow) {
                            currentInfoWindow.close();
                        }
                        infoWindow.open(map, marker);
                        currentInfoWindow = infoWindow;
                        map.panTo(position);
                    });

                    clientMarkers[client.id] = marker;
                }
            } catch (error) {
                console.error('Erro ao criar marcador:', error);
            }
        });

        clientsVisible = true;
        btnToggleClients.classList.add('active');

        showToast(
            `${clients.length} cliente${clients.length > 1 ? 's' : ''} exibido${clients.length > 1 ? 's' : ''}`,
            'Clientes cadastrados mostrados no mapa',
            'success',
            3000
        );

    } catch (error) {
        console.error('Erro ao carregar clientes:', error);
        showToast(
            'Erro ao carregar clientes',
            'N√£o foi poss√≠vel buscar os dados do banco',
            'error',
            4000
        );
    }
}

// Ocultar marcadores dos clientes
function hideClientMarkers() {
    Object.values(clientMarkers).forEach(marker => {
        try {
            if (marker.map !== undefined) {
                marker.map = null; // AdvancedMarkerElement
            } else if (marker.setMap) {
                marker.setMap(null); // Marker cl√°ssico
            }
        } catch (e) {
            console.warn('Erro ao remover marcador:', e);
        }
    });

    clientMarkers = {};
    clientsVisible = false;
    btnToggleClients.classList.remove('active');

    showToast(
        'Clientes ocultados',
        'Marcadores removidos do mapa',
        'info',
        2000
    );
}

// ===========================
// MOSTRAR CLIENTES IDENTIFICADOS NA PLANILHA
// ===========================

const btnShowMatchedClients = document.getElementById('btnShowMatchedClients');
let matchedClientMarkers = {};
let matchedClientsVisible = false;

// Toggle clientes identificados na planilha
btnShowMatchedClients.addEventListener('click', async () => {
    if (matchedClientsVisible) {
        hideMatchedClientMarkers();
    } else {
        await showMatchedClientMarkers();
    }
});

// Fun√ß√£o para normalizar endere√ßo (mesma usada na compara√ß√£o)
function normalizeAddressForComparison(address) {
    return address
        .toLowerCase()
        .trim()
        .replace(/\s+/g, ' ')
        .replace(/[.,;:\-]/g, ' ')
        .replace(/\s+/g, ' ')
        .trim();
}

// Mostrar marcadores dos clientes identificados na planilha
async function showMatchedClientMarkers() {
    try {
        // 1. Buscar dados da planilha (delivery_data) do Supabase
        const { data: deliveryData, error: deliveryError } = await supabase
            .from('delivery_data')
            .select('*');

        if (deliveryError) {
            console.error('Erro ao buscar delivery_data:', deliveryError);
            throw deliveryError;
        }

        if (!deliveryData || deliveryData.length === 0) {
            showToast(
                'Nenhuma planilha carregada',
                'Fa√ßa upload de uma planilha primeiro',
                'warning',
                4000
            );
            return;
        }

        // 2. Buscar todos os clientes do banco
        const { data: clients, error: clientsError } = await supabase
            .from('clients')
            .select('*')
            .order('created_at', { ascending: true });

        if (clientsError) throw clientsError;

        if (!clients || clients.length === 0) {
            showToast(
                'Nenhum cliente cadastrado',
                'N√£o h√° clientes para exibir',
                'warning',
                3000
            );
            return;
        }

        // 3. Criar Set de endere√ßos da planilha (normalizados)
        const deliveryAddresses = new Set();
        deliveryData.forEach(delivery => {
            const addr = delivery.destination_address || '';
            if (addr) {
                deliveryAddresses.add(normalizeAddressForComparison(addr));
            }
        });

        // 4. Filtrar apenas clientes cujos endere√ßos batem com a planilha
        const matchedClients = clients.filter(client => {
            const clientAddress = client.address || '';
            const clientAddressFirstLine = clientAddress.split('\n')[0];
            const normalizedClient = normalizeAddressForComparison(clientAddressFirstLine);

            return deliveryAddresses.has(normalizedClient);
        });

        if (matchedClients.length === 0) {
            showToast(
                'Nenhum cliente identificado',
                'Os endere√ßos da planilha n√£o correspondem aos clientes cadastrados',
                'warning',
                4000
            );
            return;
        }

        console.log(`üìç Mostrando ${matchedClients.length} clientes identificados na planilha`);

        // Criar marcador para cada cliente identificado
        matchedClients.forEach((client) => {
            if (!client.latitude || !client.longitude) {
                console.warn(`Cliente ${client.name} n√£o tem coordenadas v√°lidas`);
                return;
            }

            const position = { lat: client.latitude, lng: client.longitude };

            // Criar elemento do marcador com pin VERDE (para diferenciar)
            const markerDiv = document.createElement('div');
            markerDiv.style.cursor = 'pointer';
            markerDiv.style.transition = 'transform 0.2s';

            // Criar pin verde para clientes identificados na planilha
            const pinImg = document.createElement('div');
            pinImg.style.width = '32px';
            pinImg.style.height = '32px';
            pinImg.style.background = '#4CAF50'; // Verde
            pinImg.style.border = '3px solid white';
            pinImg.style.borderRadius = '50% 50% 50% 0';
            pinImg.style.transform = 'rotate(-45deg)';
            pinImg.style.boxShadow = '0 3px 6px rgba(0,0,0,0.4)';
            pinImg.style.display = 'flex';
            pinImg.style.alignItems = 'center';
            pinImg.style.justifyContent = 'center';

            const innerCircle = document.createElement('div');
            innerCircle.style.width = '18px';
            innerCircle.style.height = '18px';
            innerCircle.style.background = 'white';
            innerCircle.style.borderRadius = '50%';
            innerCircle.style.transform = 'rotate(45deg)';
            innerCircle.style.fontSize = '11px';
            innerCircle.style.display = 'flex';
            innerCircle.style.alignItems = 'center';
            innerCircle.style.justifyContent = 'center';
            innerCircle.textContent = '‚úì';

            pinImg.appendChild(innerCircle);
            markerDiv.appendChild(pinImg);

            // Efeito hover
            markerDiv.addEventListener('mouseenter', () => {
                markerDiv.style.transform = 'scale(1.2)';
            });
            markerDiv.addEventListener('mouseleave', () => {
                markerDiv.style.transform = 'scale(1)';
            });

            // Criar InfoWindow
            const infoWindowContent = document.createElement('div');
            infoWindowContent.style.padding = '12px';
            infoWindowContent.style.maxWidth = '280px';

            const badgeDiv = document.createElement('div');
            badgeDiv.style.background = '#4CAF50';
            badgeDiv.style.color = 'white';
            badgeDiv.style.padding = '4px 8px';
            badgeDiv.style.borderRadius = '4px';
            badgeDiv.style.fontSize = '11px';
            badgeDiv.style.fontWeight = 'bold';
            badgeDiv.style.marginBottom = '8px';
            badgeDiv.style.display = 'inline-block';
            badgeDiv.textContent = '‚úì IDENTIFICADO NA PLANILHA';

            const nameDiv = document.createElement('div');
            nameDiv.style.fontWeight = 'bold';
            nameDiv.style.fontSize = '14px';
            nameDiv.style.color = '#4CAF50';
            nameDiv.style.marginBottom = '6px';
            nameDiv.textContent = `üë§ ${client.name}`;

            const phoneDiv = document.createElement('div');
            phoneDiv.style.fontSize = '12px';
            phoneDiv.style.color = '#666';
            phoneDiv.style.marginBottom = '4px';
            phoneDiv.innerHTML = `üìû ${client.phone || 'Sem telefone'}`;

            const addressDiv = document.createElement('div');
            addressDiv.style.fontSize = '12px';
            addressDiv.style.color = '#333';
            addressDiv.style.lineHeight = '1.4';
            addressDiv.innerHTML = `üìç ${client.address.replace(/\n/g, '<br>')}`;

            infoWindowContent.appendChild(badgeDiv);
            infoWindowContent.appendChild(nameDiv);
            infoWindowContent.appendChild(phoneDiv);
            infoWindowContent.appendChild(addressDiv);

            const infoWindow = new google.maps.InfoWindow({
                content: infoWindowContent,
                maxWidth: 300
            });

            try {
                // Criar marcador usando AdvancedMarkerElement
                if (google.maps.marker && google.maps.marker.AdvancedMarkerElement) {
                    const marker = new google.maps.marker.AdvancedMarkerElement({
                        map,
                        position,
                        content: markerDiv,
                        title: client.name
                    });

                    marker.addListener('click', () => {
                        if (currentInfoWindow) {
                            currentInfoWindow.close();
                        }
                        infoWindow.open(map, marker);
                        currentInfoWindow = infoWindow;
                        map.panTo(position);
                    });

                    matchedClientMarkers[client.id] = marker;
                } else {
                    // Fallback: Marcador cl√°ssico
                    const marker = new google.maps.Marker({
                        map,
                        position,
                        title: client.name,
                        icon: {
                            path: google.maps.SymbolPath.CIRCLE,
                            fillColor: '#4CAF50',
                            fillOpacity: 1,
                            strokeColor: 'white',
                            strokeWeight: 2,
                            scale: 10
                        }
                    });

                    marker.addListener('click', () => {
                        if (currentInfoWindow) {
                            currentInfoWindow.close();
                        }
                        infoWindow.open(map, marker);
                        currentInfoWindow = infoWindow;
                        map.panTo(position);
                    });

                    matchedClientMarkers[client.id] = marker;
                }
            } catch (error) {
                console.error('Erro ao criar marcador:', error);
            }
        });

        matchedClientsVisible = true;
        btnShowMatchedClients.classList.add('active');

        showToast(
            `${matchedClients.length} cliente${matchedClients.length > 1 ? 's' : ''} identificado${matchedClients.length > 1 ? 's' : ''}`,
            'Clientes da planilha mostrados no mapa',
            'success',
            4000
        );

    } catch (error) {
        console.error('Erro ao carregar clientes identificados:', error);
        showToast(
            'Erro ao carregar',
            'N√£o foi poss√≠vel mostrar os clientes',
            'error',
            4000
        );
    }
}

// Ocultar marcadores dos clientes identificados
function hideMatchedClientMarkers() {
    Object.values(matchedClientMarkers).forEach(marker => {
        try {
            if (marker.map !== undefined) {
                marker.map = null; // AdvancedMarkerElement
            } else if (marker.setMap) {
                marker.setMap(null); // Marker cl√°ssico
            }
        } catch (e) {
            console.warn('Erro ao remover marcador:', e);
        }
    });

    matchedClientMarkers = {};
    matchedClientsVisible = false;
    btnShowMatchedClients.classList.remove('active');

    showToast(
        'Clientes identificados ocultados',
        'Marcadores removidos do mapa',
        'info',
        2000
    );
}

// ===========================
// UPLOAD DE PLANILHA
// ===========================

const modalUploadSpreadsheet = document.getElementById('modal-upload-spreadsheet');
const btnUploadSpreadsheet = document.getElementById('btnUploadSpreadsheet');
const btnModalUploadClose = document.getElementById('modal-upload-close');
const uploadArea = document.getElementById('upload-area');
const fileInput = document.getElementById('file-input');
const uploadProgress = document.getElementById('upload-progress');
const progressBar = document.getElementById('progress-bar');
const progressText = document.getElementById('progress-text');
const uploadResult = document.getElementById('upload-result');
const resultIcon = document.getElementById('result-icon');
const resultText = document.getElementById('result-text');
const resultDetails = document.getElementById('result-details');

// Abrir modal de upload
function openUploadModal() {
    modalUploadSpreadsheet.classList.add('active');
    document.body.style.overflow = 'hidden';

    // Resetar estados
    uploadArea.style.display = 'block';
    uploadProgress.style.display = 'none';
    uploadResult.style.display = 'none';
    progressBar.style.width = '0%';
    fileInput.value = '';
}

// Fechar modal de upload
function closeUploadModal() {
    modalUploadSpreadsheet.classList.remove('active');
    document.body.style.overflow = '';
}

// Vari√°vel para controlar estado do bot√£o
let hasSpreadsheetData = false;

// Event listeners do modal
btnUploadSpreadsheet.addEventListener('click', () => {
    if (hasSpreadsheetData) {
        // Se h√° planilha carregada, limpar dados
        clearSpreadsheetData();
    } else {
        // Se n√£o h√° planilha, abrir modal de upload
        openUploadModal();
    }
});
btnModalUploadClose.addEventListener('click', closeUploadModal);

// Fun√ß√£o para mudar bot√£o para modo "Limpar planilha"
function setButtonToClearMode() {
    hasSpreadsheetData = true;
    btnUploadSpreadsheet.textContent = 'üóëÔ∏è';
    btnUploadSpreadsheet.title = 'Limpar planilha do dia';
    btnUploadSpreadsheet.classList.add('active');
}

// Fun√ß√£o para mudar bot√£o para modo "Upload planilha"
function setButtonToUploadMode() {
    hasSpreadsheetData = false;
    btnUploadSpreadsheet.textContent = 'üìä';
    btnUploadSpreadsheet.title = 'Atualizar planilha do dia';
    btnUploadSpreadsheet.classList.remove('active');
}

// Fun√ß√£o para limpar dados da planilha
async function clearSpreadsheetData() {
    // Criar modal de confirma√ß√£o customizado
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    modal.style.position = 'fixed';
    modal.style.top = '0';
    modal.style.left = '0';
    modal.style.right = '0';
    modal.style.bottom = '0';
    modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
    modal.style.display = 'flex';
    modal.style.alignItems = 'center';
    modal.style.justifyContent = 'center';
    modal.style.zIndex = '10000';

    modal.innerHTML = `
        <div style="background: white; padding: 24px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); max-width: 400px; width: 90%;">
            <div style="font-size: 20px; font-weight: 600; color: #333; margin-bottom: 16px;">‚ö†Ô∏è Confirmar exclus√£o</div>
            <div style="color: #666; margin-bottom: 20px; line-height: 1.6;">
                <p style="margin-bottom: 12px;">Tem certeza que deseja limpar todos os dados da planilha?</p>
                <p style="margin-bottom: 8px; font-weight: 600;">Isso ir√° remover:</p>
                <ul style="margin-left: 20px;">
                    <li>‚úì Todos os dados de entrega</li>
                    <li>‚úì Marcadores no mapa</li>
                    <li>‚úì Rotas planejadas</li>
                </ul>
                <p style="margin-top: 12px; color: #e53e3e; font-weight: 600;">‚ö†Ô∏è Essa a√ß√£o n√£o pode ser desfeita!</p>
            </div>
            <div style="display: flex; justify-content: flex-end; gap: 12px;">
                <button id="btn-cancel-clear" style="padding: 10px 20px; background: #e5e7eb; color: #333; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">Cancelar</button>
                <button id="btn-confirm-clear" style="padding: 10px 20px; background: #dc2626; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">Limpar tudo</button>
            </div>
        </div>
    `;

    document.body.appendChild(modal);

    // Criar promise para aguardar resposta do usu√°rio
    const userResponse = await new Promise((resolve) => {
        const btnCancel = modal.querySelector('#btn-cancel-clear');
        const btnConfirm = modal.querySelector('#btn-confirm-clear');

        btnCancel.addEventListener('click', () => {
            modal.remove();
            resolve(false);
        });

        btnConfirm.addEventListener('click', () => {
            modal.remove();
            resolve(true);
        });

        // Clicar fora do modal cancela
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.remove();
                resolve(false);
            }
        });
    });

    if (!userResponse) {
        return;
    }

    try {
        // Limpar dados da planilha do Supabase
        const { error: deleteError } = await supabase
            .from('delivery_data')
            .delete()
            .neq('id', '00000000-0000-0000-0000-000000000000');

        if (deleteError) {
            console.error('Erro ao limpar delivery_data:', deleteError);
            showToast(
                'Erro ao limpar planilha',
                'N√£o foi poss√≠vel remover os dados',
                'error',
                4000
            );
            return;
        }

        // Limpar marcadores do mapa
        Object.values(deliveryMarkers).forEach(marker => {
            try {
                if (marker.map !== undefined) {
                    marker.map = null;
                } else if (marker.setMap) {
                    marker.setMap(null);
                }
            } catch (e) {
                console.warn('Erro ao remover marcador:', e);
            }
        });
        deliveryMarkers = {};

        // Limpar rotas
        if (directionsRenderer) {
            directionsRenderer.setDirections({routes: []});
            directionsRenderer.setMap(null);
        }
        if (window.routePolylines) {
            window.routePolylines.forEach(polyline => polyline.setMap(null));
            window.routePolylines = [];
        }

        // Voltar bot√£o para modo upload
        setButtonToUploadMode();

        showToast(
            'üóëÔ∏è Planilha limpa!',
            'Todos os dados foram removidos. Sistema pronto para nova planilha.',
            'success',
            4000
        );

        console.log('‚úÖ Planilha limpa com sucesso');

    } catch (error) {
        console.error('Erro ao limpar planilha:', error);
        showToast(
            'Erro ao limpar',
            'Ocorreu um erro ao limpar os dados',
            'error',
            4000
        );
    }
}

modalUploadSpreadsheet.addEventListener('click', (e) => {
    if (e.target === modalUploadSpreadsheet) {
        closeUploadModal();
    }
});

// Click na √°rea de upload
uploadArea.addEventListener('click', () => {
    fileInput.click();
});

// Drag and drop
uploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadArea.classList.add('dragover');
});

uploadArea.addEventListener('dragleave', () => {
    uploadArea.classList.remove('dragover');
});

uploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadArea.classList.remove('dragover');

    const files = e.dataTransfer.files;
    if (files.length > 0) {
        handleFile(files[0]);
    }
});

// Sele√ß√£o de arquivo
fileInput.addEventListener('change', (e) => {
    const files = e.target.files;
    if (files.length > 0) {
        handleFile(files[0]);
    }
});

// Processar arquivo
async function handleFile(file) {
    const fileName = file.name.toLowerCase();

    // Validar tipo de arquivo
    if (!fileName.endsWith('.xlsx') && !fileName.endsWith('.xls') && !fileName.endsWith('.csv')) {
        showToast(
            'Formato inv√°lido',
            'Por favor, selecione um arquivo Excel (.xlsx, .xls) ou CSV (.csv)',
            'error',
            5000
        );
        return;
    }

    // Mostrar progresso
    uploadArea.style.display = 'none';
    uploadProgress.style.display = 'block';
    progressBar.style.width = '30%';
    progressText.textContent = 'Lendo arquivo...';

    try {
        const data = await file.arrayBuffer();
        progressBar.style.width = '50%';
        progressText.textContent = 'Processando dados...';

        // Processar planilha
        const workbook = XLSX.read(data, { type: 'array' });
        const sheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[sheetName];
        const jsonData = XLSX.utils.sheet_to_json(worksheet);

        progressBar.style.width = '70%';
        progressText.textContent = 'Atualizando banco de dados...';

        // Processar e salvar dados
        const result = await processSpreadsheetData(jsonData);

        progressBar.style.width = '100%';
        progressText.textContent = 'Conclu√≠do!';

        // Mostrar resultado de sucesso
        setTimeout(() => {
            uploadProgress.style.display = 'none';
            uploadResult.style.display = 'block';
            resultIcon.textContent = '‚úÖ';
            resultText.textContent = 'Planilha atualizada com sucesso!';
            resultText.style.color = '#4caf50';

            // Exibir estat√≠sticas de compara√ß√£o de endere√ßos
            let detailsHTML = `${result.count} registros processados<br><br>`;
            detailsHTML += `<strong>üìä An√°lise de Endere√ßos:</strong><br>`;
            detailsHTML += `‚úÖ <strong>${result.matchedCount}</strong> endere√ßo${result.matchedCount !== 1 ? 's' : ''} j√° cadastrado${result.matchedCount !== 1 ? 's' : ''}<br>`;
            detailsHTML += `‚ö†Ô∏è <strong>${result.notRegisteredCount}</strong> endere√ßo${result.notRegisteredCount !== 1 ? 's' : ''} n√£o cadastrado${result.notRegisteredCount !== 1 ? 's' : ''}`;

            resultDetails.innerHTML = detailsHTML;

            // Fechar modal ap√≥s 5 segundos (tempo maior para ler as estat√≠sticas)
            setTimeout(() => {
                closeUploadModal();

                // Recarregar dados
                loadClients();

                // Mudar bot√£o para modo "Limpar planilha"
                setButtonToClearMode();

                showToast(
                    'Planilha atualizada!',
                    `${result.matchedCount} cadastrados, ${result.notRegisteredCount} n√£o cadastrados`,
                    'success',
                    5000
                );
            }, 5000);
        }, 500);

    } catch (error) {
        console.error('Erro ao processar planilha:', error);

        uploadProgress.style.display = 'none';
        uploadResult.style.display = 'block';
        resultIcon.textContent = '‚ùå';
        resultText.textContent = 'Erro ao processar planilha';
        resultText.style.color = '#ea4335';
        resultDetails.textContent = error.message || 'Verifique o formato do arquivo';

        showToast(
            'Erro no upload',
            'N√£o foi poss√≠vel processar a planilha',
            'error',
            5000
        );
    }
}

// Processar dados da planilha e salvar no Supabase
async function processSpreadsheetData(jsonData) {
    try {
        if (!jsonData || jsonData.length === 0) {
            throw new Error('Planilha vazia ou sem dados v√°lidos');
        }

        console.log('Processando', jsonData.length, 'linhas da planilha...');

        // 1. Limpar tabela delivery_data
        const { error: deleteDeliveryError } = await supabase
            .from('delivery_data')
            .delete()
            .neq('id', '00000000-0000-0000-0000-000000000000');

        if (deleteDeliveryError) {
            console.warn('Erro ao limpar delivery_data (talvez a tabela n√£o exista ainda):', deleteDeliveryError);
        }

        // 2. Limpar rotas existentes
        if (typeof currentRoute !== 'undefined' && currentRoute) {
            currentRoute.setMap(null);
            currentRoute = null;
        }
        if (typeof directionsRenderer !== 'undefined' && directionsRenderer) {
            directionsRenderer.setMap(null);
        }
        if (typeof window.routePolylines !== 'undefined' && window.routePolylines) {
            window.routePolylines.forEach(polyline => polyline.setMap(null));
            window.routePolylines = [];
        }

        // 3. Processar dados da planilha
        const deliveryDataRecords = [];

        for (const row of jsonData) {
            // Mapear colunas da planilha para o banco
            const spxTn = row['SPX TN'] || row['spx_tn'] || row['QR Code'] || '';
            const destinationAddress = row['Destination Address'] || row['destination_address'] || row['Endere√ßo'] || '';
            const bairro = row['Bairro'] || row['bairro'] || '';
            const city = row['City'] || row['city'] || row['Cidade'] || '';
            const zipcode = row['Zipcode/Postal code'] || row['zipcode'] || row['CEP'] || '';
            const latitude = parseFloat(row['Latitude'] || row['latitude'] || 0);
            const longitude = parseFloat(row['Longitude'] || row['longitude'] || 0);
            const sequence = parseInt(row['Sequence'] || row['sequence'] || 0);

            if (!spxTn) {
                console.warn('Linha sem SPX TN, pulando:', row);
                continue;
            }

            deliveryDataRecords.push({
                spx_tn: spxTn,
                destination_address: destinationAddress,
                bairro: bairro,
                city: city,
                zipcode: zipcode,
                latitude: latitude || null,
                longitude: longitude || null,
                sequence: sequence || null
            });
        }

        if (deliveryDataRecords.length === 0) {
            throw new Error('Nenhum registro v√°lido encontrado na planilha. Verifique se as colunas est√£o corretas: SPX TN, Destination Address, Bairro, City, Zipcode/Postal code, Latitude, Longitude');
        }

        // 4. Inserir na tabela delivery_data
        const { data: insertedData, error: insertDeliveryError } = await supabase
            .from('delivery_data')
            .insert(deliveryDataRecords)
            .select();

        if (insertDeliveryError) {
            console.error('Erro ao inserir em delivery_data:', insertDeliveryError);
            throw new Error(`Erro ao salvar na tabela delivery_data: ${insertDeliveryError.message}`);
        }

        console.log(`‚úì ${deliveryDataRecords.length} registros salvos na tabela delivery_data`);

        // 5. Buscar clientes cadastrados para compara√ß√£o
        const { data: clients, error: clientsError } = await supabase
            .from('clients')
            .select('*');

        if (clientsError) {
            console.warn('Erro ao buscar clientes:', clientsError);
        }

        // 6. Comparar endere√ßos da planilha com clientes cadastrados (APENAS endere√ßo)
        // Usar Sets para contar ENDERE√áOS √öNICOS (n√£o pacotes duplicados)
        const matchedAddresses = new Set();
        const notRegisteredAddresses = new Set();

        // Fun√ß√£o para normalizar endere√ßo (remove espa√ßos extras, pontua√ß√£o, lowercase)
        const normalizeAddress = (address) => {
            return address
                .toLowerCase()
                .trim()
                // Remove m√∫ltiplos espa√ßos
                .replace(/\s+/g, ' ')
                // Remove pontua√ß√£o (v√≠rgulas, pontos, etc.)
                .replace(/[.,;:\-]/g, ' ')
                // Remove espa√ßos novamente ap√≥s remover pontua√ß√£o
                .replace(/\s+/g, ' ')
                .trim();
        };

        if (clients && clients.length > 0) {
            console.log(`üîç Iniciando compara√ß√£o de ${deliveryDataRecords.length} pacotes da planilha com ${clients.length} clientes cadastrados...`);

            for (const delivery of deliveryDataRecords) {
                const deliveryAddress = delivery.destination_address || '';
                const normalizedDelivery = normalizeAddress(deliveryAddress);

                // Pular endere√ßos vazios
                if (!normalizedDelivery) continue;

                let isMatched = false;

                // Verificar se o endere√ßo da planilha bate com algum cliente cadastrado
                for (const client of clients) {
                    const clientAddress = client.address || '';

                    // Extrair APENAS a primeira linha do endere√ßo (antes do \n que separa bairro/cidade)
                    const clientAddressFirstLine = clientAddress.split('\n')[0];
                    const normalizedClient = normalizeAddress(clientAddressFirstLine);

                    // Compara√ß√£o APENAS por endere√ßo normalizado (ignora nome, telefone, bairro, cidade, CEP)
                    if (normalizedClient && normalizedDelivery && normalizedClient === normalizedDelivery) {
                        isMatched = true;

                        // Adicionar ao Set de endere√ßos cadastrados (n√£o duplica)
                        if (!matchedAddresses.has(normalizedDelivery)) {
                            console.log(`‚úÖ MATCH: "${deliveryAddress}" === "${clientAddressFirstLine}"`);
                            matchedAddresses.add(normalizedDelivery);
                        }
                        break;
                    }
                }

                if (!isMatched && deliveryAddress) {
                    // Adicionar ao Set de endere√ßos n√£o cadastrados (n√£o duplica)
                    if (!notRegisteredAddresses.has(normalizedDelivery)) {
                        console.log(`‚ö†Ô∏è NO MATCH: "${deliveryAddress}"`);
                        notRegisteredAddresses.add(normalizedDelivery);
                    }
                }
            }
        } else {
            // Se n√£o h√° clientes cadastrados, contar endere√ßos √∫nicos da planilha
            const uniqueAddresses = new Set();
            deliveryDataRecords.forEach(delivery => {
                const normalized = normalizeAddress(delivery.destination_address || '');
                if (normalized) {
                    uniqueAddresses.add(normalized);
                }
            });
            uniqueAddresses.forEach(addr => notRegisteredAddresses.add(addr));
        }

        const matchedCount = matchedAddresses.size;
        const notRegisteredCount = notRegisteredAddresses.size;

        console.log(`üìä An√°lise de endere√ßos:`);
        console.log(`   ‚úÖ Cadastrados: ${matchedCount}`);
        console.log(`   ‚ö†Ô∏è N√£o cadastrados: ${notRegisteredCount}`);

        // Armazenar endere√ßos matched globalmente para uso posterior
        window.matchedAddressesFromSpreadsheet = Array.from(matchedAddresses);

        return {
            success: true,
            count: deliveryDataRecords.length,
            matchedCount: matchedCount,
            notRegisteredCount: notRegisteredCount,
            matchedAddresses: Array.from(matchedAddresses),
            message: `${deliveryDataRecords.length} registros salvos com sucesso`
        };

    } catch (error) {
        console.error('Erro ao processar dados da planilha:', error);
        throw error;
    }
}

// ===========================
// CLEANUP
// ===========================

window.addEventListener('beforeunload', () => {
    if (watchId) navigator.geolocation.clearWatch(watchId);
});

// Resetar bot√µes quando usu√°rio volta de app externo (tel: ou whatsapp:)
window.addEventListener('pageshow', function(event) {
    // Executar reset quando p√°gina √© mostrada novamente
    if (event.persisted || performance.getEntriesByType('navigation')[0]?.type === 'back_forward') {
        resetPhoneButtonsFocus();
    }
    // Reset tamb√©m ao voltar de link externo
    setTimeout(() => {
        resetPhoneButtonsFocus();
    }, 100);
});

// Tratamento de erro de carregamento do mapa
window.addEventListener('error', (e) => {
    if (e.message.includes('Google Maps')) {
        hideLoadingScreen();
        showToast(
            'Erro ao carregar mapa',
            'Verifique sua conex√£o com a internet',
            'error',
            8000
        );
    }
}, true);
</script>

</body>
</html>
