<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>Mapa de Clientes - Google Maps</title>

<style>
    body,html{
        margin:0;
        padding:0;
        height:100%;
        width:100%;
        font-family:sans-serif;
        overflow:hidden;
    }

    #map{
        height:100%;
        width:100%;
        position:absolute;
        top:0;left:0;
    }

    /* bot√µes */
    .map-control{
        position:fixed;
        top:90px;
        right:20px;
        display:flex;
        flex-direction:column;
        gap:10px;
        z-index:9999;
    }
    .control-btn{
        width:48px;
        height:48px;
        border-radius:50%;
        border:none;
        background:white;
        box-shadow:0 2px 6px rgba(0,0,0,0.3);
        font-size:18px;
        cursor:pointer;
    }

    /* === üîµ MARCADOR OFICIAL DO GOOGLE MAPS === */
    .gm-blue-dot-wrapper {
        width:40px;
        height:40px;
        position:relative;
        transform:translate(-50%,-50%);
    }

    .gm-blue-dot {
        width:22px;
        height:22px;
        background:#1a73e8;           /* azul padr√£o Google */
        border-radius:50%;
        border:4px solid #ffffff;     /* borda branca */
        position:absolute;
        top:9px;
        left:9px;
        box-shadow:0 2px 6px rgba(0,0,0,.5);
    }

    .gm-blue-center {
        width:8px;
        height:8px;
        background:white;
        border-radius:50%;
        position:absolute;
        top:50%;
        left:50%;
        transform:translate(-50%,-50%);
    }

</style>
</head>
<body>

<div id="map"></div>

<!-- bot√µes -->
<div class="map-control">
    <button id="btnToggle3D" class="control-btn">3D</button>
    <button id="btnCenterUser" class="control-btn">üìç</button>
</div>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
const SUPABASE_URL = "https://fufteldeapyvluynppuv.supabase.co";
const SUPABASE_ANON_KEY =
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ1ZnRlbGRlYXB5dmx1eW5wcHV2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2MzAyMzIsImV4cCI6MjA4MDIwNjIzMn0.xr6PiskP8cJUzGBEhp_tAfZWMprxJXJyhLuOSmCQleA";

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
</script>

<!-- Google Maps -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyApaDb9rSw2sNTaY7fjBqmrgjWYD9xwjcU&callback=initMap&v=beta"
        async defer></script>

<script>
let map;
let userMarker = null;
let watchId = null;
let useGyro = false;
let currentHeading = 0;
let is3D = false;
let animating3D = false;

/* cria ponto azul oficial */
function createBlueDot() {
    const wrap = document.createElement("div");
    wrap.className = "gm-blue-dot-wrapper";

    const dot = document.createElement("div");
    dot.className = "gm-blue-dot";

    const center = document.createElement("div");
    center.className = "gm-blue-center";

    dot.appendChild(center);
    wrap.appendChild(dot);

    return wrap;
}

/* girosc√≥pio */
function enableGyro() {
    if (window.DeviceOrientationEvent &&
        typeof DeviceOrientationEvent.requestPermission === "function") {

        DeviceOrientationEvent.requestPermission().then(res=>{
            if (res === "granted") {
                useGyro = true;
                window.addEventListener("deviceorientation", onGyro);
            }
        });

    } else {
        useGyro = true;
        window.addEventListener("deviceorientation", onGyro);
    }
}

function onGyro(ev){
    if (!useGyro) return;
    if (ev.alpha != null) {
        currentHeading = ev.alpha;
        map.setHeading(currentHeading);
    }
}

/* anima√ß√£o suave */
function lerp(a,b,t){ return a+(b-a)*t; }

function animateMarkerTo(marker,newPos,duration=450){
    const start = marker.getPosition();
    const sLat = start.lat();
    const sLng = start.lng();
    const eLat = newPos.lat();
    const eLng = newPos.lng();

    const t0 = performance.now();

    function step(t){
        const p = Math.min((t-t0)/duration,1);
        const lat = lerp(sLat,eLat,p);
        const lng = lerp(sLng,eLng,p);
        marker.setPosition({lat,lng});
        if (p < 1) requestAnimationFrame(step);
    }
    requestAnimationFrame(step);
}

/* GPS */
function startGPS(){
    if (!navigator.geolocation) return;

    const opt = {
        enableHighAccuracy:true,
        timeout:10000,
        maximumAge:0
    };

    navigator.geolocation.getCurrentPosition(pos=>{
        const c = {lat:pos.coords.latitude,lng:pos.coords.longitude};

        map.setCenter(c);

        userMarker = new google.maps.Marker({
            map,
            position:c,
            icon:{ element:createBlueDot() }
        });

        watchId = navigator.geolocation.watchPosition(updateUser,()=>{},opt);

    },()=>{},opt);
}

function updateUser(pos){
    const c = new google.maps.LatLng(pos.coords.latitude,pos.coords.longitude);
    animateMarkerTo(userMarker,c);
    map.panTo(c);

    if (!useGyro && pos.coords.heading != null){
        map.setHeading(pos.coords.heading);
    }
}

/* centralizar */
function centerUser(){
    if (!userMarker) return;
    map.panTo(userMarker.getPosition());
}
document.getElementById("btnCenterUser").onclick = centerUser;

/* 2D / 3D */
function animateValue(start,end,dur,onUpdate,onFinish){
    const t0 = performance.now();
    function frame(t){
        const p = Math.min((t-t0)/dur,1);
        onUpdate(start+(end-start)*p);
        if (p < 1) requestAnimationFrame(frame);
        else if (onFinish) onFinish();
    }
    requestAnimationFrame(frame);
}

document.getElementById("btnToggle3D").onclick = ()=>{
    if (animating3D) return;
    animating3D = true;

    if (!is3D){
        is3D = true;
        btnToggle3D.textContent = "2D";

        animateValue(map.getTilt(),67,800,val=>map.setTilt(val));
        animateValue(map.getHeading(),45,800,val=>map.setHeading(val),
            ()=>animating3D=false);

    } else {
        is3D = false;
        btnToggle3D.textContent = "3D";

        animateValue(map.getTilt(),0,800,val=>map.setTilt(val));
        animateValue(map.getHeading(),0,800,val=>map.setHeading(val),
            ()=>animating3D=false);
    }
};

/* iniciar mapa */
function initMap(){
    map = new google.maps.Map(document.getElementById("map"),{
        center:{lat:-23.55,lng:-46.63},
        zoom:17,
        tilt:0,
        heading:0,
        mapId:"ebb7ca4503045feabc75b373",
        gestureHandling:"greedy"
    });

    enableGyro();
    startGPS();
}
</script>
</body>
</html>