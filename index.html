<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Mapa de Clientes - Google Maps</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìç</text></svg>">

<style>
    :root {
        --primary-color: #4285f4;
        --success-color: #34a853;
        --warning-color: #fbbc04;
        --error-color: #ea4335;
        --bg-overlay: rgba(0, 0, 0, 0.5);
        --shadow-sm: 0 2px 6px rgba(0,0,0,0.3);
        --shadow-lg: 0 4px 12px rgba(0,0,0,0.4);
    }

    body, html {
        margin: 0;
        padding: 0;
        height: 100%;
        width: 100%;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        overflow: hidden;
    }

    #map {
        height: 100%;
        width: 100%;
        position: absolute;
        top: 0;
        left: 0;
        opacity: 0;
        transition: opacity 0.5s ease-in-out;
        /* Acelera√ß√£o por hardware */
        transform: translateZ(0);
        will-change: transform;
        backface-visibility: hidden;
    }

    #map.loaded {
        opacity: 1;
    }

    /* ===========================
       LOADING SCREEN
       =========================== */
    #loading-screen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        transition: opacity 0.5s ease-in-out, visibility 0.5s;
    }

    #loading-screen.hidden {
        opacity: 0;
        visibility: hidden;
    }

    .loading-content {
        text-align: center;
        color: white;
    }

    .spinner {
        width: 60px;
        height: 60px;
        margin: 0 auto 24px;
        position: relative;
    }

    .spinner::before {
        content: '';
        box-sizing: border-box;
        position: absolute;
        top: 50%;
        left: 50%;
        width: 60px;
        height: 60px;
        margin-top: -30px;
        margin-left: -30px;
        border-radius: 50%;
        border: 4px solid rgba(255, 255, 255, 0.2);
        border-top-color: white;
        animation: spinner 0.8s linear infinite;
    }

    @keyframes spinner {
        to { transform: rotate(360deg); }
    }

    .loading-text {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 8px;
        animation: pulse-text 2s ease-in-out infinite;
    }

    .loading-subtext {
        font-size: 14px;
        opacity: 0.9;
        font-weight: 400;
    }

    @keyframes pulse-text {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.6; }
    }

    /* ===========================
       CONTROLES DO MAPA
       =========================== */
    .map-control {
        position: fixed;
        top: 90px;
        right: 20px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        z-index: 9999;
        opacity: 0;
        transform: translateX(100px);
        transition: opacity 0.5s ease-in-out 0.3s, transform 0.5s ease-in-out 0.3s;
    }

    .map-control.visible {
        opacity: 1;
        transform: translateX(0);
    }

    .control-btn {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        border: none;
        background: white;
        box-shadow: var(--shadow-sm);
        font-size: 18px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        position: relative;
        color: #333;
    }

    .control-btn:hover {
        box-shadow: var(--shadow-lg);
        transform: translateY(-2px);
    }

    .control-btn:active {
        transform: translateY(0) scale(0.95);
    }

    .control-btn.active {
        background: var(--primary-color);
        color: white;
    }

    .control-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none !important;
    }

    /* Indicador de carregamento no bot√£o */
    .control-btn.loading::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 20px;
        height: 20px;
        margin-top: -10px;
        margin-left: -10px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-top-color: white;
        border-radius: 50%;
        animation: spinner 0.6s linear infinite;
    }

    .control-btn.loading {
        color: transparent;
    }

    /* ===========================
       MARCADOR DA LOCALIZA√á√ÉO
       =========================== */
    .location-marker {
        width: 20px;
        height: 20px;
        background: var(--primary-color);
        border: 3px solid white;
        border-radius: 50%;
        box-shadow: 0 2px 6px rgba(0,0,0,0.4);
        position: relative;
    }

    .location-marker::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 8px;
        height: 8px;
        background: white;
        border-radius: 50%;
    }

    @keyframes pulse {
        0% { box-shadow: 0 0 0 0 rgba(66,133,244,0.7); }
        70% { box-shadow: 0 0 0 10px rgba(66,133,244,0); }
        100% { box-shadow: 0 0 0 0 rgba(66,133,244,0); }
    }

    .location-marker.active {
        animation: pulse 2s infinite;
    }

    /* ===========================
       SISTEMA DE NOTIFICA√á√ïES
       =========================== */
    #toast-container {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 10001;
        display: flex;
        flex-direction: column;
        gap: 10px;
        max-width: 90%;
        width: 400px;
    }

    .toast {
        background: white;
        padding: 16px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        display: flex;
        align-items: center;
        gap: 12px;
        animation: slideDown 0.3s ease-out;
        border-left: 4px solid var(--primary-color);
    }

    .toast.success { border-left-color: var(--success-color); }
    .toast.warning { border-left-color: var(--warning-color); }
    .toast.error { border-left-color: var(--error-color); }

    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .toast.hiding {
        animation: slideUp 0.3s ease-out forwards;
    }

    @keyframes slideUp {
        from {
            opacity: 1;
            transform: translateY(0);
        }
        to {
            opacity: 0;
            transform: translateY(-20px);
        }
    }

    .toast-icon {
        font-size: 20px;
        flex-shrink: 0;
    }

    .toast-content {
        flex: 1;
    }

    .toast-title {
        font-weight: 600;
        margin-bottom: 4px;
        color: #333;
    }

    .toast-message {
        font-size: 14px;
        color: #666;
    }

    /* ===========================
       STATUS BAR
       =========================== */
    #status-bar {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        padding: 12px 20px;
        border-radius: 24px;
        box-shadow: var(--shadow-sm);
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 14px;
        color: #333;
        z-index: 9999;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    #status-bar.visible {
        opacity: 1;
    }

    .status-indicator {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--success-color);
        animation: blink 2s infinite;
    }

    @keyframes blink {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.3; }
    }

    .status-indicator.inactive {
        background: #ccc;
        animation: none;
    }

    /* ===========================
       BOT√ÉO ADICIONAR CLIENTE
       =========================== */
    #btn-add-client {
        position: fixed;
        bottom: 80px;
        left: 50%;
        transform: translateX(-50%);
        background: var(--primary-color);
        color: white;
        border: none;
        padding: 16px 32px;
        border-radius: 30px;
        font-size: 16px;
        font-weight: 600;
        box-shadow: var(--shadow-lg);
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 10px;
        z-index: 9999;
        opacity: 0;
        transition: all 0.3s ease;
    }

    #btn-add-client.visible {
        opacity: 1;
    }

    #btn-add-client:hover {
        transform: translateX(-50%) translateY(-3px);
        box-shadow: 0 6px 20px rgba(66, 133, 244, 0.4);
    }

    #btn-add-client:active {
        transform: translateX(-50%) translateY(-1px);
    }

    /* ===========================
       MODAL ADICIONAR CLIENTE
       =========================== */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: var(--bg-overlay);
        z-index: 10002;
        display: none;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .modal-overlay.active {
        display: flex;
        opacity: 1;
    }

    .modal-container {
        background: white;
        border-radius: 16px;
        width: 90%;
        max-width: 500px;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        transform: scale(0.9);
        transition: transform 0.3s ease;
    }

    .modal-overlay.active .modal-container {
        transform: scale(1);
    }

    .modal-close {
        width: 32px;
        height: 32px;
        border: none;
        background: rgba(255, 255, 255, 0.9);
        border-radius: 50%;
        font-size: 18px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
        box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        flex-shrink: 0;
    }

    .modal-close:hover {
        background: white;
        transform: rotate(90deg);
    }

    .modal-body {
        padding: 24px;
    }

    /* QR Code Scanner */
    .qr-scanner-section {
        margin-bottom: 24px;
    }

    .scanner-title {
        font-size: 14px;
        font-weight: 600;
        color: #666;
        margin-bottom: 12px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .qr-camera-container {
        position: relative;
        width: 100%;
        max-width: 400px;
        margin: 0 auto;
        background: #000;
        border-radius: 12px;
        overflow: hidden;
        display: none;
    }

    .qr-camera-container.active {
        display: block;
    }

    #qr-video {
        width: 100%;
        height: auto;
        max-height: 300px;
        object-fit: cover;
        display: block;
    }

    #qr-canvas {
        display: none;
    }

    .qr-overlay {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 200px;
        height: 200px;
        border: 2px solid rgba(255, 255, 255, 0.5);
        border-radius: 12px;
        pointer-events: none;
    }

    .qr-overlay::before,
    .qr-overlay::after {
        content: '';
        position: absolute;
        width: 20px;
        height: 20px;
        border: 3px solid white;
    }

    .qr-overlay::before {
        top: -3px;
        left: -3px;
        border-right: none;
        border-bottom: none;
    }

    .qr-overlay::after {
        top: -3px;
        right: -3px;
        border-left: none;
        border-bottom: none;
    }

    .qr-overlay-bottom-left::before,
    .qr-overlay-bottom-right::after {
        content: '';
        position: absolute;
        width: 20px;
        height: 20px;
        border: 3px solid white;
    }

    .qr-overlay-bottom-left::before {
        bottom: -3px;
        left: -3px;
        border-right: none;
        border-top: none;
    }

    .qr-overlay-bottom-right::after {
        bottom: -3px;
        right: -3px;
        border-left: none;
        border-top: none;
    }

    .scanning-line {
        position: absolute;
        width: 100%;
        height: 2px;
        background: linear-gradient(90deg, transparent, var(--success-color), transparent);
        top: 50%;
        animation: scan 2s linear infinite;
        pointer-events: none;
    }

    @keyframes scan {
        0% { top: 25%; opacity: 0; }
        50% { opacity: 1; }
        100% { top: 75%; opacity: 0; }
    }

    .camera-controls {
        position: absolute;
        bottom: 12px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 10px;
        z-index: 10;
    }

    .camera-btn {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        border: none;
        background: rgba(255, 255, 255, 0.9);
        color: #333;
        font-size: 18px;
        cursor: pointer;
        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        transition: all 0.2s ease;
    }

    .camera-btn:hover {
        background: white;
        transform: scale(1.1);
    }

    .camera-btn:active {
        transform: scale(0.95);
    }

    .address-display {
        margin-bottom: 24px;
        padding: 16px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 12px;
        color: white;
        display: none;
        animation: slideIn 0.3s ease-out;
    }

    .address-display.active {
        display: block;
    }

    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .address-label {
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        opacity: 0.9;
        margin-bottom: 8px;
    }

    .address-text {
        font-size: 15px;
        font-weight: 500;
        line-height: 1.5;
    }

    .address-icon {
        font-size: 20px;
        margin-right: 8px;
    }

    .qr-status {
        position: absolute;
        top: 12px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 6px 12px;
        border-radius: 16px;
        font-size: 12px;
        font-weight: 500;
        z-index: 10;
        white-space: nowrap;
    }

    .qr-status.success {
        background: rgba(52, 168, 83, 0.9);
    }

    .qr-result {
        margin-top: 12px;
        padding: 12px;
        background: #e8f5e9;
        border-left: 4px solid var(--success-color);
        border-radius: 4px;
        display: none;
    }

    .qr-result.active {
        display: block;
    }

    .qr-result-text {
        font-size: 13px;
        color: #2e7d32;
        word-break: break-all;
    }

    /* Formul√°rio */
    .form-group {
        margin-bottom: 20px;
    }

    .form-label {
        display: block;
        font-size: 14px;
        font-weight: 600;
        color: #333;
        margin-bottom: 8px;
    }

    .form-input {
        width: 100%;
        padding: 12px 16px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 16px;
        font-family: inherit;
        transition: all 0.2s ease;
        box-sizing: border-box;
    }

    .form-input:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.1);
    }

    .form-input:disabled {
        background: #f5f5f5;
        color: #999;
        cursor: not-allowed;
    }

    .form-input::placeholder {
        color: #999;
    }

    .form-textarea {
        min-height: 80px;
        resize: vertical;
        font-family: inherit;
    }

    .form-footer {
        padding: 16px 24px;
        border-top: 1px solid #e0e0e0;
        display: flex;
        gap: 12px;
        justify-content: flex-end;
    }

    .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .btn-secondary {
        background: #f5f5f5;
        color: #666;
    }

    .btn-secondary:hover {
        background: #e0e0e0;
    }

    .btn-primary {
        background: var(--primary-color);
        color: white;
    }

    .btn-primary:hover {
        background: #3367d6;
    }

    .btn-primary:disabled {
        background: #ccc;
        cursor: not-allowed;
    }

    /* Loading no modal */
    .btn.loading {
        position: relative;
        color: transparent;
    }

    .btn.loading::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 16px;
        height: 16px;
        margin-top: -8px;
        margin-left: -8px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-top-color: white;
        border-radius: 50%;
        animation: spinner 0.6s linear infinite;
    }

    /* ===========================
       MENU LATERAL (SIDEBAR)
       =========================== */
    .sidebar {
        position: fixed;
        top: 0;
        left: -400px;
        width: 400px;
        height: 100%;
        background: white;
        box-shadow: 2px 0 12px rgba(0,0,0,0.15);
        z-index: 10003;
        transition: left 0.3s ease;
        display: flex;
        flex-direction: column;
    }

    .sidebar.open {
        left: 0;
    }

    .sidebar-header {
        padding: 20px;
        border-bottom: 2px solid #e0e0e0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .sidebar-title {
        font-size: 20px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .sidebar-close {
        width: 32px;
        height: 32px;
        border: none;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 50%;
        color: white;
        font-size: 18px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
    }

    .sidebar-close:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: rotate(90deg);
    }

    .sidebar-search {
        padding: 16px;
        border-bottom: 1px solid #e0e0e0;
    }

    .search-container {
        position: relative;
    }

    .search-icon {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 18px;
        color: #999;
        pointer-events: none;
    }

    .search-input {
        width: 100%;
        padding: 12px 12px 12px 42px;
        border: 2px solid #e0e0e0;
        border-radius: 24px;
        font-size: 15px;
        font-family: inherit;
        transition: all 0.2s ease;
        box-sizing: border-box;
    }

    .search-input:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.1);
    }

    .search-input::placeholder {
        color: #999;
    }

    .sidebar-content {
        flex: 1;
        overflow-y: auto;
        padding: 16px;
    }

    .clients-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .client-card {
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 12px;
        padding: 16px;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .client-card:hover {
        border-color: var(--primary-color);
        box-shadow: 0 2px 8px rgba(66, 133, 244, 0.15);
        transform: translateY(-2px);
    }

    .client-name {
        font-size: 16px;
        font-weight: 600;
        color: #333;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .client-info {
        font-size: 14px;
        color: #666;
        margin-bottom: 4px;
        display: flex;
        align-items: flex-start;
        gap: 8px;
    }

    .client-info-icon {
        font-size: 14px;
        opacity: 0.7;
        flex-shrink: 0;
        margin-top: 2px;
    }

    .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: #999;
    }

    .empty-state-icon {
        font-size: 48px;
        margin-bottom: 16px;
        opacity: 0.5;
    }

    .empty-state-text {
        font-size: 16px;
        font-weight: 500;
        margin-bottom: 8px;
    }

    .empty-state-subtext {
        font-size: 14px;
    }

    .sidebar-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 10002;
        display: none;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .sidebar-overlay.active {
        display: block;
        opacity: 1;
    }

    .client-count {
        display: inline-block;
        background: rgba(255, 255, 255, 0.2);
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 13px;
        font-weight: 600;
    }

    /* ===========================
       RESPONSIVO
       =========================== */
    @media (max-width: 768px) {
        .map-control {
            top: 70px;
            right: 10px;
        }

        .control-btn {
            width: 44px;
            height: 44px;
            font-size: 16px;
        }

        #toast-container {
            width: calc(100% - 40px);
        }

        .toast {
            padding: 12px 16px;
        }

        .loading-text {
            font-size: 16px;
        }

        .loading-subtext {
            font-size: 13px;
        }

        #status-bar {
            bottom: 10px;
            font-size: 13px;
            padding: 10px 16px;
        }

        #btn-add-client {
            bottom: 60px;
            padding: 14px 24px;
            font-size: 15px;
        }

        .modal-container {
            width: 95%;
            max-height: 95vh;
        }

        .modal-body {
            padding: 20px;
        }

        .scanner-title {
            font-size: 13px;
        }

        .modal-close {
            width: 28px;
            height: 28px;
            font-size: 16px;
        }

        .qr-camera-container {
            max-width: 100%;
        }

        #qr-video {
            max-height: 250px;
        }

        .qr-overlay {
            width: 180px;
            height: 180px;
        }

        .qr-upload-area {
            padding: 24px;
        }

        .qr-icon {
            font-size: 40px;
        }

        .form-footer {
            padding: 12px 20px;
            flex-direction: column-reverse;
        }

        .btn {
            width: 100%;
        }

        .sidebar {
            width: 100%;
            left: -100%;
        }

        .sidebar.open {
            left: 0;
        }

        .sidebar-title {
            font-size: 18px;
        }

        .sidebar-content {
            padding: 12px;
        }

        .client-card {
            padding: 14px;
        }
    }
</style>
</head>
<body>

<!-- Loading Screen -->
<div id="loading-screen">
    <div class="loading-content">
        <div class="spinner"></div>
        <div class="loading-text" id="loading-text">Inicializando mapa...</div>
        <div class="loading-subtext" id="loading-subtext">Aguarde um momento</div>
    </div>
</div>

<!-- Mapa -->
<div id="map"></div>

<!-- Controles -->
<div class="map-control">
    <button id="btnToggle3D" class="control-btn" title="Alternar visualiza√ß√£o 3D">3D</button>
    <button id="btnCenterLocation" class="control-btn" title="Centralizar na minha localiza√ß√£o">üìç</button>
    <button id="btnToggleRoute" class="control-btn" title="Planejar rota de entrega">üöó</button>
    <button id="btnOpenSidebar" class="control-btn" title="Ver lista de clientes">üë•</button>
</div>

<!-- Container de Notifica√ß√µes -->
<div id="toast-container"></div>

<!-- Status Bar -->
<div id="status-bar">
    <div class="status-indicator" id="status-indicator"></div>
    <span id="status-text">Rastreando localiza√ß√£o</span>
</div>

<!-- Bot√£o Adicionar Cliente -->
<button id="btn-add-client">
    <span>‚ûï</span>
    <span>Adicionar Cliente</span>
</button>

<!-- Sidebar - Menu Lateral -->
<div class="sidebar-overlay" id="sidebar-overlay"></div>

<div class="sidebar" id="sidebar">
    <div class="sidebar-header">
        <div class="sidebar-title">
            <span>üë•</span>
            <span>Clientes</span>
            <span class="client-count" id="client-count">0</span>
        </div>
        <button class="sidebar-close" id="sidebar-close">‚úï</button>
    </div>

    <div class="sidebar-search">
        <div class="search-container">
            <span class="search-icon">üîç</span>
            <input
                type="text"
                class="search-input"
                id="search-input"
                placeholder="Buscar por nome, endere√ßo ou telefone..."
            >
        </div>
    </div>

    <div class="sidebar-content">
        <div class="clients-list" id="clients-list">
            <!-- Lista de clientes ser√° inserida aqui -->
            <div class="empty-state">
                <div class="empty-state-icon">üìã</div>
                <div class="empty-state-text">Nenhum cliente cadastrado</div>
                <div class="empty-state-subtext">Adicione clientes para v√™-los aqui</div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Adicionar Cliente -->
<div class="modal-overlay" id="modal-add-client">
    <div class="modal-container">
        <div class="modal-body">
            <!-- Scanner QR Code -->
            <div class="qr-scanner-section">
                <div class="scanner-title">
                    <span>üì∏ Aponte a c√¢mera para o QR Code</span>
                    <button class="modal-close" id="modal-close">‚úï</button>
                </div>

                <div class="qr-camera-container active" id="qr-camera-container">
                    <video id="qr-video" autoplay playsinline></video>
                    <canvas id="qr-canvas"></canvas>

                    <div class="qr-overlay">
                        <div class="qr-overlay-bottom-left"></div>
                        <div class="qr-overlay-bottom-right"></div>
                    </div>

                    <div class="scanning-line"></div>

                    <div class="qr-status" id="qr-status">Procurando QR Code...</div>

                    <div class="camera-controls">
                        <button class="camera-btn" id="btn-stop-camera" title="Fechar c√¢mera">‚úï</button>
                        <button class="camera-btn" id="btn-switch-camera" title="Trocar c√¢mera">üîÑ</button>
                    </div>
                </div>
            </div>

            <!-- Display do Endere√ßo -->
            <div class="address-display" id="address-display">
                <div class="address-label">üìç Endere√ßo do Cliente</div>
                <div class="address-text" id="address-text"></div>
            </div>

            <!-- Formul√°rio -->
            <form id="form-add-client">

                <div class="form-group">
                    <label class="form-label" for="input-name">Nome do Cliente *</label>
                    <input
                        type="text"
                        class="form-input"
                        id="input-name"
                        placeholder="Digite o nome do cliente"
                        required
                    >
                </div>

                <div class="form-group">
                    <label class="form-label" for="input-phone">Telefone</label>
                    <input
                        type="tel"
                        class="form-input"
                        id="input-phone"
                        placeholder="(91)9 9942-1942"
                        maxlength="16"
                    >
                </div>
            </form>
        </div>

        <div class="form-footer">
            <button type="button" class="btn btn-secondary" id="btn-cancel">Cancelar</button>
            <button type="submit" class="btn btn-primary" id="btn-save" form="form-add-client">Salvar Cliente</button>
        </div>
    </div>
</div>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<!-- jsQR - Biblioteca de leitura de QR Code -->
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>

<script>
    const SUPABASE_URL = "https://dctlgztkqtktxnmiuqgr.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRjdGxnenRrcXRrdHhubWl1cWdyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2MzMwNDIsImV4cCI6MjA4MDIwOTA0Mn0.Ctlx8A4QBFxa7Iu6fObw_OthHfA2XrzY47UiMMIhbIU";

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Dados da planilha Excel - Mapeamento de QR codes para endere√ßos
    const addressDatabase = {
  "BR2548334621214": {
    "address": "Alameda Moraes, 246, Rua ao lado do Conselho tutela\nBairro: Praia Grande (Mosqueiro)\nBel√©m - 66914-090",
    "latitude": -1.1424655,
    "longitude": -48.4652878,
    "city": "Bel√©m",
    "zipcode": "66914-090"
  },
  "BR258090515239N": {
    "address": "Alameda Moraes, 246, Rua ao lado do Conselho tutela\nBairro: Praia Grande (Mosqueiro)\nBel√©m - 66914-090",
    "latitude": -1.1424655,
    "longitude": -48.4652878,
    "city": "Bel√©m",
    "zipcode": "66914-090"
  },
  "BR2543386241922": {
    "address": "Alameda Moraes, 246\nBairro: Praia Grande (Mosqueiro)\nBel√©m - 66914-090",
    "latitude": -1.1424655,
    "longitude": -48.4652878,
    "city": "Bel√©m",
    "zipcode": "66914-090"
  },
  "BR257485707468Y": {
    "address": "Alameda Moraes, 246\nBairro: Praia Grande (Mosqueiro)\nBel√©m - 66914-090",
    "latitude": -1.1424655,
    "longitude": -48.4652878,
    "city": "Bel√©m",
    "zipcode": "66914-090"
  },
  "BR2590650161019": {
    "address": "Alameda Petr√≥polis, 42, Casa branca com muro baixinho\nBairro: Praia Grande (Mosqueiro)\nBel√©m - 66914-100",
    "latitude": -1.1432,
    "longitude": -48.4659004,
    "city": "Bel√©m",
    "zipcode": "66914-100"
  },
  "BR259792298200M": {
    "address": "Alameda Ribamar Santos, 15, Ao lado da LR mat. De constru√ß\nBairro: Praia Grande\nBel√©m - 66911-120",
    "latitude": -1.1438776,
    "longitude": -48.4640884,
    "city": "Bel√©m",
    "zipcode": "66911-120"
  },
  "BR255026824340N": {
    "address": "Avenida Beira-Mar - Rua: Dos Escoteiros Pr√≥ximo A Rua: Alameda Moraes, 1657, Condominio prive do farol, Bel√©m, Par√°, 66910150\nBel√©m - 66910150",
    "latitude": -1.1451693,
    "longitude": -48.4655266,
    "city": "Bel√©m",
    "zipcode": "66910150"
  },
  "BR255669520013M": {
    "address": "Passagem S√£o Domingos, 33, Pr√≥ximo √† Rua das Mangueiras\nBairro: Praia Grande (Mosqueiro)\nBel√©m - 66914-080",
    "latitude": -1.1456899,
    "longitude": -48.4648368,
    "city": "Bel√©m",
    "zipcode": "66914-080"
  },
  "BR2532092523217": {
    "address": "Rua Raimundo Cintra, 39, Entre S√£o Domingos e Santa Ter\nBairro: Mangueiras (Mosqueiro)\nBel√©m - 66912-220",
    "latitude": -1.1466,
    "longitude": -48.462101,
    "city": "Bel√©m",
    "zipcode": "66912-220"
  },
  "BR252457049287C": {
    "address": "Rua Raimundo Cintra, 12\nBairro: Mangueiras (Mosqueiro)\nBel√©m - 66912-220",
    "latitude": -1.1470315,
    "longitude": -48.4626465,
    "city": "Bel√©m",
    "zipcode": "66912-220"
  },
  "BR257080667441M": {
    "address": "Passg Santa Rita De Kace, 31\nBairro: Ariramba (Mosqueiro)\nBel√©m - 66914-110",
    "latitude": -1.1463585,
    "longitude": -48.4638905,
    "city": "Bel√©m",
    "zipcode": "66914-110"
  },
  "BR259832570656I": {
    "address": "Passg Santa Rita De Kace, 31\nBairro: Ariramba (Mosqueiro)\nBel√©m - 66914-110",
    "latitude": -1.1463585,
    "longitude": -48.4638905,
    "city": "Bel√©m",
    "zipcode": "66914-110"
  },
  "BR2555419499636": {
    "address": "Passagem Mirim, 2, Av. Beira Mar\nBairro: Praia grande mosqueiro\nBel√©m - 66914-510",
    "latitude": -1.15,
    "longitude": -48.4671,
    "city": "Bel√©m",
    "zipcode": "66914-510"
  },
  "BR2510739661481": {
    "address": "Rua do Carmo, 83, Casa\nBairro: Praia Grande (Mosqueiro)\nBel√©m - 66914-040",
    "latitude": -1.1504477,
    "longitude": -48.4675026,
    "city": "Bel√©m",
    "zipcode": "66914-040"
  },
  "BR256427341903Q": {
    "address": "Rua Quinze de Novembro, 39, Praia grande casa verde\nBairro: Vila (Mosqueiro)\nBel√©m - 66910-000",
    "latitude": -1.1509,
    "longitude": -48.4693985,
    "city": "Bel√©m",
    "zipcode": "66910-000"
  },
  "BR252765984646G": {
    "address": "Rua Quinze de Novembro, 39, Praia grande casa verde\nBairro: Vila (Mosqueiro)\nBel√©m - 66910-000",
    "latitude": -1.1509,
    "longitude": -48.4693985,
    "city": "Bel√©m",
    "zipcode": "66910-000"
  },
  "BR2508214594606": {
    "address": "Alameda Fran√ßa, 33\nBairro: Praia Grande (Mosqueiro)\nBel√©m - 66914-230",
    "latitude": -1.151652,
    "longitude": -48.4677925,
    "city": "Bel√©m",
    "zipcode": "66914-230"
  },
  "BR257708180761F": {
    "address": "Avenida Beira-Mar, 1076, Proximo a barraca carioquinha\nBairro: Vila (Mosqueiro)\nBel√©m - 66910-150",
    "latitude": -1.1522,
    "longitude": -48.4702988,
    "city": "Bel√©m",
    "zipcode": "66910-150"
  },
  "BR2570195095799": {
    "address": "Rua Coronel Jos√© do √ì, 137, Pr√≥ximo a alameda Raimunda\nBairro: Vila (Mosqueiro)\nBel√©m - 66910-010",
    "latitude": -1.1536975,
    "longitude": -48.4707031,
    "city": "Bel√©m",
    "zipcode": "66910-010"
  },
  "BR252206059319K": {
    "address": "Travessa Lauro Sodr√©, 198 a\nBairro: Vila (Mosqueiro)\nBel√©m - 66910-170",
    "latitude": -1.154588,
    "longitude": -48.4708481,
    "city": "Bel√©m",
    "zipcode": "66910-170"
  },
  "BR258463997845D": {
    "address": "Travessa Lauro Sodr√©, 156, Pr√≥ximo ao Hospital Municipal\nBairro: Vila (Mosqueiro)\nBel√©m - 66910-170",
    "latitude": -1.154617,
    "longitude": -48.470768,
    "city": "Bel√©m",
    "zipcode": "66910-170"
  },
  "BR250808162475E": {
    "address": "Travessa Lauro Sodr√©, 235, Ao lado do hospital geral\nBairro: Vila (Mosqueiro)\nBel√©m - 66910-170",
    "latitude": -1.1545,
    "longitude": -48.4700012,
    "city": "Bel√©m",
    "zipcode": "66910-170"
  },
  "BR250622958347D": {
    "address": "Rua Quinze de Novembro, 728\nBairro: Vila (Mosqueiro)\nBel√©m - 66910-000",
    "latitude": -1.1571,
    "longitude": -48.4695015,
    "city": "Bel√©m",
    "zipcode": "66910-000"
  },
  "BR253698799515E": {
    "address": "Rua Quinze de Novembro, 688, Entre o hospital e as 5 bocas\nBairro: Vila (Mosqueiro)\nBel√©m - 66910-000",
    "latitude": -1.1568567,
    "longitude": -48.4692841,
    "city": "Bel√©m",
    "zipcode": "66910-000"
  },
  "BR257375048849G": {
    "address": "Rua Quinze de Novembro, 830\nBairro: Vila (Mosqueiro)\nBel√©m - 66910-000",
    "latitude": -1.1584749,
    "longitude": -48.4690933,
    "city": "Bel√©m",
    "zipcode": "66910-000"
  },
  "BR2570810926273": {
    "address": "Travessa Coronel Jos√© Mota, 263, Proximidade da Av 16 de Novemb\nBairro: Vila (Mosqueiro)\nBel√©m - 66910-680",
    "latitude": -1.1585106,
    "longitude": -48.4683007,
    "city": "Bel√©m",
    "zipcode": "66910-680"
  },
  "BR2589228991775": {
    "address": "Rua Quinze de Novembro, 18, Passagem sao sebastiao\nBairro: Vila (Mosqueiro)\nBel√©m - 66910-000",
    "latitude": -1.1597145,
    "longitude": -48.469059,
    "city": "Bel√©m",
    "zipcode": "66910-000"
  },
  "BR255892110928M": {
    "address": "Rua Quinze de Novembro, 18, Passagem sao sebastiao\nBairro: Vila (Mosqueiro)\nBel√©m - 66910-000",
    "latitude": -1.1597145,
    "longitude": -48.469059,
    "city": "Bel√©m",
    "zipcode": "66910-000"
  },
  "BR254165660090X": {
    "address": "Rua Quinze de Novembro, 18, Ao lado da NutriPets ra√ß√µes\nBairro: Vila (Mosqueiro)\nBel√©m - 66910-000",
    "latitude": -1.1597145,
    "longitude": -48.469059,
    "city": "Bel√©m",
    "zipcode": "66910-000"
  },
  "BR255864217202N": {
    "address": "Rua Quinze de Novembro, 18, Ao lado da NutriPets ra√ß√µes\nBairro: Vila (Mosqueiro)\nBel√©m - 66910-000",
    "latitude": -1.1597145,
    "longitude": -48.469059,
    "city": "Bel√©m",
    "zipcode": "66910-000"
  },
  "BR2559482212905": {
    "address": "Rua Quinze de Novembro, 1021, Entre cinco bocas e Get√∫lio\nBairro: Vila (Mosqueiro)\nBel√©m - 66910-000",
    "latitude": -1.1600853,
    "longitude": -48.4689713,
    "city": "Bel√©m",
    "zipcode": "66910-000"
  },
  "BR257588309119A": {
    "address": "Rua Quinze de Novembro, 121, Pr√≥ximo as cinco bocas\nBairro: Vila (Mosqueiro)\nBel√©m - 66910-000",
    "latitude": -1.1589,
    "longitude": -48.4688988,
    "city": "Bel√©m",
    "zipcode": "66910-000"
  },
  "BR256931637480Z": {
    "address": "Rua Quinze de Novembro, 10, Alemeda terra prometida, Bel√©m, Par√°, 66910000\nBel√©m - 66910000",
    "latitude": -1.1587799,
    "longitude": -48.4689636,
    "city": "Bel√©m",
    "zipcode": "66910000"
  },
  "BR2558435081671": {
    "address": "Avenida Dezesseis de Novembro, 2909, Em frente ao quiosque ki gosto\nBairro: Vila (Mosqueiro)\nBel√©m - 66910-140",
    "latitude": -1.1566,
    "longitude": -48.467701,
    "city": "Bel√©m",
    "zipcode": "66910-140"
  },
  "BR258040408902Y": {
    "address": "Rua Padre Manoel Raiol, 220, Muro amarelo com telhas vermel\nBairro: Vila (Mosqueiro)\nBel√©m - 66910-040",
    "latitude": -1.1570348,
    "longitude": -48.467514,
    "city": "Bel√©m",
    "zipcode": "66910-040"
  },
  "BR257612403013T": {
    "address": "Avenida Dezesseis de Novembro, 72, Em frente dep√≥sito Xavier ao lado Jo√£o motos\nBairro: Vila (Mosqueiro)\nBel√©m - 66910-140",
    "latitude": -1.1532554,
    "longitude": -48.466176,
    "city": "Bel√©m",
    "zipcode": "66910-140"
  },
  "BR258316357232J": {
    "address": "Avenida Dezesseis de Novembro, 72, Em frente dep√≥sito Xavier ao lado Jo√£o motos\nBairro: Vila (Mosqueiro)\nBel√©m - 66910-140",
    "latitude": -1.1532554,
    "longitude": -48.466176,
    "city": "Bel√©m",
    "zipcode": "66910-140"
  },
  "BR2553020039350": {
    "address": "Avenida Dezesseis de Novembro, 72, Em frente dep√≥sito Xavier ao lado Jo√£o motos\nBairro: Vila (Mosqueiro)\nBel√©m - 66910-140",
    "latitude": -1.1532554,
    "longitude": -48.466176,
    "city": "Bel√©m",
    "zipcode": "66910-140"
  },
  "BR257648789028P": {
    "address": "Avenida Dezesseis de Novembro, 72, Em frente dep√≥sito Xavier ao lado Jo√£o motos\nBairro: Vila (Mosqueiro)\nBel√©m - 66910-140",
    "latitude": -1.1532554,
    "longitude": -48.466176,
    "city": "Bel√©m",
    "zipcode": "66910-140"
  },
  "BR258126401029R": {
    "address": "Avenida Dezesseis de Novembro, 72\nBairro: Vila (Mosqueiro)\nBel√©m - 66910-140",
    "latitude": -1.1532554,
    "longitude": -48.466176,
    "city": "Bel√©m",
    "zipcode": "66910-140"
  },
  "BR2531457461885": {
    "address": "Avenida Dezesseis de Novembro, 72, Em frente deposito Xavier ao lado Jo√£o motos\nBairro: Vila (Mosqueiro)\nBel√©m - 66910-140",
    "latitude": -1.1532554,
    "longitude": -48.466176,
    "city": "Bel√©m",
    "zipcode": "66910-140"
  },
  "BR253333999131P": {
    "address": "Avenida Dezesseis de Novembro, 2391, Ao lado da barbearia adryan\nBairro: Vila (Mosqueiro)\nBel√©m - 66910-140",
    "latitude": -1.1524897,
    "longitude": -48.4659386,
    "city": "Bel√©m",
    "zipcode": "66910-140"
  },
  "BR253625124030V": {
    "address": "Passagem Atl√¢ntida, 03, Em frente ao Cantinho Azulino\nBairro: Vila (Mosqueiro)\nBel√©m - 66910-520",
    "latitude": -1.1530946,
    "longitude": -48.4672508,
    "city": "Bel√©m",
    "zipcode": "66910-520"
  },
  "BR257518523148D": {
    "address": "Alameda Ferreira, 28, Ao lado do comercial Ant√¥nio\nBairro: Vila (Mosqueiro)\nBel√©m - 66910-050",
    "latitude": -1.1531883,
    "longitude": -48.466831,
    "city": "Bel√©m",
    "zipcode": "66910-050"
  },
  "BR259312148009G": {
    "address": "Passagem Atl√¢ntida, 03, Ao lado da  antena\nBairro: Vila (Mosqueiro)\nBel√©m - 66910-520",
    "latitude": -1.1530946,
    "longitude": -48.4672508,
    "city": "Bel√©m",
    "zipcode": "66910-520"
  },
  "BR256031024378C": {
    "address": "Alameda Bela Vista, 6, 16 de novembro/ Camilo salgado\nBairro: Vila (Mosqueiro)\nBel√©m - 66910-390",
    "latitude": -1.1538,
    "longitude": -48.4674988,
    "city": "Bel√©m",
    "zipcode": "66910-390"
  },
  "BR252838900075R": {
    "address": "Travessa Bela Vista, 2, Pr√≥ximo ao hospital geral\nBairro: Praia Grande\nBel√©m - 66912-140",
    "latitude": -1.1538016,
    "longitude": -48.4650497,
    "city": "Bel√©m",
    "zipcode": "66912-140"
  },
  "BR250305017276D": {
    "address": "Rua Sandro Carvalho, 68-A, Paquet√°\nBairro: Mangueiras (Mosqueiro)\nBel√©m - 66912-180",
    "latitude": -1.1528,
    "longitude": -48.4622993,
    "city": "Bel√©m",
    "zipcode": "66912-180"
  },
  "BR259426316988F": {
    "address": "Rua Sandro Carvalho, 68-A, Paquet√°\nBairro: Mangueiras (Mosqueiro)\nBel√©m - 66912-180",
    "latitude": -1.1528,
    "longitude": -48.4622993,
    "city": "Bel√©m",
    "zipcode": "66912-180"
  },
  "BR2573946235544": {
    "address": "Rua Bariloche, 30, Casa\nBairro: Mangueiras (Mosqueiro)\nBel√©m - 66912-130",
    "latitude": -1.1523347,
    "longitude": -48.4615555,
    "city": "Bel√©m",
    "zipcode": "66912-130"
  },
  "BR258040312070F": {
    "address": "Rua Bariloche, 30, Casa\nBairro: Mangueiras (Mosqueiro)\nBel√©m - 66912-130",
    "latitude": -1.1523347,
    "longitude": -48.4615555,
    "city": "Bel√©m",
    "zipcode": "66912-130"
  },
  "BR2561235030362": {
    "address": "Alameda Paquet√°, 4, pr√≥ximo ao comercial Caroline\nBairro: Mangueiras (Mosqueiro)\nBel√©m - 66912-210",
    "latitude": -1.1530893,
    "longitude": -48.4613724,
    "city": "Bel√©m",
    "zipcode": "66912-210"
  },
  "BR252010309093W": {
    "address": "Alameda Paquet√°, 4, pr√≥ximo ao comercial Caroline\nBairro: Mangueiras (Mosqueiro)\nBel√©m - 66912-210",
    "latitude": -1.1530893,
    "longitude": -48.4613724,
    "city": "Bel√©m",
    "zipcode": "66912-210"
  },
  "BR2512319420247": {
    "address": "Travessa Santa Helena, O1, Atr√°s da loja Dluna Beach\nBairro: Mangueiras (Mosqueiro)\nBel√©m - 66912-200",
    "latitude": -1.1548012,
    "longitude": -48.4614143,
    "city": "Bel√©m",
    "zipcode": "66912-200"
  },
  "BR254841014012P": {
    "address": "Pra√ßa do carmo, 27, Bar do seu bene\nBairro: Cidade velha\nBel√©m - 66912-230",
    "latitude": -1.1591978,
    "longitude": -48.4569525,
    "city": "Bel√©m",
    "zipcode": "66912-230"
  },
  "BR258670218678R": {
    "address": "Travessa Bela Vista, 87\nBairro: Mangueiras (Mosqueiro)\nBel√©m - 66912-140",
    "latitude": -1.1542,
    "longitude": -48.4594002,
    "city": "Bel√©m",
    "zipcode": "66912-140"
  },
  "BR254442724443V": {
    "address": "Alameda Paquet√°, 900, Final do asfalto lado direito\nBairro: Mangueiras (Mosqueiro)\nBel√©m - 66912-210",
    "latitude": -1.1533793,
    "longitude": -48.4588051,
    "city": "Bel√©m",
    "zipcode": "66912-210"
  },
  "BR257300548797C": {
    "address": "Rua Bahamas, 26\nBairro: Mangueiras (Mosqueiro)\nBel√©m - 66912-120",
    "latitude": -1.1521145,
    "longitude": -48.4601555,
    "city": "Bel√©m",
    "zipcode": "66912-120"
  },
  "BR255604031541B": {
    "address": "Alameda do Carmo, 33, Pr√≥ximo a igreja Reis dos Reis\nBairro: Mangueiras (Mosqueiro)\nBel√©m - 66912-230",
    "latitude": -1.1513,
    "longitude": -48.4594002,
    "city": "Bel√©m",
    "zipcode": "66912-230"
  },
  "BR258852981488Q": {
    "address": "Rua Nova, 255\nBairro: Mangueiras (Mosqueiro)\nBel√©m - 66912-080",
    "latitude": -1.1500554,
    "longitude": -48.461853,
    "city": "Bel√©m",
    "zipcode": "66912-080"
  },
  "BR2530998956863": {
    "address": "Avenida Camilo Salgado Filho, 612, Centro Educacional L√°pis na M√£\nBairro: Mangueiras (Mosqueiro)\nBel√©m - 66912-250",
    "latitude": -1.1501131,
    "longitude": -48.4624329,
    "city": "Bel√©m",
    "zipcode": "66912-250"
  },
  "BR2556101372242": {
    "address": "Rua do Carmo, 26\nBairro: Praia Grande (Mosqueiro)\nBel√©m - 66914-040",
    "latitude": -1.151163,
    "longitude": -48.4636841,
    "city": "Bel√©m",
    "zipcode": "66914-040"
  },
  "BR257690813744P": {
    "address": "Rua Raimundo Cintra, 33, Atraz da panificadora Martinez\nBairro: Mangueiras (Mosqueiro)\nBel√©m - 66912-220",
    "latitude": -1.1497903,
    "longitude": -48.4638405,
    "city": "Bel√©m",
    "zipcode": "66912-220"
  },
  "BR251048356165R": {
    "address": "Rua Bariloche, 17, Acesso pela sta terezinha\nBairro: Mangueiras (Mosqueiro)\nBel√©m - 66912-130",
    "latitude": -1.1482842,
    "longitude": -48.4596596,
    "city": "Bel√©m",
    "zipcode": "66912-130"
  },
  "BR251297883486O": {
    "address": "Rua Bariloche, 17, Acesso pela rua santa Terezinh\nBairro: Mangueiras (Mosqueiro)\nBel√©m - 66912-130",
    "latitude": -1.1482842,
    "longitude": -48.4596596,
    "city": "Bel√©m",
    "zipcode": "66912-130"
  },
  "BR2502916709275": {
    "address": "Ria nova, 195\nBairro: Mangueiras (Mosqueiro)\nBel√©m - 66912-060",
    "latitude": -1.1469001,
    "longitude": -48.4600983,
    "city": "Bel√©m",
    "zipcode": "66912-060"
  },
  "BR250880859719J": {
    "address": "Avenida Principal, 14, Rua ao lado do varej√£o do cime\nBairro: Mangueiras (Mosqueiro)\nBel√©m - 66912-040",
    "latitude": -1.1448848,
    "longitude": -48.4607849,
    "city": "Bel√©m",
    "zipcode": "66912-040"
  },
  "BR258628300510C": {
    "address": "Avenida Principal, 14, Rua ao lado do varej√£o do cime\nBairro: Mangueiras (Mosqueiro)\nBel√©m - 66912-040",
    "latitude": -1.1448848,
    "longitude": -48.4607849,
    "city": "Bel√©m",
    "zipcode": "66912-040"
  },
  "BR257630269023H": {
    "address": "Avenida Principal, 14, Rua ao lado do varej√£o do cime\nBairro: Mangueiras (Mosqueiro)\nBel√©m - 66912-040",
    "latitude": -1.1448848,
    "longitude": -48.4607849,
    "city": "Bel√©m",
    "zipcode": "66912-040"
  },
  "BR252728742822U": {
    "address": "Alameda Teres√≥polis, 182, Rua da creche\nBairro: Mangueiras (Mosqueiro)\nBel√©m - 66912-060",
    "latitude": -1.143436,
    "longitude": -48.4600372,
    "city": "Bel√©m",
    "zipcode": "66912-060"
  },
  "BR255642613681K": {
    "address": "Alameda Petr√≥polis, 1000, Casa amarela con rosa\nBairro: Praia Grande (Mosqueiro)\nBel√©m - 66914-100",
    "latitude": -1.1434402,
    "longitude": -48.4619141,
    "city": "Bel√©m",
    "zipcode": "66914-100"
  },
  "BR251146466899J": {
    "address": "Avenida Dezesseis de Novembro, 1220, Mundo dos colch√µes ao lado do\nBairro: Vila (Mosqueiro)\nBel√©m - 66910-140",
    "latitude": -1.1423743,
    "longitude": -48.461216,
    "city": "Bel√©m",
    "zipcode": "66910-140"
  },
  "BR256373097735V": {
    "address": "Avenida Dezesseis de Novembro, 1220, Mundo dos colch√µes ao lado do\nBairro: Vila (Mosqueiro)\nBel√©m - 66910-140",
    "latitude": -1.1423743,
    "longitude": -48.461216,
    "city": "Bel√©m",
    "zipcode": "66910-140"
  }
};
</script>

<!-- Google Maps - Carregamento otimizado -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyApaDb9rSw2sNTaY7fjBqmrgjWYD9xwjcU&loading=async&callback=initMap&v=beta&libraries=geometry"></script>

<script>
let map;
let is3D = false;
let userLocationMarker = null;
let watchId = null;
let _animating3D = false;
let locationAccuracy = null;
let deliveryMarkers = {}; // Armazena marcadores de endere√ßos de entrega
let directionsService = null; // Servi√ßo de rotas do Google Maps
let directionsRenderer = null; // Renderizador de rotas
let routeMode = false; // Modo de planejamento de rota ativo/inativo

const MAP_ID = "ebb7ca4503045feabc75b373";

// IMPORTANTE: Substitua pelo seu Project ID do Google Cloud Platform
// Encontre em: https://console.cloud.google.com/ ‚Üí Configura√ß√µes do projeto
const GOOGLE_CLOUD_PROJECT_ID = "mapas-clientes-479801"; // ‚úÖ Configurado!

// ===========================
// SISTEMA DE NOTIFICA√á√ïES
// ===========================

function showToast(title, message, type = 'info', duration = 4000) {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;

    const icons = {
        success: '‚úì',
        error: '‚úï',
        warning: '‚ö†',
        info: '‚Ñπ'
    };

    toast.innerHTML = `
        <div class="toast-icon">${icons[type] || icons.info}</div>
        <div class="toast-content">
            <div class="toast-title">${title}</div>
            ${message ? `<div class="toast-message">${message}</div>` : ''}
        </div>
    `;

    container.appendChild(toast);

    setTimeout(() => {
        toast.classList.add('hiding');
        setTimeout(() => toast.remove(), 300);
    }, duration);
}

function updateLoadingScreen(text, subtext) {
    document.getElementById('loading-text').textContent = text;
    document.getElementById('loading-subtext').textContent = subtext;
}

function hideLoadingScreen() {
    const loadingScreen = document.getElementById('loading-screen');
    const mapElement = document.getElementById('map');
    const controls = document.querySelector('.map-control');

    loadingScreen.classList.add('hidden');
    mapElement.classList.add('loaded');
    controls.classList.add('visible');

    setTimeout(() => {
        document.getElementById('status-bar').classList.add('visible');
    }, 500);
}

function updateStatus(text, active = true) {
    document.getElementById('status-text').textContent = text;
    const indicator = document.getElementById('status-indicator');

    if (active) {
        indicator.classList.remove('inactive');
    } else {
        indicator.classList.add('inactive');
    }
}

// ===========================
// INICIALIZA√á√ÉO DO MAPA
// ===========================

window.initMap = function () {
    console.log('Iniciando mapa...');
    updateLoadingScreen('Carregando mapa...', 'Preparando visualiza√ß√£o');

    try {
        map = new google.maps.Map(document.getElementById("map"), {
            center: {lat: -23.5505, lng: -46.6333},
            zoom: 17,
            mapId: MAP_ID,
            mapTypeId: google.maps.MapTypeId.ROADMAP, // üöÄ FOR√áAR iniciar em modo padr√£o (mais leve)
            tilt: 0,
            heading: 0,
            gestureHandling: "greedy",
            rotateControl: true,
            zoomControl: true,
            streetViewControl: false,
            fullscreenControl: false, // Desabilitar fullscreen para performance
            mapTypeControl: true, // Controle de tipo de mapa (sat√©lite, terreno, etc)
            mapTypeControlOptions: {
                style: google.maps.MapTypeControlStyle.HORIZONTAL_BAR,
                position: google.maps.ControlPosition.TOP_RIGHT,
                mapTypeIds: ['roadmap', 'satellite', 'terrain', 'hybrid'] // Todos os tipos dispon√≠veis
            },
            scaleControl: false, // Desabilitar escala
            // Otimiza√ß√µes de renderiza√ß√£o
            clickableIcons: false, // Desabilitar POIs clic√°veis (melhora performance)
            disableDefaultUI: false,
            backgroundColor: '#e5e3df' // Cor de fundo enquanto carrega tiles
        });

        // Inicializar servi√ßos de rota
        directionsService = new google.maps.DirectionsService();
        directionsRenderer = new google.maps.DirectionsRenderer({
            map: map,
            suppressMarkers: false, // N√£o suprimir marcadores (A, B, C, etc.)
            preserveViewport: true, // N√£o ajustar viewport automaticamente (mais r√°pido)
            polylineOptions: {
                strokeColor: '#4285f4',
                strokeWeight: 4,
                strokeOpacity: 0.75,
                geodesic: true,
                clickable: false
            }
        });

        console.log('Mapa criado, aguardando tiles...');

        // Timeout de seguran√ßa: se o mapa n√£o carregar em 15s, for√ßa o in√≠cio do tracking
        const safetyTimeout = setTimeout(() => {
            console.warn('Timeout: for√ßando in√≠cio do tracking de localiza√ß√£o');
            updateLoadingScreen('Obtendo sua localiza√ß√£o...', 'Ative o GPS para melhor precis√£o');
            startLocationTracking();
        }, 15000);

        // Espera o mapa carregar completamente
        google.maps.event.addListenerOnce(map, 'tilesloaded', () => {
            clearTimeout(safetyTimeout);
            console.log('Tiles carregados, iniciando tracking...');
            updateLoadingScreen('Obtendo sua localiza√ß√£o...', 'Ative o GPS para melhor precis√£o');
            startLocationTracking();
        });
    } catch (error) {
        console.error('Erro ao criar mapa:', error);
        hideLoadingScreen();
        showToast('Erro ao inicializar mapa', error.message, 'error', 8000);
    }
}

// ===========================
// RASTREAMENTO EM TEMPO REAL
// ===========================

function startLocationTracking() {
    console.log('Iniciando rastreamento de localiza√ß√£o...');

    if (!navigator.geolocation) {
        console.error('Geolocaliza√ß√£o n√£o suportada');
        hideLoadingScreen();
        showToast('GPS n√£o suportado', 'Seu navegador n√£o suporta geolocaliza√ß√£o', 'error', 6000);
        updateStatus('GPS indispon√≠vel', false);
        return;
    }

    const markerDiv = document.createElement('div');
    markerDiv.className = 'location-marker active';

    const geoOptions = {
        enableHighAccuracy: true,
        timeout: 10000,
        maximumAge: 0
    };

    console.log('Solicitando posi√ß√£o do GPS...');
    navigator.geolocation.getCurrentPosition(
        pos => {
            try {
                console.log('Posi√ß√£o obtida:', pos.coords.latitude, pos.coords.longitude);
                const c = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                locationAccuracy = pos.coords.accuracy;

                map.setCenter(c);
                map.setZoom(17);

                // Tenta usar AdvancedMarkerElement (recomendado pelo Google desde 2024)
                if (google.maps.marker && google.maps.marker.AdvancedMarkerElement) {
                    console.log('Criando AdvancedMarkerElement...');
                    userLocationMarker = new google.maps.marker.AdvancedMarkerElement({
                        map,
                        position: c,
                        content: markerDiv,
                        title: "Sua Localiza√ß√£o"
                    });
                    console.log('AdvancedMarkerElement criado com sucesso');
                } else {
                    // Fallback para Marker cl√°ssico se AdvancedMarker n√£o estiver dispon√≠vel
                    console.warn('AdvancedMarkerElement n√£o dispon√≠vel, usando Marker cl√°ssico');
                    userLocationMarker = new google.maps.Marker({
                        map,
                        position: c,
                        title: "Sua Localiza√ß√£o",
                        icon: {
                            path: google.maps.SymbolPath.CIRCLE,
                            scale: 8,
                            fillColor: "#4285f4",
                            fillOpacity: 1,
                            strokeColor: "white",
                            strokeWeight: 3
                        }
                    });
                    console.log('Marker cl√°ssico criado com sucesso');
                }

                console.log('Escondendo loading screen...');
                hideLoadingScreen();
                showAddClientButton(); // Mostrar bot√£o adicionar cliente

                // N√ÉO adicionar marcadores automaticamente (deixa o mapa leve)
                // Os marcadores ser√£o adicionados apenas ao ativar o modo de rota
                console.log('Mapa carregado. Marcadores ser√£o exibidos ao calcular rota.');
            } catch (error) {
                console.error('Erro ao criar marcador:', error);
                hideLoadingScreen();
                showToast('Erro ao criar marcador', error.message, 'error', 6000);
            }

            showToast(
                'Localiza√ß√£o obtida!',
                `Precis√£o: ${Math.round(locationAccuracy)}m`,
                'success',
                3000
            );

            updateStatus(`Precis√£o: ${Math.round(locationAccuracy)}m`, true);

            watchId = navigator.geolocation.watchPosition(
                updateUserLocation,
                handleGeoError,
                geoOptions
            );
        },
        error => {
            hideLoadingScreen();
            handleGeoError(error, true);
        },
        geoOptions
    );
}

function updateUserLocation(position) {
    const newPos = {
        lat: position.coords.latitude,
        lng: position.coords.longitude
    };

    if (!userLocationMarker) return;

    try {
        // AdvancedMarkerElement usa a propriedade 'position'
        if (userLocationMarker.position !== undefined) {
            userLocationMarker.position = newPos;
        } else if (userLocationMarker.setPosition) {
            // Fallback para Marker cl√°ssico
            userLocationMarker.setPosition(newPos);
        }

        // Atualiza precis√£o
        locationAccuracy = position.coords.accuracy;
        updateStatus(`Precis√£o: ${Math.round(locationAccuracy)}m`, true);
    } catch (error) {
        console.error('Erro ao atualizar posi√ß√£o do marcador:', error);
    }
}

function handleGeoError(error, isInitial = false) {
    console.warn("Erro de geolocaliza√ß√£o:", error);

    let errorTitle = 'Erro de GPS';
    let errorMessage = '';

    switch(error.code) {
        case error.PERMISSION_DENIED:
            errorTitle = 'Permiss√£o negada';
            errorMessage = 'Por favor, permita o acesso √† localiza√ß√£o';
            break;
        case error.POSITION_UNAVAILABLE:
            errorTitle = 'Localiza√ß√£o indispon√≠vel';
            errorMessage = 'N√£o foi poss√≠vel obter sua posi√ß√£o';
            break;
        case error.TIMEOUT:
            errorTitle = 'Tempo esgotado';
            errorMessage = 'A solicita√ß√£o demorou muito. Tentando novamente...';
            break;
        default:
            errorMessage = 'Erro desconhecido ao obter localiza√ß√£o';
    }

    showToast(errorTitle, errorMessage, 'error', 6000);
    updateStatus('GPS com erro', false);

    if (isInitial) {
        map.setCenter({ lat: -23.5505, lng: -46.6333 });
    }
}

// ===========================
// MARCADORES DE ENTREGAS
// ===========================

// ===========================
// RENDERIZA√á√ÉO OTIMIZADA DE MARCADORES
// Apenas marcadores vis√≠veis + baseados em zoom
// ===========================

let allDeliveryPoints = []; // Cache de todos os pontos
let visibleMarkers = []; // Marcadores atualmente renderizados
let updateMarkersTimeout = null;
let lastBounds = null; // Cache do √∫ltimo bounds calculado
let lastZoom = null; // Cache do √∫ltimo zoom
let qrScannerLoaded = false; // Flag para lazy loading do QR scanner

function addDeliveryMarkers() {
    console.log('üéØ Inicializando sistema de marcadores otimizado (viewport-based)');

    // Preparar todos os pontos de entrega (apenas uma vez)
    allDeliveryPoints = Object.entries(addressDatabase).map(([qrCode, data]) => ({
        qrCode,
        position: { lat: data.latitude, lng: data.longitude },
        address: data.address
    }));

    console.log(`üìç ${allDeliveryPoints.length} pontos de entrega preparados`);

    // Criar marcadores apenas quando necess√°rio (zoom perto)
    // Listener para atualizar marcadores quando mover/zoom o mapa
    google.maps.event.addListener(map, 'idle', updateVisibleMarkers);

    // Renderizar marcadores iniciais
    updateVisibleMarkers();
}

// Atualizar marcadores baseado no viewport e zoom atual
function updateVisibleMarkers() {
    // Debounce para evitar atualiza√ß√µes muito frequentes
    if (updateMarkersTimeout) {
        clearTimeout(updateMarkersTimeout);
    }

    updateMarkersTimeout = setTimeout(() => {
        const zoom = map.getZoom();
        const bounds = map.getBounds();

        if (!bounds) return;

        // Cache: verificar se bounds ou zoom mudaram significativamente
        const zoomChanged = lastZoom === null || Math.abs(zoom - lastZoom) > 0.5;
        const boundsChanged = lastBounds === null || !lastBounds.equals(bounds);

        if (!zoomChanged && !boundsChanged) {
            return; // Sem mudan√ßas significativas, n√£o atualizar
        }

        lastZoom = zoom;
        lastBounds = bounds;

        // REGRA: S√≥ mostrar marcadores quando zoom >= 15 (bem pr√≥ximo)
        // De longe (zoom < 15): apenas rota
        // De perto (zoom >= 15): rota + marcadores na viewport
        if (zoom < 15) {
            // Zoom distante: remover todos os marcadores
            clearVisibleMarkers();
            console.log('üî≠ Zoom distante: marcadores ocultados');
            return;
        }

        // Usar requestIdleCallback para processar quando navegador estiver ocioso
        if ('requestIdleCallback' in window) {
            requestIdleCallback(() => {
                renderMarkersInViewport(bounds);
            }, { timeout: 500 });
        } else {
            // Fallback para navegadores sem suporte
            renderMarkersInViewport(bounds);
        }
    }, 300); // Aguardar 300ms ap√≥s parar de mover (reduz atualiza√ß√µes)
}

// Fun√ß√£o separada para renderizar marcadores (pode ser chamada via requestIdleCallback)
function renderMarkersInViewport(bounds) {
    // Zoom perto: mostrar marcadores na viewport
    const pointsInView = allDeliveryPoints.filter(point =>
        bounds.contains(point.position)
    );

    // Limitar quantidade para performance (m√°ximo 20 marcadores simult√¢neos)
    const pointsToShow = pointsInView.slice(0, 20);

    // Verificar quais j√° existem e quais precisam ser criados/removidos
    updateMarkerSet(pointsToShow);

    console.log(`üìç Marcadores vis√≠veis: ${visibleMarkers.length}/${allDeliveryPoints.length} (zoom: ${lastZoom.toFixed(1)})`);
}

// Atualizar conjunto de marcadores (adicionar novos, remover antigos)
function updateMarkerSet(newPoints) {
    const newPointsMap = new Map(newPoints.map(p => [p.qrCode, p]));
    const currentPointsMap = new Map(visibleMarkers.map(m => [m.qrCode, m]));

    // Remover marcadores que n√£o est√£o mais vis√≠veis
    visibleMarkers = visibleMarkers.filter(marker => {
        if (!newPointsMap.has(marker.qrCode)) {
            // Remover do mapa
            marker.marker.map = null;
            return false;
        }
        return true;
    });

    // Adicionar novos marcadores que ainda n√£o existem
    newPoints.forEach(point => {
        if (!currentPointsMap.has(point.qrCode)) {
            createLightweightMarker(point);
        }
    });
}

// Criar marcador ultra-leve (c√≠rculo SVG simples)
function createLightweightMarker(point) {
    // Usar requestAnimationFrame para renderiza√ß√£o suave
    requestAnimationFrame(() => {
        // Criar c√≠rculo SVG leve (muito mais r√°pido que AdvancedMarkerElement com HTML)
        const circle = new google.maps.Circle({
            map: map,
            center: point.position,
            radius: 12, // 12 metros de raio (menor = mais leve)
            fillColor: '#ea4335',
            fillOpacity: 0.85,
            strokeColor: '#ffffff',
            strokeWeight: 2,
            strokeOpacity: 1,
            clickable: true,
            zIndex: 100,
            // Otimiza√ß√µes adicionais
            optimized: true, // Renderiza√ß√£o otimizada do Google Maps
            visible: true
        });

        // InfoWindow para mostrar endere√ßo ao clicar (lazy loading)
        let infoWindow = null;

        // Mostrar info ao clicar (criar InfoWindow apenas quando necess√°rio)
        circle.addListener('click', () => {
            if (!infoWindow) {
                infoWindow = new google.maps.InfoWindow({
                    content: `
                        <div style="padding: 8px; max-width: 250px;">
                            <div style="font-weight: 600; margin-bottom: 4px;">üì¶ Ponto de Entrega</div>
                            <div style="font-size: 13px; color: #666;">${point.address}</div>
                        </div>
                    `
                });
            }
            infoWindow.setPosition(point.position);
            infoWindow.open(map);
        });

        // Armazenar refer√™ncia
        visibleMarkers.push({
            qrCode: point.qrCode,
            marker: circle,
            infoWindow: infoWindow
        });
    });
}

// Limpar todos os marcadores vis√≠veis
function clearVisibleMarkers() {
    visibleMarkers.forEach(marker => {
        marker.marker.map = null;
        marker.infoWindow.close();
    });
    visibleMarkers = [];
}

// ===========================
// ANIMA√á√ÉO 2D ‚áÑ 3D
// ===========================

function animateValue(start, end, duration, onUpdate, onFinish) {
    const startTime = performance.now();

    function frame(time) {
        const progress = Math.min((time - startTime) / duration, 1);
        const value = start + (end - start) * progress;

        onUpdate(value);

        if (progress < 1) {
            requestAnimationFrame(frame);
        } else {
            if (onFinish) onFinish();
        }
    }

    requestAnimationFrame(frame);
}

document.getElementById("btnToggle3D").onclick = () => {
    const btn = document.getElementById("btnToggle3D");

    if (_animating3D) return;
    _animating3D = true;

    btn.classList.add('loading');
    btn.disabled = true;

    if (!is3D) {
        is3D = true;

        animateValue(map.getTilt(), 67, 600, val => map.setTilt(val));
        animateValue(map.getHeading(), 45, 600, val => map.setHeading(val), () => {
            _animating3D = false;
            btn.classList.remove('loading');
            btn.classList.add('active');
            btn.textContent = "2D";
            btn.disabled = false;
            showToast('Modo 3D ativado', 'Arraste para rotacionar', 'success', 2000);
        });

    } else {
        is3D = false;

        animateValue(map.getTilt(), 0, 600, val => map.setTilt(val));
        animateValue(map.getHeading(), 0, 600, val => map.setHeading(val), () => {
            _animating3D = false;
            btn.classList.remove('loading', 'active');
            btn.textContent = "3D";
            btn.disabled = false;
            showToast('Modo 2D ativado', '', 'success', 2000);
        });
    }
};

// ===========================
// CENTRALIZAR LOCALIZA√á√ÉO
// ===========================

document.getElementById("btnCenterLocation").onclick = () => {
    const btn = document.getElementById("btnCenterLocation");

    if (!userLocationMarker) {
        showToast('Localiza√ß√£o n√£o dispon√≠vel', 'Aguarde obter sua posi√ß√£o GPS', 'warning', 3000);
        return;
    }

    // Pega a posi√ß√£o atual do marcador (compat√≠vel com ambos os tipos)
    let currentPosition;
    if (userLocationMarker.position) {
        currentPosition = userLocationMarker.position;
    } else if (userLocationMarker.getPosition) {
        currentPosition = userLocationMarker.getPosition();
    }

    if (!currentPosition) {
        showToast('Erro ao centralizar', 'Posi√ß√£o n√£o encontrada', 'error', 3000);
        return;
    }

    // Feedback visual no bot√£o
    btn.classList.add('loading');
    btn.disabled = true;

    // Anima o zoom e centraliza
    map.panTo(currentPosition);

    // Se estiver muito distante, ajusta o zoom
    const currentZoom = map.getZoom();
    if (currentZoom < 16) {
        map.setZoom(17);
    }

    // Remove o loading ap√≥s a anima√ß√£o
    setTimeout(() => {
        btn.classList.remove('loading');
        btn.disabled = false;
        showToast(
            'Centralizado!',
            `Precis√£o: ${Math.round(locationAccuracy)}m`,
            'success',
            2000
        );
    }, 400);
};

// ===========================
// MODAL E QR CODE SCANNER
// ===========================

const modal = document.getElementById('modal-add-client');
const btnAddClient = document.getElementById('btn-add-client');
const btnModalClose = document.getElementById('modal-close');
const btnCancel = document.getElementById('btn-cancel');
const btnSave = document.getElementById('btn-save');
const form = document.getElementById('form-add-client');

const addressDisplay = document.getElementById('address-display');
const addressText = document.getElementById('address-text');

const inputName = document.getElementById('input-name');
const inputPhone = document.getElementById('input-phone');

let scannedAddress = '';

// Mostrar bot√£o ap√≥s carregar o mapa
function showAddClientButton() {
    setTimeout(() => {
        btnAddClient.classList.add('visible');
    }, 800);
}

// Abrir modal
async function openModal() {
    modal.classList.add('active');
    document.body.style.overflow = 'hidden';

    // Lazy loading: s√≥ iniciar c√¢mera quando modal abrir pela primeira vez
    if (!qrScannerLoaded) {
        console.log('üì∑ Lazy loading: inicializando QR scanner...');
        qrScannerLoaded = true;
    }

    // Abrir c√¢mera automaticamente (com pequeno delay para renderizar modal primeiro)
    setTimeout(async () => {
        try {
            await startCamera();
        } catch (error) {
            console.error('Erro ao abrir c√¢mera:', error);
            showToast(
                'Erro ao abrir c√¢mera',
                'Verifique as permiss√µes do navegador',
                'error',
                5000
            );
        }
    }, 100); // 100ms delay para modal renderizar primeiro
}

// Fechar modal
function closeModal() {
    modal.classList.remove('active');
    document.body.style.overflow = '';
    resetForm();
}

// Resetar formul√°rio
function resetForm() {
    form.reset();
    addressDisplay.classList.remove('active');
    addressText.textContent = '';
    scannedAddress = '';
    stopCamera(); // Parar c√¢mera ao fechar modal
}

// Event listeners do modal
btnAddClient.addEventListener('click', openModal);
btnModalClose.addEventListener('click', closeModal);
btnCancel.addEventListener('click', closeModal);

// Fechar modal ao clicar fora
modal.addEventListener('click', (e) => {
    if (e.target === modal) {
        closeModal();
    }
});

// ===========================
// M√ÅSCARA DE TELEFONE
// ===========================

inputPhone.addEventListener('input', (e) => {
    let value = e.target.value.replace(/\D/g, ''); // Remove tudo que n√£o √© n√∫mero

    // Limita a 11 d√≠gitos
    if (value.length > 11) {
        value = value.slice(0, 11);
    }

    // Aplica a m√°scara conforme o usu√°rio digita
    let formatted = '';

    if (value.length > 0) {
        formatted = '(' + value.substring(0, 2); // (DD
    }
    if (value.length >= 3) {
        formatted += ')' + value.substring(2, 3); // (DD)D
    }
    if (value.length >= 4) {
        formatted += ' ' + value.substring(3, 7); // (DD)D DDDD
    }
    if (value.length >= 8) {
        formatted += '-' + value.substring(7, 11); // (DD)D DDDD-DDDD
    }

    e.target.value = formatted;
});

// Permitir apenas n√∫meros e teclas de controle
inputPhone.addEventListener('keydown', (e) => {
    const allowedKeys = ['Backspace', 'Delete', 'Tab', 'ArrowLeft', 'ArrowRight', 'Home', 'End'];
    const isNumber = /^[0-9]$/.test(e.key);

    if (!isNumber && !allowedKeys.includes(e.key) && !e.ctrlKey && !e.metaKey) {
        e.preventDefault();
    }
});

// ===========================
// QR CODE SCANNER COM C√ÇMERA
// ===========================

const btnStopCamera = document.getElementById('btn-stop-camera');
const btnSwitchCamera = document.getElementById('btn-switch-camera');
const qrCameraContainer = document.getElementById('qr-camera-container');
const qrVideo = document.getElementById('qr-video');
const qrCanvas = document.getElementById('qr-canvas');
const qrStatus = document.getElementById('qr-status');

let videoStream = null;
let scanningInterval = null;
let currentFacingMode = 'environment'; // Come√ßa com c√¢mera traseira
let lastScannedCode = null;

// Fechar c√¢mera
btnStopCamera.addEventListener('click', () => {
    stopCamera();
});

// Trocar c√¢mera (frontal/traseira)
btnSwitchCamera.addEventListener('click', async () => {
    currentFacingMode = currentFacingMode === 'environment' ? 'user' : 'environment';
    stopCamera();
    await startCamera();
});

// Iniciar c√¢mera
async function startCamera() {
    const constraints = {
        video: {
            facingMode: currentFacingMode,
            width: { ideal: 1280 },
            height: { ideal: 720 }
        }
    };

    try {
        videoStream = await navigator.mediaDevices.getUserMedia(constraints);
        qrVideo.srcObject = videoStream;

        qrCameraContainer.classList.add('active');

        // Aguardar v√≠deo carregar
        qrVideo.onloadedmetadata = () => {
            qrVideo.play();
            startScanning();
        };

    } catch (error) {
        throw error;
    }
}

// Parar c√¢mera
function stopCamera() {
    if (videoStream) {
        videoStream.getTracks().forEach(track => track.stop());
        videoStream = null;
    }

    if (scanningInterval) {
        clearInterval(scanningInterval);
        scanningInterval = null;
    }

    qrVideo.srcObject = null;
    qrCameraContainer.classList.remove('active');
    qrStatus.textContent = 'Procurando QR Code...';
    qrStatus.classList.remove('success');
    lastScannedCode = null;
}

// Iniciar loop de scanning
function startScanning() {
    const canvasContext = qrCanvas.getContext('2d', { willReadFrequently: true });

    scanningInterval = setInterval(() => {
        if (qrVideo.readyState === qrVideo.HAVE_ENOUGH_DATA) {
            // Ajustar canvas para o tamanho do v√≠deo
            qrCanvas.width = qrVideo.videoWidth;
            qrCanvas.height = qrVideo.videoHeight;

            // Desenhar frame atual do v√≠deo no canvas
            canvasContext.drawImage(qrVideo, 0, 0, qrCanvas.width, qrCanvas.height);

            // Obter dados da imagem
            const imageData = canvasContext.getImageData(0, 0, qrCanvas.width, qrCanvas.height);

            // Tentar decodificar QR code
            const code = jsQR(imageData.data, imageData.width, imageData.height, {
                inversionAttempts: "dontInvert",
            });

            if (code && code.data !== lastScannedCode) {
                lastScannedCode = code.data;
                console.log('QR Code detectado:', code.data);

                // Feedback visual
                qrStatus.textContent = '‚úì QR Code detectado!';
                qrStatus.classList.add('success');

                // Som de beep (opcional)
                playBeep();

                // Processar resultado
                handleQRCodeResult(code.data);

                // Parar scanning ap√≥s detectar
                setTimeout(() => {
                    stopCamera();
                }, 1000);
            }
        }
    }, 100); // Scan a cada 100ms (10 fps)
}

// Som de beep ao detectar QR code
function playBeep() {
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();

    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);

    oscillator.frequency.value = 800;
    oscillator.type = 'sine';

    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);

    oscillator.start(audioContext.currentTime);
    oscillator.stop(audioContext.currentTime + 0.2);
}

// Processar resultado do QR Code
function handleQRCodeResult(qrData) {
    console.log('Processando QR Code:', qrData);

    // Buscar endere√ßo no banco de dados (simulado por enquanto)
    const address = lookupAddress(qrData);

    if (address) {
        // Endere√ßo encontrado - mostrar no badge
        scannedAddress = address;
        addressText.textContent = address;
        addressDisplay.classList.add('active');

        showToast(
            '‚úì Endere√ßo encontrado!',
            'Preencha o nome do cliente',
            'success',
            3000
        );
    } else {
        // Endere√ßo n√£o encontrado - mostrar c√≥digo
        scannedAddress = `C√≥digo QR: ${qrData} (Endere√ßo n√£o cadastrado)`;
        addressText.textContent = scannedAddress;
        addressDisplay.classList.add('active');

        showToast(
            '‚ö†Ô∏è Endere√ßo n√£o cadastrado',
            'Preencha manualmente os dados do cliente',
            'warning',
            4000
        );
    }

    // Focar automaticamente no campo de nome
    setTimeout(() => {
        inputName.focus();
    }, 500);
}

// Buscar endere√ßo no banco de dados
function lookupAddress(qrCode) {
    // Buscar endere√ßo pelo c√≥digo QR
    if (addressDatabase[qrCode]) {
        return addressDatabase[qrCode].address;
    }
    return null;
}

// ===========================
// SALVAR CLIENTE
// ===========================

form.addEventListener('submit', async (e) => {
    e.preventDefault();

    const clientData = {
        name: inputName.value.trim(),
        phone: inputPhone.value.trim(),
        address: scannedAddress,
        created_at: new Date().toISOString()
    };

    // Valida√ß√£o
    if (!clientData.name) {
        showToast(
            'Campo obrigat√≥rio',
            'Preencha o nome do cliente',
            'error',
            4000
        );
        return;
    }

    if (!clientData.address) {
        showToast(
            'Escaneie o QR Code',
            '√â necess√°rio escanear o QR Code do pacote primeiro',
            'error',
            4000
        );
        return;
    }

    // Loading
    btnSave.classList.add('loading');
    btnSave.disabled = true;

    try {
        // Salvar no Supabase
        const { data, error } = await supabase
            .from('clients')
            .insert([clientData])
            .select();

        if (error) throw error;

        console.log('Cliente salvo:', data);

        showToast(
            'Cliente adicionado!',
            `${clientData.name} foi cadastrado com sucesso`,
            'success',
            4000
        );

        // Atualizar lista de clientes no sidebar
        await loadClients();

        closeModal();

    } catch (error) {
        console.error('Erro ao salvar cliente:', error);
        showToast(
            'Erro ao salvar',
            error.message || 'N√£o foi poss√≠vel salvar o cliente',
            'error',
            5000
        );
    } finally {
        btnSave.classList.remove('loading');
        btnSave.disabled = false;
    }
});

// ===========================
// SIDEBAR - MENU LATERAL
// ===========================

const sidebar = document.getElementById('sidebar');
const sidebarOverlay = document.getElementById('sidebar-overlay');
const btnOpenSidebar = document.getElementById('btnOpenSidebar');
const btnCloseSidebar = document.getElementById('sidebar-close');
const clientsList = document.getElementById('clients-list');
const searchInput = document.getElementById('search-input');
const clientCount = document.getElementById('client-count');

let allClients = [];
let filteredClients = [];

// Abrir sidebar
btnOpenSidebar.addEventListener('click', () => {
    openSidebar();
    loadClients();
});

// Fechar sidebar
btnCloseSidebar.addEventListener('click', closeSidebar);
sidebarOverlay.addEventListener('click', closeSidebar);

function openSidebar() {
    sidebar.classList.add('open');
    sidebarOverlay.classList.add('active');
}

function closeSidebar() {
    sidebar.classList.remove('open');
    sidebarOverlay.classList.remove('active');
}

// Busca em tempo real
searchInput.addEventListener('input', (e) => {
    const searchTerm = e.target.value.toLowerCase().trim();

    if (searchTerm === '') {
        filteredClients = allClients;
    } else {
        filteredClients = allClients.filter(client => {
            const name = (client.name || '').toLowerCase();
            const address = (client.address || '').toLowerCase();
            const phone = (client.phone || '').toLowerCase();

            return name.includes(searchTerm) ||
                   address.includes(searchTerm) ||
                   phone.includes(searchTerm);
        });
    }

    renderClients(filteredClients);
});

// Carregar clientes do Supabase
async function loadClients() {
    try {
        const { data, error } = await supabase
            .from('clients')
            .select('*')
            .order('created_at', { ascending: false });

        if (error) {
            console.error('Erro do Supabase:', error);
            throw error;
        }

        allClients = data || [];
        filteredClients = allClients;

        renderClients(filteredClients);
        updateClientCount(allClients.length);

        console.log(`${allClients.length} cliente(s) carregado(s)`);

    } catch (error) {
        console.error('Erro ao carregar clientes:', error);

        // Mostrar mensagem mais espec√≠fica
        let errorMsg = 'N√£o foi poss√≠vel carregar a lista de clientes';

        if (error.message && error.message.includes('Failed to fetch')) {
            errorMsg = 'Verifique se a tabela "clients" existe no Supabase';
        } else if (error.code) {
            errorMsg = `Erro Supabase: ${error.message}`;
        }

        showToast(
            'Erro ao carregar',
            errorMsg,
            'error',
            6000
        );

        // Mostrar empty state mesmo com erro
        renderClients([]);
    }
}

// Renderizar lista de clientes
function renderClients(clients) {
    if (!clients || clients.length === 0) {
        clientsList.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">üìã</div>
                <div class="empty-state-text">Nenhum cliente encontrado</div>
                <div class="empty-state-subtext">${searchInput.value ? 'Tente outra busca' : 'Adicione clientes para v√™-los aqui'}</div>
            </div>
        `;
        return;
    }

    const clientsHTML = clients.map(client => `
        <div class="client-card" data-client-id="${client.id}">
            <div class="client-name">
                <span>üë§</span>
                <span>${escapeHtml(client.name)}</span>
            </div>
            ${client.phone ? `
                <div class="client-info">
                    <span class="client-info-icon">üìû</span>
                    <span>${escapeHtml(client.phone)}</span>
                </div>
            ` : ''}
            <div class="client-info">
                <span class="client-info-icon">üìç</span>
                <span>${escapeHtml(client.address)}</span>
            </div>
        </div>
    `).join('');

    clientsList.innerHTML = clientsHTML;

    // Adicionar event listeners aos cards
    document.querySelectorAll('.client-card').forEach(card => {
        card.addEventListener('click', () => {
            const clientId = card.getAttribute('data-client-id');
            const client = clients.find(c => c.id === clientId);
            if (client) {
                showClientDetails(client);
            }
        });
    });
}

// Atualizar contador de clientes
function updateClientCount(count) {
    clientCount.textContent = count;
}

// Mostrar detalhes do cliente e centralizar no mapa
function showClientDetails(client) {
    // Fechar sidebar
    closeSidebar();

    // Tentar encontrar o endere√ßo no addressDatabase procurando pela string de endere√ßo
    let targetPosition = null;
    let qrCodeMatch = null;

    // Procurar nos dados da planilha pelo endere√ßo do cliente
    for (const [qrCode, data] of Object.entries(addressDatabase)) {
        if (client.address && client.address.includes(data.address.split('\n')[0])) {
            targetPosition = {
                lat: data.latitude,
                lng: data.longitude
            };
            qrCodeMatch = qrCode;
            break;
        }
    }

    if (targetPosition) {
        // Centralizar no endere√ßo encontrado
        map.setCenter(targetPosition);
        map.setZoom(18);

        // Destacar o marcador correspondente
        if (deliveryMarkers[qrCodeMatch]) {
            const markerElement = deliveryMarkers[qrCodeMatch].content;
            // Anima√ß√£o de destaque
            markerElement.style.transform = 'scale(1.5)';
            markerElement.style.background = '#fbbc04'; // Amarelo para destaque

            setTimeout(() => {
                markerElement.style.transform = 'scale(1)';
                markerElement.style.background = '#ea4335'; // Voltar ao vermelho
            }, 2000);
        }

        showToast(
            `üìç ${client.name}`,
            client.address,
            'success',
            4000
        );
    } else {
        // Se n√£o encontrar coordenadas, apenas mostrar informa√ß√µes
        showToast(
            client.name,
            `üìû ${client.phone || 'Sem telefone'}\nüìç ${client.address}`,
            'info',
            5000
        );
    }
}

// Fun√ß√£o helper para escape HTML
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Carregar clientes ao inicializar
setTimeout(() => {
    loadClients();
}, 2000);

// ===========================
// SISTEMA DE ROTAS DE ENTREGA
// ===========================

const btnToggleRoute = document.getElementById('btnToggleRoute');

btnToggleRoute.addEventListener('click', () => {
    if (!routeMode) {
        // Ativar modo de rota
        activateRouteMode();
    } else {
        // Desativar modo de rota
        deactivateRouteMode();
    }
});

function activateRouteMode() {
    routeMode = true;
    btnToggleRoute.classList.add('active');

    // Adicionar marcadores quando ativar modo de rota (se ainda n√£o existirem)
    if (Object.keys(deliveryMarkers).length === 0) {
        console.log('‚ö° Adicionando marcadores de entrega...');
        addDeliveryMarkers();
    }

    // Obter posi√ß√£o atual do usu√°rio
    let currentPosition;
    if (userLocationMarker) {
        if (userLocationMarker.position) {
            currentPosition = userLocationMarker.position;
        } else if (userLocationMarker.getPosition) {
            currentPosition = userLocationMarker.getPosition();
        }
    }

    if (!currentPosition) {
        showToast(
            'Localiza√ß√£o n√£o dispon√≠vel',
            'Aguarde obter sua posi√ß√£o GPS para calcular rotas',
            'warning',
            4000
        );
        deactivateRouteMode();
        return;
    }

    // Calcular rota otimizada para todos os pontos de entrega
    calculateOptimizedRoute(currentPosition);
}

function deactivateRouteMode() {
    routeMode = false;
    btnToggleRoute.classList.remove('active');

    // Limpar rota do mapa
    if (directionsRenderer) {
        directionsRenderer.setDirections({routes: []});
    }

    // Limpar polylines (rotas em segmentos)
    if (window.routePolylines) {
        window.routePolylines.forEach(polyline => {
            polyline.setMap(null);
        });
        window.routePolylines = [];
    }

    // Limpar marcadores vis√≠veis
    clearVisibleMarkers();
    console.log('üóëÔ∏è Limpando rota e marcadores');

    showToast(
        'Modo de rota desativado',
        'Mapa restaurado (marcadores removidos)',
        'info',
        2000
    );
}

async function calculateOptimizedRoute(origin) {
    showToast(
        'Calculando rota otimizada...',
        'Usando Fleet Routing API para todos os 73 endere√ßos',
        'info',
        4000
    );

    // Verificar se Project ID foi configurado
    if (GOOGLE_CLOUD_PROJECT_ID === "SEU_PROJECT_ID_AQUI") {
        showToast(
            '‚ö†Ô∏è Configura√ß√£o necess√°ria',
            'Configure o GOOGLE_CLOUD_PROJECT_ID no c√≥digo (linha 1799)',
            'error',
            8000
        );
        deactivateRouteMode();
        return;
    }

    // Obter todos os pontos de entrega
    let deliveryPoints = Object.values(addressDatabase).map(data => ({
        location: {lat: data.latitude, lng: data.longitude},
        address: data.address
    }));

    console.log(`Total de endere√ßos na planilha: ${deliveryPoints.length}`);

    // Remover pontos duplicados (mesmas coordenadas)
    const uniquePoints = [];
    const seenCoords = new Set();

    deliveryPoints.forEach(point => {
        const coordKey = `${point.location.lat.toFixed(6)},${point.location.lng.toFixed(6)}`;
        if (!seenCoords.has(coordKey)) {
            seenCoords.add(coordKey);
            uniquePoints.push(point);
        }
    });

    console.log(`Endere√ßos √∫nicos (sem duplicatas): ${uniquePoints.length}`);

    if (uniquePoints.length === 0) {
        showToast(
            'Nenhuma entrega encontrada',
            'N√£o h√° endere√ßos cadastrados para criar uma rota',
            'warning',
            4000
        );
        deactivateRouteMode();
        return;
    }

    // Usar Fleet Routing API para TODOS os pontos
    try {
        await calculateFleetRoute(origin, uniquePoints);
    } catch (error) {
        console.error('‚ùå ERRO ao calcular rota com Fleet API:', error);
        console.error('Mensagem do erro:', error.message);

        // Fallback para Directions API com limite de 23 pontos
        console.log('‚ö†Ô∏è USANDO FALLBACK: Directions API (limite de 23 pontos)...');

        showToast(
            '‚ö†Ô∏è Usando modo fallback',
            'Fleet API falhou. Calculando com 23 pontos mais pr√≥ximos.',
            'warning',
            6000
        );

        await calculateDirectionsRoute(origin, uniquePoints);
    }
}

// Nova fun√ß√£o: Fleet Routing API via Backend (suporta todos os pontos)
async function calculateFleetRoute(origin, deliveryPoints) {
    console.log(`üöÄ Chamando backend para otimizar ${deliveryPoints.length} pontos`);
    console.log(`Project ID: ${GOOGLE_CLOUD_PROJECT_ID}`);

    // Chamar API serverless do backend (Vercel Function)
    const backendUrl = '/api/optimize-route';

    const payload = {
        origin: origin,
        deliveryPoints: deliveryPoints,
        projectId: GOOGLE_CLOUD_PROJECT_ID
    };

    console.log('üì§ Enviando requisi√ß√£o para backend...');
    console.log('URL:', backendUrl);
    console.log(`Pontos: ${deliveryPoints.length}`);

    const response = await fetch(backendUrl, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(payload)
    });

    console.log(`üì• Resposta backend: Status ${response.status}`);

    if (!response.ok) {
        const errorData = await response.json();
        console.error('‚ùå ERRO do Backend:');
        console.error('Status:', response.status);
        console.error('Erro:', errorData);

        showToast(
            '‚ùå Erro no Backend',
            errorData.message || 'N√£o foi poss√≠vel calcular a rota',
            'error',
            10000
        );

        throw new Error(`Backend falhou: ${response.status} - ${errorData.message}`);
    }

    const data = await response.json();

    if (!data.success || !data.result) {
        console.error('‚ùå Resposta inv√°lida do backend:', data);
        throw new Error('Resposta inv√°lida do backend');
    }

    console.log('‚úÖ Fleet Routing result:', data.result);
    console.log(`Rotas retornadas: ${data.result.routes?.length || 0}`);

    // Renderizar rota otimizada no mapa (passar deliveryPoints originais para mapear shipmentIndex)
    renderFleetRoute(data.result, origin, deliveryPoints);
}

// Renderizar resultado da Fleet Routing API
async function renderFleetRoute(fleetResult, origin, deliveryPoints) {
    const route = fleetResult.routes[0];

    if (!route || !route.visits) {
        showToast(
            'Erro ao processar rota',
            'N√£o foi poss√≠vel obter rota otimizada',
            'error',
            5000
        );
        deactivateRouteMode();
        return;
    }

    // Criar lista de pontos otimizados (origem + visitas + volta √† origem)
    const allPoints = [origin];

    console.log(`üìç Processando ${route.visits.length} visitas na ordem otimizada...`);

    route.visits.forEach((visit, index) => {
        // A Fleet API retorna apenas o shipmentIndex, n√£o as coordenadas
        // Precisamos buscar as coordenadas nos deliveryPoints originais
        let shipmentIndex = visit.shipmentIndex;

        // Fallback: se shipmentIndex n√£o existe, extrair do shipmentLabel
        if (shipmentIndex === undefined && visit.shipmentLabel) {
            // shipmentLabel √© "Entrega N" -> extrair N e converter para √≠ndice (N-1)
            const match = visit.shipmentLabel.match(/Entrega (\d+)/);
            if (match) {
                shipmentIndex = parseInt(match[1]) - 1; // Label come√ßa em 1, √≠ndice em 0
                console.log(`üîÑ Usando label para obter √≠ndice: ${visit.shipmentLabel} -> √≠ndice ${shipmentIndex}`);
            }
        }

        if (shipmentIndex !== undefined && deliveryPoints[shipmentIndex]) {
            const point = deliveryPoints[shipmentIndex].location;
            allPoints.push({
                lat: point.lat,
                lng: point.lng
            });
            console.log(`‚úÖ Visita ${index + 1}: Entrega #${shipmentIndex + 1} - ${visit.shipmentLabel}`);
        } else {
            console.warn(`‚ö†Ô∏è Visita ${index} sem shipmentIndex v√°lido:`, visit);
        }
    });

    // Adicionar retorno √† origem
    allPoints.push(origin);

    console.log(`Rota otimizada com ${route.visits.length} pontos de entrega`);
    console.log(`Total de pontos na rota: ${allPoints.length} (incluindo origem e retorno)`);

    // Desenhar a rota DIRETAMENTE usando m√∫ltiplas requisi√ß√µes √† Directions API
    // Dividir em segmentos de at√© 25 pontos cada
    await drawRouteInSegments(allPoints, route.visits.length);
}

// Desenhar rota em m√∫ltiplos segmentos (para mais de 25 pontos)
async function drawRouteInSegments(allPoints, totalDeliveries) {
    console.log(`Desenhando rota com ${allPoints.length} pontos totais`);

    // Limpar rotas anteriores
    if (directionsRenderer) {
        directionsRenderer.setMap(null);
    }

    // Dividir pontos em segmentos de at√© 25 (origem + 23 waypoints + destino)
    const segments = [];
    const maxWaypoints = 23;

    for (let i = 0; i < allPoints.length - 1; i += maxWaypoints + 1) {
        const segmentStart = i;
        const segmentEnd = Math.min(i + maxWaypoints + 1, allPoints.length - 1);

        const origin = allPoints[segmentStart];
        const destination = allPoints[segmentEnd];
        const waypoints = [];

        for (let j = segmentStart + 1; j < segmentEnd; j++) {
            waypoints.push({
                location: allPoints[j],
                stopover: true
            });
        }

        segments.push({ origin, destination, waypoints });
    }

    console.log(`Rota dividida em ${segments.length} segmento(s)`);

    // Desenhar todos os segmentos
    const polylines = [];
    const bounds = new google.maps.LatLngBounds();
    let totalDistance = 0;
    let totalDuration = 0;

    for (let i = 0; i < segments.length; i++) {
        const segment = segments[i];

        try {
            console.log(`üöó Chamando Directions API para segmento ${i + 1}/${segments.length}:`, {
                origin: segment.origin,
                destination: segment.destination,
                waypoints: segment.waypoints.length
            });

            const result = await new Promise((resolve, reject) => {
                directionsService.route({
                    origin: segment.origin,
                    destination: segment.destination,
                    waypoints: segment.waypoints,
                    optimizeWaypoints: false, // J√Å otimizado pela Fleet API
                    travelMode: google.maps.TravelMode.DRIVING
                }, (result, status) => {
                    if (status === 'OK') {
                        console.log(`‚úÖ Directions API retornou para segmento ${i + 1}: ${status}`);
                        resolve(result);
                    } else {
                        console.error(`‚ùå Directions API FALHOU para segmento ${i + 1}: ${status}`);
                        reject(new Error(`Segment ${i + 1} failed: ${status}`));
                    }
                });
            });

            // Calcular dist√¢ncia e tempo
            result.routes[0].legs.forEach(leg => {
                totalDistance += leg.distance.value;
                totalDuration += leg.duration.value;
            });

            // Criar polyline para este segmento
            const path = result.routes[0].overview_path;

            // DEBUG: verificar se o path est√° correto
            console.log(`Segmento ${i + 1}: ${path.length} pontos no caminho`);

            const polyline = new google.maps.Polyline({
                path: path,
                strokeColor: '#4285f4',
                strokeWeight: 4, // Reduzido de 5 para 4 (mais leve)
                strokeOpacity: 0.75,
                map: map,
                geodesic: true, // Renderiza√ß√£o otimizada para longas dist√¢ncias
                clickable: false // Desabilitar cliques na linha (mais leve)
            });

            polylines.push(polyline);

            // Expandir bounds
            path.forEach(point => bounds.extend(point));

            console.log(`Segmento ${i + 1}/${segments.length} desenhado: ${segment.waypoints.length + 2} pontos`);

        } catch (error) {
            console.error(`‚ùå ERRO CR√çTICO no segmento ${i + 1}:`, error);
            console.error(`Detalhes do erro:`, error.message);

            // Mostrar toast de erro
            showToast(
                `Erro no segmento ${i + 1}`,
                error.message || 'Falha ao calcular rota',
                'error',
                5000
            );
        }

        // Pequeno delay entre requisi√ß√µes para evitar rate limit
        if (i < segments.length - 1) {
            await new Promise(resolve => setTimeout(resolve, 300));
        }
    }

    // Armazenar polylines para limpeza posterior
    window.routePolylines = polylines;

    // Ajustar zoom para mostrar toda a rota
    map.fitBounds(bounds);

    // Mostrar estat√≠sticas
    const distanceKm = (totalDistance / 1000).toFixed(1);
    const durationMin = Math.round(totalDuration / 60);

    showToast(
        '‚úì Rota otimizada completa!',
        `${totalDeliveries} entregas ‚Ä¢ ${distanceKm} km ‚Ä¢ ${durationMin} min`,
        'success',
        10000
    );

    console.log(`‚úì Rota completa: ${totalDeliveries} entregas, ${distanceKm}km, ${durationMin}min`);
}

// Fallback: Directions API (at√© 23 pontos)
async function calculateDirectionsRoute(origin, deliveryPoints) {
    console.log(`Usando Directions API (fallback) com limite de 23 pontos`);

    const nearestPoints = deliveryPoints
        .map(point => ({
            ...point,
            distance: google.maps.geometry.spherical.computeDistanceBetween(
                new google.maps.LatLng(origin.lat, origin.lng),
                new google.maps.LatLng(point.location.lat, point.location.lng)
            )
        }))
        .sort((a, b) => a.distance - b.distance)
        .slice(0, 23);

    const waypoints = nearestPoints.slice(0, -1).map(point => ({
        location: point.location,
        stopover: true
    }));

    const destination = nearestPoints[nearestPoints.length - 1].location;

    const request = {
        origin: origin,
        destination: destination,
        waypoints: waypoints,
        optimizeWaypoints: true,
        travelMode: google.maps.TravelMode.DRIVING
    };

    directionsService.route(request, (result, status) => {
        if (status === 'OK') {
            directionsRenderer.setDirections(result);

            let totalDistance = 0;
            let totalDuration = 0;

            result.routes[0].legs.forEach(leg => {
                totalDistance += leg.distance.value;
                totalDuration += leg.duration.value;
            });

            const distanceKm = (totalDistance / 1000).toFixed(1);
            const durationMin = Math.round(totalDuration / 60);
            const totalPoints = waypoints.length + 2;

            showToast(
                '‚úì Rota calculada (Directions API)!',
                `${totalPoints} pontos de entrega ‚Ä¢ ${distanceKm} km ‚Ä¢ ${durationMin} min`,
                'success',
                8000
            );

            const bounds = new google.maps.LatLngBounds();
            result.routes[0].overview_path.forEach(point => bounds.extend(point));
            map.fitBounds(bounds);
        } else {
            console.error('Erro ao calcular rota:', status);
            showToast('Erro ao calcular rota', 'Tente novamente', 'error', 5000);
            deactivateRouteMode();
        }
    });
}

// ===========================
// CLEANUP
// ===========================

window.addEventListener('beforeunload', () => {
    if (watchId) navigator.geolocation.clearWatch(watchId);
});

// Tratamento de erro de carregamento do mapa
window.addEventListener('error', (e) => {
    if (e.message.includes('Google Maps')) {
        hideLoadingScreen();
        showToast(
            'Erro ao carregar mapa',
            'Verifique sua conex√£o com a internet',
            'error',
            8000
        );
    }
}, true);
</script>

</body>
</html>
