<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Mapa de Clientes - Google Maps</title>

<style>
    body,html{
        margin:0;
        padding:0;
        height:100%;
        width:100%;
        font-family:sans-serif;
    }
    #map{
        height:100%;
        width:100%;
        position:absolute;
        top:0;left:0;
    }

    .map-control{
        position:fixed;
        top:90px;
        right:20px;
        display:flex;
        flex-direction:column;
        gap:10px;
        z-index:9999;
    }

    .control-btn{
        width:48px;
        height:48px;
        border-radius:50%;
        border:none;
        background:white;
        box-shadow:0 2px 6px rgba(0,0,0,0.3);
        font-size:18px;
        cursor:pointer;
    }

    .control-btn:active{
        transform:scale(.9);
    }

    .location-marker {
        width: 20px;
        height: 20px;
        background: #4285f4;
        border: 3px solid white;
        border-radius: 50%;
        box-shadow: 0 2px 6px rgba(0,0,0,0.4);
        position: relative;
    }

    .location-marker::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 8px;
        height: 8px;
        background: white;
        border-radius: 50%;
    }

    @keyframes pulse {
        0% { box-shadow: 0 0 0 0 rgba(66,133,244,0.7); }
        70% { box-shadow: 0 0 0 10px rgba(66,133,244,0); }
        100% { box-shadow: 0 0 0 0 rgba(66,133,244,0); }
    }

    .location-marker.active {
        animation: pulse 2s infinite;
    }

    @media (max-width: 768px) {
        .map-control {
            top: 70px;
            right: 10px;
        }

        .control-btn {
            width: 44px;
            height: 44px;
            font-size: 16px;
        }
    }
</style>
</head>
<body>

<div id="map"></div>

<div class="map-control">
    <button id="btnToggle3D" class="control-btn">3D</button>
    <button id="btnCenterUser" class="control-btn">üìç</button>
</div>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
const SUPABASE_URL = "https://fufteldeapyvluynppuv.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ1ZnRlbGRlYXB5dmx1eW5wcHV2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2MzAyMzIsImV4cCI6MjA4MDIwNjIzMn0.xr6PiskP8cJUzGBEhp_tAfZWMprxJXJyhLuOSmCQleA";

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
</script>

<!-- Google Maps -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyApaDb9rSw2sNTaY7fjBqmrgjWYD9xwjcU&callback=initMap&v=beta" async defer></script>

<script>
let map;
let is3D = false;
let userLocationMarker = null;
let watchId = null;
let _animating3D = false;
let kalman = null;

const MAP_ID = "ebb7ca4503045feabc75b373";

/* ====================================================
   FILTRO DE KALMAN (suaviza√ß√£o profissional de GPS)
   ==================================================== */

class KalmanFilter {
    constructor(R = 0.0008, Q = 0.00001) {
        this.R = R; // noise measurement
        this.Q = Q; // process noise
        this.A = 1; // no change
        this.B = 0;
        this.C = 1;

        this.cov = NaN;
        this.x = NaN;
    }

    filter(z) {
        if (isNaN(this.x)) {
            this.x = z;
            this.cov = 1;
        } else {
            // Prediction
            const predX = this.A * this.x;
            const predCov = this.A * this.cov * this.A + this.Q;

            // Kalman Gain
            const K = predCov * this.C / (this.C * predCov * this.C + this.R);

            // Correction
            this.x = predX + K * (z - this.C * predX);
            this.cov = predCov - K * this.C * predCov;
        }

        return this.x;
    }

    filter2D(lat, lng) {
        return {
            lat: this.filter(lat),
            lng: this.filter(lng)
        };
    }
}

/* ====================================================
   LERP + ANIMA√á√ÉO ULTRA SUAVE
   ==================================================== */

function lerp(a, b, t) {
    return a + (b - a) * t;
}

function animateMarkerTo(marker, newPos, duration = 450) {
    if (!marker.position) {
        marker.setPosition(newPos);
        return;
    }

    const startLat = marker.position.lat();
    const startLng = marker.position.lng();
    const endLat = newPos.lat();
    const endLng = newPos.lng();

    const startTime = performance.now();

    function step(now) {
        const t = Math.min((now - startTime) / duration, 1);

        const lat = lerp(startLat, endLat, t);
        const lng = lerp(startLng, endLng, t);

        const interpolated = new google.maps.LatLng(lat, lng);

        marker.setPosition(interpolated);

        if (t < 1) requestAnimationFrame(step);
    }

    requestAnimationFrame(step);
}

/* ====================================================
   INICIALIZA√á√ÉO DO MAPA
   ==================================================== */

window.initMap = () => {
    map = new google.maps.Map(document.getElementById("map"), {
        center:{lat:-23.5505,lng:-46.6333},
        zoom:17,
        mapId:MAP_ID,
        tilt:0,
        heading:0,
        gestureHandling:"greedy",
        rotateControl:true,
        zoomControl:true,
        streetViewControl:false,
        fullscreenControl:true
    });

    kalman = new KalmanFilter();

    startLocationTracking();
};

/* ====================================================
   RASTREAMENTO EM TEMPO REAL SUAVIZADO
   ==================================================== */

function startLocationTracking() {
    if (!navigator.geolocation) {
        alert("Seu navegador n√£o suporta geolocaliza√ß√£o.");
        return;
    }

    const markerDiv = document.createElement('div');
    markerDiv.className = 'location-marker active';

    const geoOptions = {
        enableHighAccuracy: true,
        timeout: 7000,
        maximumAge: 0
    };

    navigator.geolocation.getCurrentPosition(
        pos => {
            const c = { lat: pos.coords.latitude, lng: pos.coords.longitude };

            map.setCenter(c);

            userLocationMarker = new google.maps.marker.AdvancedMarkerElement({
                map,
                position: c,
                content: markerDiv
            });

            watchId = navigator.geolocation.watchPosition(updateUserLocation, handleGeoError, geoOptions);
        },
        handleGeoError,
        geoOptions
    );
}

function updateUserLocation(position) {
    const rawLat = position.coords.latitude;
    const rawLng = position.coords.longitude;

    // FILTRO KALMAN
    const filtered = kalman.filter2D(rawLat, rawLng);

    const newPos = new google.maps.LatLng(filtered.lat, filtered.lng);

    // ANIMA√á√ÉO SUAVE
    animateMarkerTo(userLocationMarker, newPos, 500);
}

function handleGeoError(error) {
    console.warn("Erro de GPS:", error);
    alert("Ative o GPS e recarregue o app.");
}

/* ====================================================
   CENTRALIZAR USU√ÅRIO
   ==================================================== */

function centerOnUser() {
    if (!userLocationMarker || !userLocationMarker.position) {
        alert("Aguardando localiza√ß√£o...");
        return;
    }

    map.panTo(userLocationMarker.position);
    map.setZoom(17);
}

document.getElementById("btnCenterUser").onclick = centerOnUser;

/* ====================================================
   MODO 3D
   ==================================================== */

function animateValue(start, end, duration, callback, finish) {
    const startTime = performance.now();

    function step(now) {
        const t = Math.min((now - startTime) / duration, 1);
        const value = lerp(start, end, t);
        callback(value);
        if (t < 1) requestAnimationFrame(step);
        else if (finish) finish();
    }
    requestAnimationFrame(step);
}

document.getElementById("btnToggle3D").onclick = () => {

    if (_animating3D) return;
    _animating3D = true;

    if (!is3D) {
        is3D = true;
        btnToggle3D.textContent = "2D";

        animateValue(map.getTilt(), 67, 600, val => map.setTilt(val));
        animateValue(map.getHeading(), 45, 600, val => map.setHeading(val), () => {
            _animating3D = false;
        });

    } else {
        is3D = false;
        btnToggle3D.textContent = "3D";

        animateValue(map.getTilt(), 0, 600, val => map.setTilt(val));
        animateValue(map.getHeading(), 0, 600, val => map.setHeading(val), () => {
            _animating3D = false;
        });
    }
};

</script>
</body>
</html>