<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8" >
    <meta name="viewport" content="width=device-width, initial-scale=1.0" >
    <title>Mapa de Clientes</title>

    <!-- Ãcone -->
    <link rel="icon" href="data:image/svg+xml,
        <svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'>
            <text y='.9em' font-size='90'>ğŸ“</text>
        </svg>">

    <!-- CSS principal -->
    <link rel="stylesheet" href="/styles/styles.css">

    <!-- SheetJS -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <!-- TweenJS -->
    <script src="https://cdn.jsdelivr.net/npm/@tweenjs/tween.js@23.1.3/dist/tween.umd.js"></script>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- jsQR -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsqr.min.js"></script>

    <!-- InicializaÃ§Ã£o ANTES do Google Maps -->
    <script type="module">
        import { initApp } from "/js/app.js";
        // Expor globalmente ANTES do Maps carregar
        window.initApp = initApp;
    </script>

    <!-- Google Maps (carrega por Ãºltimo) -->
    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyApaDb9rSw2sNTaY7fjBqmrgjWYD9xwjcU&callback=initApp&libraries=geometry,places,marker&v=beta">
    </script>
</head>

<body>

    <!-- TELA DE LOADING -->
    <div id="loading-screen" class="loading-screen">
        <div class="loading-content">
            <div class="spinner"></div>
            <div id="loading-text">Inicializando mapa...</div>
            <div id="loading-subtext">Aguarde um momento</div>
        </div>
    </div>

    <!-- MAPA -->
    <div id="map" class="map"></div>

    <!-- CONTROLES -->
    <div id="map-controls" class="map-controls hidden">
        <button id="btn3D" class="control-btn" title="Alternar 3D/2D">3D</button>
        <button id="btnCenter" class="control-btn" title="Centralizar">ğŸ“</button>
        <button id="btnRoute" class="control-btn" title="Planejar rota">ğŸš—</button>
        <button id="btnClear" class="control-btn hidden" title="Limpar rotas">ğŸ—‘ï¸</button>
        <button id="btnSidebar" class="control-btn" title="Lista de clientes">ğŸ‘¥</button>
        <button id="btnSpreadsheet" class="control-btn" title="Planilha do dia">ğŸ“Š</button>
        <button id="btnToggleClients" class="control-btn" title="Clientes no mapa">ğŸ‘¤</button>
        <button id="btnMatchedClients" class="control-btn" title="Clientes identificados">ğŸ“</button>
    </div>

    <!-- TOAST -->
    <div id="toast-container" class="toast-container"></div>

    <!-- STATUS BAR -->
    <div id="status-bar" class="status-bar hidden">
        <div id="status-indicator" class="status-indicator"></div>
        <span id="status-text">Rastreando localizaÃ§Ã£o...</span>
    </div>

    <!-- BOTÃƒO ADICIONAR CLIENTE -->
    <button id="btnAddClient" class="btn-add-client hidden">
        â• Adicionar Cliente
    </button>

    <!-- SIDEBAR -->
    <div id="sidebar-overlay" class="sidebar-overlay"></div>

    <div id="sidebar" class="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-title">
                ğŸ‘¥ Clientes <span id="client-count" class="client-count">0</span>
            </div>
            <button id="sidebar-close" class="sidebar-close">âœ•</button>
        </div>

        <div class="sidebar-search">
            <input id="search-input" class="search-input" placeholder="Buscar cliente..." >
            <button id="btnScanPackage" class="btn-scan-package">ğŸ“¦</button>
        </div>

        <div id="clients-list" class="clients-list">
            <div class="empty-state">
                <div class="empty-icon">ğŸ“‹</div>
                <div>Nenhum cliente cadastrado</div>
            </div>
        </div>
    </div>

    <!-- MODAL CLIENTE -->
    <div id="modal-client" class="modal">
        <div class="modal-content">
            <button id="modal-client-close" class="modal-close">âœ•</button>

            <h2 class="modal-title">Adicionar Cliente</h2>

            <div class="qr-area">
                <video id="qr-video" autoplay playsinline></video>
                <canvas id="qr-canvas"></canvas>
                <div id="qr-status" class="qr-status">Procurando QR Code...</div>
            </div>

            <div id="address-display" class="address-display hidden">
                <b>ğŸ“ EndereÃ§o:</b>
                <div id="address-text"></div>
            </div>

            <form id="client-form" class="modal-form">
                <label>Nome *</label>
                <input id="client-name" required >

                <label>Telefone</label>
                <input id="client-phone" maxlength="16" >

                <button id="btnClientSave" class="btn-primary" type="submit">
                    Salvar
                </button>
            </form>
        </div>
    </div>

    <!-- MODAL PACOTE -->
    <div id="modal-package" class="modal">
        <div class="modal-content">
            <button id="modal-package-close" class="modal-close">âœ•</button>

            <h2 class="modal-title">Escanear Pacote</h2>

            <video id="qr-package-video" autoplay playsinline></video>
            <canvas id="qr-package-canvas"></canvas>
            <div id="qr-package-status" class="qr-status">Procurando cÃ³digo...</div>

            <div id="scan-result" class="scan-result hidden"></div>

            <button id="btnPackageClose" class="btn-secondary">
                Fechar
            </button>
        </div>
    </div>

    <!-- MODAL UPLOAD PLANILHA -->
    <div id="modal-spreadsheet" class="modal">
        <div class="modal-content">
            <button id="modal-spreadsheet-close" class="modal-close">âœ•</button>

            <h2 class="modal-title">Atualizar Planilha</h2>

            <div class="upload-warning">
                âš ï¸ Ao enviar uma nova planilha, os dados anteriores serÃ£o apagados.
            </div>

            <div id="upload-area" class="upload-area">
                <div class="upload-icon">ğŸ“Š</div>
                <p>Arraste sua planilha aqui</p>
                <p class="upload-sub">Ou clique para selecionar</p>
                <input id="file-input" type="file" accept=".xlsx,.xls,.csv" hidden >
            </div>

            <div id="upload-progress" class="upload-progress hidden">
                <div class="progress-bar"><div id="progress-fill"></div></div>
                <p id="progress-text">Processando planilha...</p>
            </div>

            <div id="upload-result" class="upload-result hidden"></div>
        </div>
    </div>

</body>

</html>
