<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>Mapa de Clientes - Google Maps</title>

<style>
    body,html{
        margin:0;
        padding:0;
        height:100%;
        width:100%;
        font-family:sans-serif;
        overflow:hidden;
    }

    #map{
        height:100%;
        width:100%;
        position:absolute;
        top:0;left:0;
    }

    /* BOT√ïES */
    .map-control{
        position:fixed;
        top:90px;
        right:20px;
        display:flex;
        flex-direction:column;
        gap:10px;
        z-index:9999;
    }

    .control-btn{
        width:48px;
        height:48px;
        border-radius:50%;
        border:none;
        background:white;
        box-shadow:0 2px 6px rgba(0,0,0,0.3);
        font-size:18px;
        cursor:pointer;
    }

    .control-btn:active{
        transform:scale(.9);
    }

    /* MARCADOR HTML (PONTO + SETA) */
    .marker-wrapper{
        width:40px;
        height:40px;
        position:relative;
        transform: translate(-50%, -50%);
    }

    .location-dot{
        width:22px;
        height:22px;
        background:#1a73e8;
        border-radius:50%;
        border:4px solid white;
        position:absolute;
        top:10px;
        left:9px;
        box-shadow:0 2px 6px rgba(0,0,0,.5);
    }

    .direction-arrow{
        width:0;
        height:0;
        border-left:6px solid transparent;
        border-right:6px solid transparent;
        border-bottom:14px solid white;
        position:absolute;
        top:-2px;
        left:50%;
        transform:translateX(-50%) rotate(0deg);
        filter:drop-shadow(0 0 4px rgba(0,0,0,.4));
    }

</style>
</head>
<body>

<div id="map"></div>

<!-- BOT√ïES -->
<div class="map-control">
    <button id="btnToggle3D" class="control-btn">3D</button>
    <button id="btnCenterUser" class="control-btn">üìç</button>
</div>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
const SUPABASE_URL = "https://fufteldeapyvluynppuv.supabase.co";
const SUPABASE_ANON_KEY =
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ1ZnRlbGRlYXB5dmx1eW5wcHV2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2MzAyMzIsImV4cCI6MjA4MDIwNjIzMn0.xr6PiskP8cJUzGBEhp_tAfZWMprxJXJyhLuOSmCQleA";

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
</script>

<!-- Google Maps -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyApaDb9rSw2sNTaY7fjBqmrgjWYD9xwjcU&callback=initMap&v=beta"
        async defer></script>

<script>
let map;
let userMarker = null;
let watchId = null;
let currentHeading = 0;
let useGyro = false;
let is3D = false;
let animating3D = false;

const MAP_ID = "ebb7ca4503045feabc75b373";

/* =====================================================
   PERMISS√ÉO DO GIROSC√ìPIO
===================================================== */
function enableGyroscope() {
    if (window.DeviceOrientationEvent &&
        typeof DeviceOrientationEvent.requestPermission === "function") {

        DeviceOrientationEvent.requestPermission().then(res => {
            if (res === "granted") {
                useGyro = true;
                window.addEventListener("deviceorientation", onGyro, true);
            }
        });

    } else {
        // Desktop ou Android sem permiss√£o especial
        useGyro = true;
        window.addEventListener("deviceorientation", onGyro, true);
    }
}

function onGyro(ev) {
    if (!useGyro) return;

    if (ev.alpha != null) {
        currentHeading = ev.alpha;
        rotateMarker(currentHeading);
        map.setHeading(currentHeading);
    }
}

/* =====================================================
   ROTACIONA O MARCADOR
===================================================== */
function rotateMarker(deg) {
    if (!userMarker) return;

    const el = userMarker.getIcon().element;
    if (!el) return;

    const arrow = el.querySelector(".direction-arrow");
    if (arrow) {
        arrow.style.transform = `translateX(-50%) rotate(${deg}deg)`;
    }
}

/* =====================================================
   CRIA MARCADOR HTML
===================================================== */
function createHtmlMarker() {
    const wrap = document.createElement("div");
    wrap.className = "marker-wrapper";

    const dot = document.createElement("div");
    dot.className = "location-dot";

    const arrow = document.createElement("div");
    arrow.className = "direction-arrow";

    wrap.appendChild(dot);
    wrap.appendChild(arrow);

    return wrap;
}

/* =====================================================
   INTERPOLA√á√ÉO SUAVE
===================================================== */
function lerp(a,b,t){ return a+(b-a)*t; }

function animateMarkerTo(marker,newPos,duration=500){
    const start = marker.getPosition();
    const sLat = start.lat();
    const sLng = start.lng();
    const eLat = newPos.lat();
    const eLng = newPos.lng();

    const t0 = performance.now();

    function step(t){
        const p = Math.min((t - t0) / duration, 1);
        const lat = lerp(sLat, eLat, p);
        const lng = lerp(sLng, eLng, p);

        marker.setPosition({lat,lng});

        if (p < 1) requestAnimationFrame(step);
    }

    requestAnimationFrame(step);
}

/* =====================================================
   GPS
===================================================== */
function startLocation(){
    if (!navigator.geolocation) {
        console.log("Geolocaliza√ß√£o n√£o suportada.");
        return;
    }

    const options = {
        enableHighAccuracy:true,
        timeout:10000,
        maximumAge:0
    };

    navigator.geolocation.getCurrentPosition(pos=>{
        const {latitude,longitude} = pos.coords;
        const c = {lat:latitude,lng:longitude};

        map.setCenter(c);
        map.setZoom(18);

        userMarker = new google.maps.Marker({
            map,
            position:c,
            icon:{
                element:createHtmlMarker()
            }
        });

        // NODE: Suporte a HTML marker
        const iconObj = {
            element: createHtmlMarker()
        };
        userMarker.setIcon(iconObj);

        watchId = navigator.geolocation.watchPosition(updateUserPosition,err=>{
            console.log("Erro watch:",err);
        },options);

    },err=>{
        console.log("Erro inicial:",err);
    },options);
}

function updateUserPosition(pos){
    const c = new google.maps.LatLng(pos.coords.latitude,pos.coords.longitude);
    animateMarkerTo(userMarker,c,400);
    map.panTo(c);

    if (!useGyro && pos.coords.heading != null){
        currentHeading = pos.coords.heading;
        rotateMarker(currentHeading);
        map.setHeading(currentHeading);
    }
}

/* =====================================================
   BOT√ÉO CENTRALIZAR
===================================================== */
function centerOnUser(){
    if (!userMarker) return;
    const p = userMarker.getPosition();
    map.panTo(p);
    map.setZoom(18);
}

document.getElementById("btnCenterUser").onclick = centerOnUser;

/* =====================================================
   ANIMA√á√ÉO 2D / 3D
===================================================== */
function animateValue(start,end,duration,onUpdate,onFinish){
    const t0 = performance.now();

    function frame(t){
        const p = Math.min((t-t0)/duration,1);
        const v = start + (end-start)*p;
        onUpdate(v);
        if (p < 1) requestAnimationFrame(frame);
        else if (onFinish) onFinish();
    }

    requestAnimationFrame(frame);
}

document.getElementById("btnToggle3D").onclick = () => {
    if (animating3D) return;
    animating3D = true;

    if (!is3D){
        is3D = true;
        btnToggle3D.textContent = "2D";

        animateValue(map.getTilt(),67,600,val=>map.setTilt(val));
        animateValue(map.getHeading(),45,600,val=>map.setHeading(val),
            ()=>{ animating3D=false; });

    } else {
        is3D = false;
        btnToggle3D.textContent = "3D";

        animateValue(map.getTilt(),0,600,val=>map.setTilt(val));
        animateValue(map.getHeading(),0,600,val=>map.setHeading(val),
            ()=>{ animating3D=false; });
    }
};

/* =====================================================
   INICIAR MAPA
===================================================== */
function initMap(){
    map = new google.maps.Map(document.getElementById("map"),{
        center:{lat:-23.55,lng:-46.63},
        zoom:18,
        mapId:MAP_ID,
        tilt:0,
        heading:0,
        gestureHandling:"greedy",
        streetViewControl:false
    });

    enableGyroscope();
    startLocation();
}

</script>

</body>
</html>